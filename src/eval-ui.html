<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pulse Eval Dashboard</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;
    background: #0a0a0a; color: #e0e0e0; font-size: 14px; line-height: 1.4;
  }

  /* Summary bar */
  .summary {
    display: flex; gap: 16px; align-items: center; flex-wrap: wrap;
    padding: 16px 20px; background: #1a1a1a; border-bottom: 1px solid #333;
  }
  .stat { display: flex; flex-direction: column; gap: 2px; }
  .stat-label { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-value { font-size: 18px; font-weight: 600; }
  .source-pill {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;
  }
  .source-skint { background: #2d1f4e; color: #b794f6; }
  .source-ra { background: #1f2d4e; color: #90cdf4; }
  .source-dice { background: #4e1f3d; color: #f687b3; }
  .source-eventbrite { background: #1f3d2d; color: #68d391; }
  .source-songkick { background: #3d2d1f; color: #f6ad55; }
  .health-ok { color: #68d391; }
  .health-warn { color: #f6ad55; }
  .health-bad { color: #fc8181; }

  /* Actions bar */
  .actions {
    display: flex; gap: 10px; align-items: center; padding: 12px 20px;
    background: #141414; border-bottom: 1px solid #282828;
  }
  button {
    padding: 8px 16px; border: 1px solid #444; border-radius: 6px;
    background: #222; color: #e0e0e0; cursor: pointer; font-size: 13px;
    transition: background 0.15s;
  }
  button:hover { background: #333; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  button.primary { background: #2563eb; border-color: #3b82f6; color: #fff; }
  button.primary:hover { background: #1d4ed8; }
  .status-msg { font-size: 12px; color: #888; margin-left: 8px; }

  /* Filters */
  .filters {
    display: flex; gap: 16px; align-items: center; flex-wrap: wrap;
    padding: 10px 20px; background: #111; border-bottom: 1px solid #282828;
  }
  .filter-group { display: flex; align-items: center; gap: 6px; }
  .filter-group label { font-size: 12px; color: #aaa; cursor: pointer; }
  .filter-group input[type="checkbox"] { accent-color: #3b82f6; }
  select {
    padding: 4px 8px; background: #222; border: 1px solid #444; border-radius: 4px;
    color: #e0e0e0; font-size: 12px;
  }
  .filter-group input[type="range"] { width: 80px; accent-color: #3b82f6; }
  .range-val { font-size: 12px; color: #aaa; min-width: 16px; }

  /* Table */
  .table-wrap { overflow-x: auto; padding: 0 20px 20px; }
  table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  th {
    text-align: left; padding: 8px 10px; font-size: 11px; font-weight: 600;
    color: #888; text-transform: uppercase; letter-spacing: 0.5px;
    border-bottom: 2px solid #333; cursor: pointer; user-select: none;
    white-space: nowrap;
  }
  th:hover { color: #bbb; }
  th .sort-arrow { font-size: 10px; margin-left: 4px; }
  td {
    padding: 8px 10px; border-bottom: 1px solid #1f1f1f;
    font-size: 13px; vertical-align: top; max-width: 250px;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  tr:hover { background: #1a1a2e; }
  tr.selected { background: #1a2a3e; }
  tr.flagged td { opacity: 0.85; }

  /* Badges */
  .badge {
    display: inline-block; padding: 2px 8px; border-radius: 10px;
    font-size: 11px; font-weight: 500;
  }
  .flag-badge {
    display: inline-block; padding: 1px 6px; border-radius: 8px;
    font-size: 10px; font-weight: 500; margin: 1px 2px;
    background: #3d2020; color: #fc8181;
  }
  .flag-badge.warn { background: #3d3420; color: #f6e05e; }
  .score-cell { font-weight: 700; font-size: 15px; }
  .score-high { color: #68d391; }
  .score-mid { color: #f6e05e; }
  .score-low { color: #fc8181; }
  .confidence-bar {
    display: inline-block; width: 40px; height: 6px; border-radius: 3px;
    background: #333; position: relative; vertical-align: middle;
  }
  .confidence-fill {
    height: 100%; border-radius: 3px; position: absolute; left: 0; top: 0;
  }

  /* Simulate panel */
  .simulate-section {
    padding: 12px 20px; background: #141414; border-bottom: 1px solid #282828;
  }
  .simulate-bar {
    display: flex; gap: 10px; align-items: center;
  }
  .simulate-results {
    display: none; margin-top: 16px;
  }
  .simulate-results.open { display: block; }
  .sim-funnel {
    display: flex; gap: 16px; align-items: center; flex-wrap: wrap;
    margin-bottom: 12px; font-size: 13px; color: #aaa;
  }
  .sim-funnel .funnel-step {
    display: flex; align-items: center; gap: 4px;
  }
  .sim-funnel .funnel-num {
    font-weight: 700; font-size: 16px; color: #e0e0e0;
  }
  .sim-funnel .funnel-arrow { color: #555; font-size: 14px; }
  .sms-bubble {
    background: #1a3a1a; border: 1px solid #2d5a2d; border-radius: 12px;
    padding: 14px 18px; margin-bottom: 16px; max-width: 500px;
    font-size: 14px; line-height: 1.5; color: #c6f6c6; white-space: pre-wrap;
  }
  .sms-bubble-label {
    font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px;
    margin-bottom: 6px;
  }
  .sim-table-section { margin-bottom: 16px; }
  .sim-table-section h4 {
    font-size: 13px; font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 8px;
  }
  .sim-table-section h4 .dot {
    display: inline-block; width: 8px; height: 8px; border-radius: 50%;
  }
  .dot-picked { background: #68d391; }
  .dot-notpicked { background: #555; }
  .dot-candidate { background: #3b82f6; }
  .sim-table {
    width: 100%; border-collapse: collapse;
  }
  .sim-table th {
    text-align: left; padding: 6px 10px; font-size: 11px; font-weight: 600;
    color: #888; text-transform: uppercase; border-bottom: 1px solid #333;
    cursor: default;
  }
  .sim-table td {
    padding: 6px 10px; border-bottom: 1px solid #1f1f1f;
    font-size: 13px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .sim-table tr.picked-row { background: rgba(104, 211, 145, 0.08); }
  .sim-table tr.notpicked-row { opacity: 0.6; }
  .sim-expand-toggle {
    background: none; border: 1px solid #333; color: #aaa; font-size: 12px;
    padding: 4px 12px; border-radius: 4px; cursor: pointer; margin-top: 4px;
  }
  .sim-expand-toggle:hover { background: #222; color: #e0e0e0; }

  /* Detail panel */
  .detail-panel {
    position: fixed; bottom: 0; left: 0; right: 0; max-height: 45vh;
    background: #1a1a1a; border-top: 2px solid #3b82f6; overflow-y: auto;
    padding: 16px 20px; display: none; z-index: 10;
  }
  .detail-panel.open { display: block; }
  .detail-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 12px;
  }
  .detail-header h3 { font-size: 16px; color: #fff; }
  .detail-close {
    background: none; border: none; color: #888; font-size: 20px;
    cursor: pointer; padding: 4px 8px;
  }
  .detail-close:hover { color: #fff; }
  .detail-json {
    background: #111; border: 1px solid #333; border-radius: 6px;
    padding: 12px; font-family: 'SF Mono', Monaco, monospace; font-size: 12px;
    white-space: pre-wrap; word-break: break-all; color: #a5d6ff;
    max-height: 30vh; overflow-y: auto;
  }

  /* Tab system */
  .tab-bar {
    display: flex; border-bottom: 2px solid #333; background: #0e0e0e;
  }
  .tab-btn {
    padding: 12px 24px; font-size: 14px; font-weight: 600; color: #888;
    background: none; border: none; border-bottom: 2px solid transparent;
    cursor: pointer; transition: all 0.15s; margin-bottom: -2px;
  }
  .tab-btn:hover { color: #ccc; }
  .tab-btn.active { color: #3b82f6; border-bottom-color: #3b82f6; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* Traces tab styles */
  .trace-summary-bar {
    display: flex; gap: 20px; align-items: center; flex-wrap: wrap;
    padding: 14px 20px; background: #1a1a1a; border-bottom: 1px solid #333;
  }
  .trace-filters {
    display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
    padding: 10px 20px; background: #111; border-bottom: 1px solid #282828;
  }
  .trace-table-wrap { padding: 0 20px; overflow-x: auto; }
  .trace-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  .trace-table th {
    text-align: left; padding: 8px 10px; font-size: 11px; font-weight: 600;
    color: #888; text-transform: uppercase; letter-spacing: 0.5px;
    border-bottom: 2px solid #333; white-space: nowrap;
  }
  .trace-table td {
    padding: 8px 10px; border-bottom: 1px solid #1f1f1f;
    font-size: 13px; vertical-align: top; max-width: 300px;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer;
  }
  .trace-table tr:hover { background: #1a1a2e; }
  .trace-table tr.selected { background: #1a2a3e; }

  .verdict-pass { background: #1a3a1a; color: #68d391; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
  .verdict-fail { background: #3d2020; color: #fc8181; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
  .verdict-none { background: #2a2a2a; color: #888; padding: 2px 8px; border-radius: 10px; font-size: 11px; }
  .intent-badge { background: #1f2d4e; color: #90cdf4; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; }

  /* Trace detail panel */
  .trace-detail {
    position: fixed; bottom: 0; left: 0; right: 0; max-height: 65vh;
    background: #1a1a1a; border-top: 2px solid #3b82f6; overflow-y: auto;
    padding: 16px 20px; display: none; z-index: 20;
  }
  .trace-detail.open { display: block; }
  .trace-detail-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
  }
  .trace-detail-header h3 { font-size: 16px; color: #fff; }

  /* Message bubbles */
  .bubble-user {
    background: #1a3a6e; border: 1px solid #2563eb; border-radius: 16px 16px 4px 16px;
    padding: 12px 16px; margin-bottom: 12px; max-width: 400px;
    font-size: 14px; line-height: 1.5; color: #bfdbfe; white-space: pre-wrap;
  }
  .bubble-pulse {
    background: #1a3a1a; border: 1px solid #2d5a2d; border-radius: 16px 16px 16px 4px;
    padding: 12px 16px; margin-bottom: 12px; max-width: 400px;
    font-size: 14px; line-height: 1.5; color: #c6f6c6; white-space: pre-wrap;
  }
  .bubble-label { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
  .char-count { font-size: 11px; color: #888; margin-top: 4px; }

  /* Trace sections */
  .trace-section { margin-bottom: 16px; }
  .trace-section h4 {
    font-size: 12px; font-weight: 600; color: #aaa; text-transform: uppercase;
    letter-spacing: 0.5px; margin-bottom: 8px;
  }
  .trace-meta {
    display: flex; gap: 16px; flex-wrap: wrap; font-size: 13px;
  }
  .trace-meta-item { display: flex; flex-direction: column; gap: 2px; }
  .trace-meta-label { font-size: 10px; color: #666; text-transform: uppercase; }
  .trace-meta-value { color: #e0e0e0; }

  /* Event mini cards */
  .pick-card {
    display: inline-flex; gap: 8px; align-items: center;
    background: #1f1f1f; border: 1px solid #333; border-radius: 8px;
    padding: 6px 12px; margin: 3px; font-size: 12px;
  }
  .pick-rank { color: #3b82f6; font-weight: 700; }
  .pick-name { color: #e0e0e0; }
  .pick-why { color: #888; font-style: italic; }

  /* Collapsible raw */
  .raw-toggle {
    background: none; border: 1px solid #333; color: #aaa; font-size: 12px;
    padding: 4px 12px; border-radius: 4px; cursor: pointer; margin-top: 8px;
  }
  .raw-toggle:hover { background: #222; color: #e0e0e0; }
  .raw-content {
    display: none; background: #111; border: 1px solid #333; border-radius: 6px;
    padding: 10px; font-family: 'SF Mono', Monaco, monospace; font-size: 11px;
    white-space: pre-wrap; word-break: break-all; color: #a5d6ff;
    max-height: 200px; overflow-y: auto; margin-top: 8px;
  }
  .raw-content.open { display: block; }

  /* Annotation controls */
  .annotation-bar {
    display: flex; gap: 12px; align-items: flex-start; flex-wrap: wrap;
    padding: 16px 0; border-top: 1px solid #333; margin-top: 16px;
  }
  .anno-btn {
    padding: 10px 28px; border-radius: 8px; font-size: 14px; font-weight: 700;
    cursor: pointer; border: 2px solid transparent; transition: all 0.15s;
  }
  .anno-pass { background: #1a3a1a; color: #68d391; border-color: #2d5a2d; }
  .anno-pass:hover, .anno-pass.active { background: #2d5a2d; border-color: #68d391; }
  .anno-fail { background: #3d2020; color: #fc8181; border-color: #5a2d2d; }
  .anno-fail:hover, .anno-fail.active { background: #5a2d2d; border-color: #fc8181; }
  .failure-modes {
    display: none; flex-wrap: wrap; gap: 6px; margin-top: 8px;
  }
  .failure-modes.open { display: flex; }
  .failure-mode-chip {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 4px 10px; border-radius: 12px; font-size: 11px;
    background: #2a2020; color: #fc8181; border: 1px solid #5a2d2d; cursor: pointer;
    transition: all 0.15s;
  }
  .failure-mode-chip.selected { background: #5a2d2d; border-color: #fc8181; }
  .anno-notes {
    width: 100%; max-width: 500px; padding: 8px 12px;
    background: #1a1a1a; border: 1px solid #444; border-radius: 6px;
    color: #e0e0e0; font-size: 13px; resize: vertical; min-height: 40px;
  }
  .anno-save {
    padding: 8px 20px; background: #2563eb; border: none; border-radius: 6px;
    color: #fff; font-size: 13px; font-weight: 600; cursor: pointer;
  }
  .anno-save:hover { background: #1d4ed8; }
  .anno-status { font-size: 12px; color: #888; align-self: center; }
  .kbd { background: #333; color: #ccc; padding: 1px 5px; border-radius: 3px; font-size: 11px; font-family: monospace; }
</style>
</head>
<body>

<!-- Tab Bar -->
<div class="tab-bar">
  <button class="tab-btn active" onclick="switchTab('events-tab')">Event Cache</button>
  <button class="tab-btn" onclick="switchTab('traces-tab')">Traces</button>
</div>

<!-- ==================== EVENTS TAB ==================== -->
<div id="events-tab" class="tab-content active">

<!-- Summary Bar -->
<div class="summary" id="summary">
  <div class="stat">
    <span class="stat-label">Total Events</span>
    <span class="stat-value" id="total-count">--</span>
  </div>
  <div class="stat">
    <span class="stat-label">Cache Age</span>
    <span class="stat-value" id="cache-age">--</span>
  </div>
  <div id="source-pills"></div>
</div>

<!-- Actions -->
<div class="actions">
  <button onclick="refreshCache()" id="btn-refresh">Refresh Cache</button>
  <button onclick="runScoring()" id="btn-score" class="primary">Run AI Scoring</button>
  <span class="status-msg" id="status-msg"></span>
</div>

<!-- Simulate -->
<div class="simulate-section">
  <div class="simulate-bar">
    <label for="sim-neighborhood" style="font-size:13px; color:#aaa;">Simulate Request:</label>
    <select id="sim-neighborhood">
      <option value="">Select neighborhood...</option>
    </select>
    <button onclick="runSimulate()" id="btn-simulate" class="primary">Simulate</button>
    <span class="status-msg" id="sim-status"></span>
  </div>
  <div class="simulate-results" id="sim-results">
    <div class="sim-funnel" id="sim-funnel"></div>
    <div class="sms-bubble-label">Claude's SMS</div>
    <div class="sms-bubble" id="sim-sms"></div>
    <div class="sim-table-section">
      <h4><span class="dot dot-picked"></span> Picked by Claude</h4>
      <table class="sim-table">
        <thead>
          <tr>
            <th>Rank</th><th>Name</th><th>Venue</th><th>Time</th><th>Source</th><th>Why</th>
          </tr>
        </thead>
        <tbody id="sim-picked"></tbody>
      </table>
    </div>
    <div class="sim-table-section">
      <h4><span class="dot dot-notpicked"></span> Sent but Not Picked</h4>
      <div class="sim-not-picked-reason" id="sim-not-picked-reason" style="font-size:12px;color:#aaa;margin-bottom:8px;font-style:italic;"></div>
      <table class="sim-table">
        <thead>
          <tr>
            <th>Name</th><th>Venue</th><th>Time</th><th>Source</th>
          </tr>
        </thead>
        <tbody id="sim-notpicked"></tbody>
      </table>
    </div>
    <div class="sim-table-section" id="sim-candidates-section" style="display:none;">
      <h4><span class="dot dot-candidate"></span> All Candidates (proximity ranked)</h4>
      <table class="sim-table">
        <thead>
          <tr>
            <th>#</th><th>Name</th><th>Venue</th><th>Neighborhood</th><th>Time</th><th>Source</th>
          </tr>
        </thead>
        <tbody id="sim-candidates"></tbody>
      </table>
    </div>
    <button class="sim-expand-toggle" id="sim-expand-btn" onclick="toggleCandidates()">Show all candidates</button>
  </div>
</div>

<!-- Filters -->
<div class="filters">
  <div class="filter-group">
    <input type="checkbox" id="f-skint" checked onchange="applyFilters()">
    <label for="f-skint" class="source-pill source-skint">Skint</label>
  </div>
  <div class="filter-group">
    <input type="checkbox" id="f-ra" checked onchange="applyFilters()">
    <label for="f-ra" class="source-pill source-ra">RA</label>
  </div>
  <div class="filter-group">
    <input type="checkbox" id="f-dice" checked onchange="applyFilters()">
    <label for="f-dice" class="source-pill source-dice">Dice</label>
  </div>
  <div class="filter-group">
    <input type="checkbox" id="f-eventbrite" checked onchange="applyFilters()">
    <label for="f-eventbrite" class="source-pill source-eventbrite">Eventbrite</label>
  </div>
  <div class="filter-group">
    <input type="checkbox" id="f-songkick" checked onchange="applyFilters()">
    <label for="f-songkick" class="source-pill source-songkick">Songkick</label>
  </div>
  <div class="filter-group" style="margin-left: 12px;">
    <label for="f-neighborhood" style="margin-right: 4px;">Neighborhood:</label>
    <select id="f-neighborhood" onchange="applyFilters()">
      <option value="">All</option>
    </select>
  </div>
  <div class="filter-group" style="margin-left: 12px;">
    <label>Min Score:</label>
    <input type="range" id="f-score" min="0" max="10" value="0" oninput="document.getElementById('score-val').textContent=this.value; applyFilters()">
    <span class="range-val" id="score-val">0</span>
  </div>
  <div class="filter-group" style="margin-left: 12px;">
    <input type="checkbox" id="f-flagged" onchange="applyFilters()">
    <label for="f-flagged">Flagged only</label>
  </div>
</div>

<!-- Table -->
<div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th data-col="source_name" onclick="sortBy('source_name')">Source <span class="sort-arrow"></span></th>
        <th data-col="name" onclick="sortBy('name')">Name <span class="sort-arrow"></span></th>
        <th data-col="venue_name" onclick="sortBy('venue_name')">Venue <span class="sort-arrow"></span></th>
        <th data-col="neighborhood" onclick="sortBy('neighborhood')">Neighborhood <span class="sort-arrow"></span></th>
        <th data-col="start_time_local" onclick="sortBy('start_time_local')">Time <span class="sort-arrow"></span></th>
        <th data-col="category" onclick="sortBy('category')">Category <span class="sort-arrow"></span></th>
        <th data-col="price" onclick="sortBy('price')">Price <span class="sort-arrow"></span></th>
        <th data-col="confidence" onclick="sortBy('confidence')">Conf <span class="sort-arrow"></span></th>
        <th data-col="ai_score" onclick="sortBy('ai_score')">AI Score <span class="sort-arrow"></span></th>
        <th>Flags</th>
      </tr>
    </thead>
    <tbody id="event-table"></tbody>
  </table>
</div>

<!-- Detail Panel -->
<div class="detail-panel" id="detail-panel">
  <div class="detail-header">
    <h3 id="detail-title">Event Details</h3>
    <button class="detail-close" onclick="closeDetail()">&times;</button>
  </div>
  <pre class="detail-json" id="detail-json"></pre>
</div>

</div><!-- end events-tab -->

<!-- ==================== TRACES TAB ==================== -->
<div id="traces-tab" class="tab-content">

<!-- Trace Summary Bar -->
<div class="trace-summary-bar" id="trace-summary">
  <div class="stat">
    <span class="stat-label">Total Traces</span>
    <span class="stat-value" id="trace-total">--</span>
  </div>
  <div class="stat">
    <span class="stat-label">Pass Rate</span>
    <span class="stat-value" id="trace-pass-rate">--</span>
  </div>
  <div class="stat">
    <span class="stat-label">Annotated</span>
    <span class="stat-value" id="trace-annotated">--</span>
  </div>
  <div id="trace-failure-pills"></div>
</div>

<!-- Trace Filters -->
<div class="trace-filters">
  <div class="filter-group">
    <label>Verdict:</label>
    <select id="tf-verdict" onchange="applyTraceFilters()">
      <option value="">All</option>
      <option value="pass">Pass</option>
      <option value="fail">Fail</option>
      <option value="unannotated">Unannotated</option>
    </select>
  </div>
  <div class="filter-group">
    <label>Intent:</label>
    <select id="tf-intent" onchange="applyTraceFilters()">
      <option value="">All</option>
      <option value="events">events</option>
      <option value="more">more</option>
      <option value="free">free</option>
      <option value="details">details</option>
      <option value="help">help</option>
      <option value="conversational">conversational</option>
    </select>
  </div>
  <div class="filter-group">
    <label>Neighborhood:</label>
    <select id="tf-neighborhood" onchange="applyTraceFilters()">
      <option value="">All</option>
    </select>
  </div>
  <div class="filter-group">
    <button onclick="loadTraces()" style="font-size:12px;">Refresh</button>
  </div>
</div>

<!-- Trace Table -->
<div class="trace-table-wrap">
  <table class="trace-table">
    <thead>
      <tr>
        <th>Time</th>
        <th>Input</th>
        <th>Intent</th>
        <th>Neighborhood</th>
        <th>SMS Preview</th>
        <th>Latency</th>
        <th>Verdict</th>
      </tr>
    </thead>
    <tbody id="trace-table-body"></tbody>
  </table>
</div>

<!-- Trace Detail Panel -->
<div class="trace-detail" id="trace-detail">
  <div class="trace-detail-header">
    <h3>Trace Detail</h3>
    <button class="detail-close" onclick="closeTraceDetail()">&times;</button>
  </div>

  <!-- User message bubble -->
  <div class="trace-section">
    <div class="bubble-label">User SMS</div>
    <div class="bubble-user" id="td-user-msg"></div>
  </div>

  <!-- Routing -->
  <div class="trace-section">
    <h4>Routing</h4>
    <div class="trace-meta" id="td-routing"></div>
  </div>

  <!-- Event funnel -->
  <div class="trace-section">
    <h4>Event Funnel</h4>
    <div class="sim-funnel" id="td-funnel"></div>
  </div>

  <!-- Picked events -->
  <div class="trace-section" id="td-picks-section">
    <h4>Picked Events</h4>
    <div id="td-picks"></div>
  </div>

  <!-- Pulse SMS bubble -->
  <div class="trace-section">
    <div class="bubble-label">Pulse SMS</div>
    <div class="bubble-pulse" id="td-pulse-msg"></div>
    <div class="char-count" id="td-char-count"></div>
  </div>

  <!-- Raw Claude responses (collapsed) -->
  <div class="trace-section">
    <button class="raw-toggle" onclick="toggleRaw('td-raw-route')">Show raw routing response</button>
    <pre class="raw-content" id="td-raw-route"></pre>
    <button class="raw-toggle" onclick="toggleRaw('td-raw-compose')">Show raw compose response</button>
    <pre class="raw-content" id="td-raw-compose"></pre>
  </div>

  <!-- Annotation controls -->
  <div class="annotation-bar">
    <div>
      <div style="margin-bottom: 8px;">
        <button class="anno-btn anno-pass" id="anno-pass-btn" onclick="setAnnoVerdict('pass')">PASS <span class="kbd">1</span></button>
        <button class="anno-btn anno-fail" id="anno-fail-btn" onclick="setAnnoVerdict('fail')">FAIL <span class="kbd">2</span></button>
        <button class="anno-btn" style="background:#222;color:#aaa;padding:10px 16px;" onclick="advanceToNext()">Next <span class="kbd">N</span></button>
      </div>
      <div class="failure-modes" id="failure-modes">
        <span class="failure-mode-chip" data-mode="wrong_neighborhood" onclick="toggleMode(this)">wrong neighborhood</span>
        <span class="failure-mode-chip" data-mode="stale_event" onclick="toggleMode(this)">stale event</span>
        <span class="failure-mode-chip" data-mode="wrong_day_label" onclick="toggleMode(this)">wrong day label</span>
        <span class="failure-mode-chip" data-mode="char_limit_exceeded" onclick="toggleMode(this)">char limit exceeded</span>
        <span class="failure-mode-chip" data-mode="hallucinated_event" onclick="toggleMode(this)">hallucinated event</span>
        <span class="failure-mode-chip" data-mode="broken_url" onclick="toggleMode(this)">broken url</span>
        <span class="failure-mode-chip" data-mode="off_topic_answered" onclick="toggleMode(this)">off-topic answered</span>
        <span class="failure-mode-chip" data-mode="wrong_intent" onclick="toggleMode(this)">wrong intent</span>
        <span class="failure-mode-chip" data-mode="bad_tone" onclick="toggleMode(this)">bad tone</span>
        <span class="failure-mode-chip" data-mode="irrelevant_pick" onclick="toggleMode(this)">irrelevant pick</span>
        <span class="failure-mode-chip" data-mode="missing_cta" onclick="toggleMode(this)">missing cta</span>
        <span class="failure-mode-chip" data-mode="empty_response" onclick="toggleMode(this)">empty response</span>
      </div>
    </div>
    <div style="flex:1;min-width:200px;">
      <textarea class="anno-notes" id="anno-notes" placeholder="Notes (optional)..."></textarea>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center;">
        <button class="anno-save" onclick="saveAnnotation()">Save</button>
        <span class="anno-status" id="anno-status"></span>
      </div>
    </div>
  </div>
</div>

</div><!-- end traces-tab -->

<script>
let allEvents = [];
let aiScores = {};  // event_id -> { score, flags, note }
let currentSort = { col: 'source_name', asc: true };
let selectedId = null;

// ========== Data Loading ==========

async function loadEvents() {
  setStatus('Loading events...');
  try {
    const res = await fetch('/api/eval/events');
    const data = await res.json();
    allEvents = data.events || [];
    updateSummary(data);
    populateNeighborhoodFilter();
    applyFilters();
    setStatus(`Loaded ${allEvents.length} events`);
  } catch (err) {
    setStatus('Failed to load events: ' + err.message);
  }
}

async function refreshCache() {
  const btn = document.getElementById('btn-refresh');
  btn.disabled = true;
  setStatus('Refreshing cache...');
  try {
    const res = await fetch('/api/eval/refresh', { method: 'POST' });
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    allEvents = data.events || [];
    aiScores = {};
    updateSummary(data);
    populateNeighborhoodFilter();
    applyFilters();
    setStatus(`Cache refreshed: ${allEvents.length} events`);
  } catch (err) {
    setStatus('Refresh failed: ' + err.message);
  }
  btn.disabled = false;
}

async function runScoring() {
  const btn = document.getElementById('btn-score');
  btn.disabled = true;
  setStatus(`Scoring ${allEvents.length} events with Claude...`);
  try {
    const res = await fetch('/api/eval/score', { method: 'POST' });
    const scores = await res.json();
    if (scores.error) throw new Error(scores.error);
    aiScores = {};
    for (const s of scores) {
      aiScores[s.event_id] = s;
    }
    applyFilters();
    setStatus(`Scored ${scores.length} events`);
  } catch (err) {
    setStatus('Scoring failed: ' + err.message);
  }
  btn.disabled = false;
}

// ========== Summary ==========

function updateSummary(data) {
  document.getElementById('total-count').textContent = (data.events || []).length;
  const ageMs = data.timestamp ? Date.now() - data.timestamp : null;
  document.getElementById('cache-age').textContent = ageMs
    ? Math.round(ageMs / 60000) + 'm ago'
    : 'never';

  const counts = { Skint: 0, RA: 0, Dice: 0, Eventbrite: 0, Songkick: 0 };
  for (const e of (data.events || [])) {
    const src = normalizeSource(e.source_name);
    if (counts[src] !== undefined) counts[src]++;
  }

  const pills = document.getElementById('source-pills');
  pills.innerHTML = '';
  for (const [src, count] of Object.entries(counts)) {
    const cls = 'source-' + src.toLowerCase();
    const pill = document.createElement('span');
    pill.className = 'source-pill ' + cls;
    pill.textContent = `${src}: ${count}`;
    pills.appendChild(pill);
  }
}

// ========== Filters & Sort ==========

function populateNeighborhoodFilter() {
  const sel = document.getElementById('f-neighborhood');
  const current = sel.value;
  const hoods = [...new Set(allEvents.map(e => e.neighborhood).filter(Boolean))].sort();
  sel.innerHTML = '<option value="">All</option>';
  for (const h of hoods) {
    const opt = document.createElement('option');
    opt.value = h; opt.textContent = h;
    sel.appendChild(opt);
  }
  sel.value = current;
}

function getClientFlags(e) {
  const flags = [];
  if (!e.venue_name || e.venue_name === 'TBA') flags.push('missing_venue');
  if (!e.neighborhood) flags.push('no_neighborhood');
  if (!e.start_time_local) {
    flags.push('no_time');
  } else if (e.start_time_local && !e.start_time_local.includes('T') && !e.start_time_local.includes(':')) {
    flags.push('no_time');
  }
  if (e.completeness != null && e.completeness < 0.5) flags.push('low_completeness');
  return flags;
}

function getAllFlags(e) {
  const client = getClientFlags(e);
  const ai = aiScores[e.id]?.flags || [];
  return [...new Set([...client, ...ai])];
}

function applyFilters() {
  const showSkint = document.getElementById('f-skint').checked;
  const showRA = document.getElementById('f-ra').checked;
  const showDice = document.getElementById('f-dice').checked;
  const showEB = document.getElementById('f-eventbrite').checked;
  const showSK = document.getElementById('f-songkick').checked;
  const hood = document.getElementById('f-neighborhood').value;
  const minScore = parseInt(document.getElementById('f-score').value);
  const flaggedOnly = document.getElementById('f-flagged').checked;

  let filtered = allEvents.filter(e => {
    const src = normalizeSource(e.source_name);
    if (src === 'Skint' && !showSkint) return false;
    if (src === 'RA' && !showRA) return false;
    if (src === 'Dice' && !showDice) return false;
    if (src === 'Eventbrite' && !showEB) return false;
    if (src === 'Songkick' && !showSK) return false;
    if (hood && e.neighborhood !== hood) return false;
    if (minScore > 0) {
      const s = aiScores[e.id]?.score;
      if (s == null || s < minScore) return false;
    }
    if (flaggedOnly && getAllFlags(e).length === 0) return false;
    return true;
  });

  // Sort
  filtered.sort((a, b) => {
    let va, vb;
    if (currentSort.col === 'ai_score') {
      va = aiScores[a.id]?.score ?? -1;
      vb = aiScores[b.id]?.score ?? -1;
    } else if (currentSort.col === 'completeness') {
      va = a.completeness ?? -1;
      vb = b.completeness ?? -1;
    } else if (currentSort.col === 'price') {
      va = a.is_free ? 'free' : (a.price_display || 'zzz');
      vb = b.is_free ? 'free' : (b.price_display || 'zzz');
    } else {
      va = (a[currentSort.col] || '').toString().toLowerCase();
      vb = (b[currentSort.col] || '').toString().toLowerCase();
    }
    if (va < vb) return currentSort.asc ? -1 : 1;
    if (va > vb) return currentSort.asc ? 1 : -1;
    return 0;
  });

  renderTable(filtered);
  updateSortArrows();
}

function sortBy(col) {
  if (currentSort.col === col) {
    currentSort.asc = !currentSort.asc;
  } else {
    currentSort = { col, asc: col === 'ai_score' || col === 'confidence' ? false : true };
  }
  applyFilters();
}

function updateSortArrows() {
  document.querySelectorAll('th').forEach(th => {
    const arrow = th.querySelector('.sort-arrow');
    if (!arrow) return;
    if (th.dataset.col === currentSort.col) {
      arrow.textContent = currentSort.asc ? ' \u25B2' : ' \u25BC';
    } else {
      arrow.textContent = '';
    }
  });
}

// ========== Rendering ==========

function renderTable(events) {
  const tbody = document.getElementById('event-table');
  tbody.innerHTML = '';

  for (const e of events) {
    const tr = document.createElement('tr');
    const flags = getAllFlags(e);
    if (flags.length > 0) tr.classList.add('flagged');
    if (e.id === selectedId) tr.classList.add('selected');
    tr.onclick = () => showDetail(e);

    const src = normalizeSource(e.source_name);
    const srcClass = 'source-' + src.toLowerCase();
    const aiScore = aiScores[e.id]?.score;

    tr.innerHTML = `
      <td><span class="badge ${srcClass}">${src}</span></td>
      <td title="${esc(e.name || '')}">${nameLink(e)}</td>
      <td>${venueCell(e)}</td>
      <td>${e.neighborhood ? esc(e.neighborhood) : '<span style="color:#fc8181">—</span>'}</td>
      <td>${timeCell(e)}</td>
      <td>${esc(e.category || '—')}</td>
      <td>${priceCell(e)}</td>
      <td>${confidenceCell(e)}</td>
      <td>${scoreCell(aiScore)}</td>
      <td>${flagCells(flags)}</td>
    `;
    tbody.appendChild(tr);
  }
}

function nameLink(e) {
  const name = esc(e.name || '—');
  const url = e.ticket_url || e.source_url;
  if (url) return `<a href="${esc(url)}" target="_blank" rel="noopener" style="color:#93c5fd;text-decoration:none;" onclick="event.stopPropagation()">${name}</a>`;
  return name;
}

function venueCell(e) {
  if (!e.venue_name || e.venue_name === 'TBA') return '<span style="color:#fc8181">TBA</span>';
  return esc(e.venue_name);
}

function timeCell(e) {
  if (!e.start_time_local) {
    if (e.date_local) return `<span style="color:#f6e05e">${esc(e.date_local)}</span>`;
    return '<span style="color:#fc8181">—</span>';
  }
  return formatTimeDisplay(e.start_time_local);
}

function formatTimeDisplay(val) {
  // Bare date (no time) — parse as local components to avoid UTC midnight shift
  if (!/T|:/.test(val)) {
    try {
      const [y, m, d] = val.split('-').map(Number);
      if (y && m && d) return new Date(y, m - 1, d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    } catch {}
    return esc(val);
  }
  try {
    const d = new Date(val);
    if (isNaN(d)) return esc(val);
    return d.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
  } catch { return esc(val); }
}

function priceCell(e) {
  if (e.is_free) return '<span style="color:#68d391">Free</span>';
  return esc(e.price_display || '—');
}

function confidenceCell(e) {
  if (e.completeness == null) return '—';
  const pct = Math.round(e.completeness * 100);
  const color = e.completeness >= 0.7 ? '#68d391' : e.completeness >= 0.5 ? '#f6e05e' : '#fc8181';
  return `<span class="confidence-bar"><span class="confidence-fill" style="width:${pct}%;background:${color}"></span></span> <span style="font-size:11px;color:${color}">${e.completeness.toFixed(2)}</span>`;
}

function scoreCell(score) {
  if (score == null) return '<span style="color:#555">—</span>';
  const cls = score >= 7 ? 'score-high' : score >= 4 ? 'score-mid' : 'score-low';
  return `<span class="score-cell ${cls}">${score}</span>`;
}

function flagCells(flags) {
  if (flags.length === 0) return '';
  return flags.map(f => {
    const warn = ['low_confidence', 'no_time'].includes(f);
    return `<span class="flag-badge${warn ? ' warn' : ''}">${f.replace(/_/g, ' ')}</span>`;
  }).join('');
}

// ========== Detail Panel ==========

function showDetail(e) {
  selectedId = e.id;
  document.getElementById('detail-title').textContent = e.name || 'Event Details';
  const combined = { ...e };
  if (aiScores[e.id]) combined._ai_eval = aiScores[e.id];
  combined._client_flags = getClientFlags(e);
  document.getElementById('detail-json').textContent = JSON.stringify(combined, null, 2);
  document.getElementById('detail-panel').classList.add('open');
  // Re-render to show selected highlight
  applyFilters();
}

function closeDetail() {
  selectedId = null;
  document.getElementById('detail-panel').classList.remove('open');
  applyFilters();
}

// ========== Helpers ==========

function normalizeSource(name) {
  if (!name) return 'Unknown';
  const n = name.toLowerCase();
  if (n.includes('skint')) return 'Skint';
  if (n === 'ra') return 'RA';
  if (n === 'dice') return 'Dice';
  if (n.includes('eventbrite')) return 'Eventbrite';
  if (n.includes('songkick')) return 'Songkick';
  return name;
}

function esc(s) {
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

function setStatus(msg) {
  document.getElementById('status-msg').textContent = msg;
}

// ========== Simulate ==========

function populateSimNeighborhoods() {
  const sel = document.getElementById('sim-neighborhood');
  const hoods = [
    'Astoria', 'Bed-Stuy', 'Bushwick', 'Chelsea', 'Crown Heights',
    'Downtown Brooklyn', 'DUMBO', 'East Village', 'Financial District',
    'Flatiron', 'Greenpoint', 'Greenwich Village', "Hell's Kitchen",
    'Harlem', 'Long Island City', 'Lower East Side', 'Midtown', 'NoHo',
    'Park Slope', 'SoHo', 'Tribeca', 'Upper East Side', 'Upper West Side',
    'West Village', 'Williamsburg'
  ];
  for (const h of hoods) {
    const opt = document.createElement('option');
    opt.value = h; opt.textContent = h;
    sel.appendChild(opt);
  }
}

async function runSimulate() {
  const hood = document.getElementById('sim-neighborhood').value;
  if (!hood) { setSimStatus('Select a neighborhood first'); return; }

  const btn = document.getElementById('btn-simulate');
  btn.disabled = true;
  setSimStatus('Simulating ' + hood + '...');

  try {
    const res = await fetch('/api/eval/simulate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ neighborhood: hood }),
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    renderSimResults(data);
    setSimStatus('');
  } catch (err) {
    setSimStatus('Simulate failed: ' + err.message);
    document.getElementById('sim-results').classList.remove('open');
  }
  btn.disabled = false;
}

function renderSimResults(data) {
  document.getElementById('sim-results').classList.add('open');

  // Funnel stats
  const funnel = document.getElementById('sim-funnel');
  funnel.innerHTML = `
    <span class="funnel-step"><span class="funnel-num">${data.candidates.length}</span> in proximity</span>
    <span class="funnel-arrow">&rarr;</span>
    <span class="funnel-step"><span class="funnel-num">${data.sent_to_claude.length}</span> sent to Claude</span>
    <span class="funnel-arrow">&rarr;</span>
    <span class="funnel-step"><span class="funnel-num">${data.picked.length}</span> picked</span>
  `;

  // SMS bubble
  document.getElementById('sim-sms').textContent = data.compose_result.sms_text;

  // Picked table
  const pickedTbody = document.getElementById('sim-picked');
  pickedTbody.innerHTML = '';
  const picks = data.compose_result.picks || [];
  for (const event of data.picked) {
    const pick = picks.find(p => p.event_id === event.id);
    const tr = document.createElement('tr');
    tr.className = 'picked-row';
    tr.innerHTML = `
      <td>${pick ? pick.rank : '—'}</td>
      <td title="${esc(event.name || '')}">${nameLink(event)}</td>
      <td>${esc(event.venue_name || '—')}</td>
      <td>${simTimeCell(event)}</td>
      <td>${esc(event.source_name || '—')}</td>
      <td style="color:#a5d6ff;font-style:italic;max-width:300px;white-space:normal;">${pick && pick.why ? esc(pick.why) : '—'}</td>
    `;
    pickedTbody.appendChild(tr);
  }

  // Not picked reasoning
  const reasonEl = document.getElementById('sim-not-picked-reason');
  const notPickedReason = data.compose_result.not_picked_reason;
  reasonEl.textContent = notPickedReason ? `"${notPickedReason}"` : '';

  // Not picked table
  const notPickedTbody = document.getElementById('sim-notpicked');
  notPickedTbody.innerHTML = '';
  for (const event of data.not_picked) {
    const tr = document.createElement('tr');
    tr.className = 'notpicked-row';
    tr.innerHTML = `
      <td title="${esc(event.name || '')}">${nameLink(event)}</td>
      <td>${esc(event.venue_name || '—')}</td>
      <td>${simTimeCell(event)}</td>
      <td>${esc(event.source_name || '—')}</td>
    `;
    notPickedTbody.appendChild(tr);
  }

  // Candidates table (hidden by default)
  const candTbody = document.getElementById('sim-candidates');
  candTbody.innerHTML = '';
  data.candidates.forEach((event, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td title="${esc(event.name || '')}">${nameLink(event)}</td>
      <td>${esc(event.venue_name || '—')}</td>
      <td>${esc(event.neighborhood || '—')}</td>
      <td>${simTimeCell(event)}</td>
      <td>${esc(event.source_name || '—')}</td>
    `;
    candTbody.appendChild(tr);
  });

  // Reset expand state
  document.getElementById('sim-candidates-section').style.display = 'none';
  document.getElementById('sim-expand-btn').textContent = 'Show all candidates';
}

function toggleCandidates() {
  const section = document.getElementById('sim-candidates-section');
  const btn = document.getElementById('sim-expand-btn');
  if (section.style.display === 'none') {
    section.style.display = 'block';
    btn.textContent = 'Hide candidates';
  } else {
    section.style.display = 'none';
    btn.textContent = 'Show all candidates';
  }
}

function simTimeCell(e) {
  if (!e.start_time_local) {
    if (e.date_local) return esc(e.date_local);
    return '—';
  }
  return formatTimeDisplay(e.start_time_local);
}

function setSimStatus(msg) {
  document.getElementById('sim-status').textContent = msg;
}

// Keyboard shortcut: Escape closes detail panel
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeDetail();
});

// ========== Tab System ==========

function switchTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  // Find the button that matches
  document.querySelectorAll('.tab-btn').forEach(btn => {
    if ((tabId === 'events-tab' && btn.textContent === 'Event Cache') ||
        (tabId === 'traces-tab' && btn.textContent === 'Traces')) {
      btn.classList.add('active');
    }
  });
  if (tabId === 'traces-tab' && allTraces.length === 0) loadTraces();
}

// ========== Traces Tab ==========

let allTraces = [];
let filteredTraces = [];
let selectedTraceId = null;
let annoVerdict = null;

async function loadTraces() {
  try {
    const res = await fetch('/api/eval/traces?limit=200');
    allTraces = await res.json();
    updateTraceSummary();
    populateTraceNeighborhoodFilter();
    applyTraceFilters();
  } catch (err) {
    console.error('Failed to load traces:', err);
  }
}

function updateTraceSummary() {
  document.getElementById('trace-total').textContent = allTraces.length;
  const annotated = allTraces.filter(t => t.annotation);
  const passed = annotated.filter(t => t.annotation.verdict === 'pass');
  document.getElementById('trace-annotated').textContent = `${annotated.length}/${allTraces.length}`;
  document.getElementById('trace-pass-rate').textContent = annotated.length > 0
    ? Math.round((passed.length / annotated.length) * 100) + '%'
    : '--';

  // Failure mode pills
  const modeCounts = {};
  for (const t of annotated) {
    if (t.annotation.verdict === 'fail') {
      for (const m of (t.annotation.failure_modes || [])) {
        modeCounts[m] = (modeCounts[m] || 0) + 1;
      }
    }
  }
  const pills = document.getElementById('trace-failure-pills');
  pills.innerHTML = '';
  const sorted = Object.entries(modeCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
  for (const [mode, count] of sorted) {
    const pill = document.createElement('span');
    pill.className = 'flag-badge';
    pill.textContent = `${mode.replace(/_/g, ' ')}: ${count}`;
    pills.appendChild(pill);
  }
}

function populateTraceNeighborhoodFilter() {
  const sel = document.getElementById('tf-neighborhood');
  const hoods = [...new Set(allTraces.map(t =>
    t.composition?.neighborhood_used || t.routing?.result?.neighborhood
  ).filter(Boolean))].sort();
  const current = sel.value;
  sel.innerHTML = '<option value="">All</option>';
  for (const h of hoods) {
    const opt = document.createElement('option');
    opt.value = h; opt.textContent = h;
    sel.appendChild(opt);
  }
  sel.value = current;
}

function applyTraceFilters() {
  const verdict = document.getElementById('tf-verdict').value;
  const intent = document.getElementById('tf-intent').value;
  const hood = document.getElementById('tf-neighborhood').value;

  filteredTraces = allTraces.filter(t => {
    if (verdict === 'pass' && t.annotation?.verdict !== 'pass') return false;
    if (verdict === 'fail' && t.annotation?.verdict !== 'fail') return false;
    if (verdict === 'unannotated' && t.annotation) return false;
    if (intent && t.output_intent !== intent) return false;
    if (hood) {
      const traceHood = t.composition?.neighborhood_used || t.routing?.result?.neighborhood;
      if (traceHood !== hood) return false;
    }
    return true;
  });

  renderTraceTable(filteredTraces);
}

function renderTraceTable(traces) {
  const tbody = document.getElementById('trace-table-body');
  tbody.innerHTML = '';

  for (const t of traces) {
    const tr = document.createElement('tr');
    if (t.id === selectedTraceId) tr.classList.add('selected');
    tr.onclick = () => showTraceDetail(t);

    const time = new Date(t.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    const date = new Date(t.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    const hood = t.composition?.neighborhood_used || t.routing?.result?.neighborhood || '';
    const smsPreview = (t.output_sms || '').slice(0, 60);
    const latency = t.total_latency_ms ? `${(t.total_latency_ms / 1000).toFixed(1)}s` : '--';

    let verdictHtml;
    if (t.annotation?.verdict === 'pass') verdictHtml = '<span class="verdict-pass">PASS</span>';
    else if (t.annotation?.verdict === 'fail') verdictHtml = '<span class="verdict-fail">FAIL</span>';
    else verdictHtml = '<span class="verdict-none">--</span>';

    tr.innerHTML = `
      <td>${date} ${time}</td>
      <td title="${esc(t.input_message)}">${esc(t.input_message.slice(0, 40))}</td>
      <td><span class="intent-badge">${t.output_intent || '--'}</span></td>
      <td>${esc(hood)}</td>
      <td title="${esc(t.output_sms || '')}">${esc(smsPreview)}</td>
      <td>${latency}</td>
      <td>${verdictHtml}</td>
    `;
    tbody.appendChild(tr);
  }
}

function showTraceDetail(t) {
  selectedTraceId = t.id;
  renderTraceTable(filteredTraces); // update selection highlight

  // User message
  document.getElementById('td-user-msg').textContent = t.input_message;

  // Routing
  const r = t.routing || {};
  const routeResult = r.result || {};
  document.getElementById('td-routing').innerHTML = `
    <div class="trace-meta-item">
      <span class="trace-meta-label">Intent</span>
      <span class="trace-meta-value"><span class="intent-badge">${routeResult.intent || '--'}</span></span>
    </div>
    <div class="trace-meta-item">
      <span class="trace-meta-label">Neighborhood</span>
      <span class="trace-meta-value">${routeResult.neighborhood || '--'}</span>
    </div>
    <div class="trace-meta-item">
      <span class="trace-meta-label">Confidence</span>
      <span class="trace-meta-value">${routeResult.confidence != null ? routeResult.confidence.toFixed(2) : '--'}</span>
    </div>
    <div class="trace-meta-item">
      <span class="trace-meta-label">Pre-routed</span>
      <span class="trace-meta-value">${r.pre_routed ? 'Yes' : 'No'}</span>
    </div>
    <div class="trace-meta-item">
      <span class="trace-meta-label">Route Latency</span>
      <span class="trace-meta-value">${r.latency_ms || 0}ms</span>
    </div>
  `;

  // Event funnel
  const ev = t.events || {};
  document.getElementById('td-funnel').innerHTML = `
    <span class="funnel-step"><span class="funnel-num">${ev.cache_size || 0}</span> in cache</span>
    <span class="funnel-arrow">&rarr;</span>
    <span class="funnel-step"><span class="funnel-num">${ev.candidates_count || 0}</span> candidates</span>
    <span class="funnel-arrow">&rarr;</span>
    <span class="funnel-step"><span class="funnel-num">${ev.sent_to_claude || 0}</span> sent to Claude</span>
    <span class="funnel-arrow">&rarr;</span>
    <span class="funnel-step"><span class="funnel-num">${(t.composition?.picks || []).length}</span> picked</span>
  `;

  // Picks
  const picks = t.composition?.picks || [];
  const picksEl = document.getElementById('td-picks');
  const picksSection = document.getElementById('td-picks-section');
  if (picks.length > 0) {
    picksSection.style.display = 'block';
    picksEl.innerHTML = picks.map(p => `
      <div class="pick-card">
        <span class="pick-rank">#${p.rank || '?'}</span>
        <span class="pick-name">${esc(p.event_id)}</span>
        ${p.why ? `<span class="pick-why">${esc(p.why)}</span>` : ''}
      </div>
    `).join('');
  } else {
    picksSection.style.display = 'none';
  }

  // Pulse SMS
  document.getElementById('td-pulse-msg').textContent = t.output_sms || '(empty)';
  document.getElementById('td-char-count').textContent = `${t.output_sms_length || 0} / 480 chars`;

  // Raw responses
  document.getElementById('td-raw-route').textContent = t.routing?.raw_response || '(pre-routed, no raw)';
  document.getElementById('td-raw-compose').textContent = t.composition?.raw_response || '(no raw)';
  document.querySelectorAll('.raw-content').forEach(el => el.classList.remove('open'));

  // Reset annotation state
  annoVerdict = t.annotation?.verdict || null;
  document.getElementById('anno-pass-btn').classList.toggle('active', annoVerdict === 'pass');
  document.getElementById('anno-fail-btn').classList.toggle('active', annoVerdict === 'fail');
  document.getElementById('failure-modes').classList.toggle('open', annoVerdict === 'fail');
  document.getElementById('anno-notes').value = t.annotation?.notes || '';
  document.getElementById('anno-status').textContent = t.annotation ? `Annotated ${new Date(t.annotation.annotated_at).toLocaleString()}` : '';

  // Reset failure mode chips
  document.querySelectorAll('.failure-mode-chip').forEach(chip => {
    const mode = chip.dataset.mode;
    chip.classList.toggle('selected', (t.annotation?.failure_modes || []).includes(mode));
  });

  document.getElementById('trace-detail').classList.add('open');
}

function closeTraceDetail() {
  selectedTraceId = null;
  document.getElementById('trace-detail').classList.remove('open');
  renderTraceTable(filteredTraces);
}

function toggleRaw(id) {
  document.getElementById(id).classList.toggle('open');
}

function setAnnoVerdict(v) {
  annoVerdict = v;
  document.getElementById('anno-pass-btn').classList.toggle('active', v === 'pass');
  document.getElementById('anno-fail-btn').classList.toggle('active', v === 'fail');
  document.getElementById('failure-modes').classList.toggle('open', v === 'fail');
}

function toggleMode(chip) {
  chip.classList.toggle('selected');
}

async function saveAnnotation() {
  if (!selectedTraceId || !annoVerdict) {
    document.getElementById('anno-status').textContent = 'Select PASS or FAIL first';
    return;
  }

  const failure_modes = [];
  if (annoVerdict === 'fail') {
    document.querySelectorAll('.failure-mode-chip.selected').forEach(chip => {
      failure_modes.push(chip.dataset.mode);
    });
  }
  const notes = document.getElementById('anno-notes').value.trim();

  try {
    const res = await fetch(`/api/eval/traces/${selectedTraceId}/annotate`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ verdict: annoVerdict, failure_modes, notes }),
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    document.getElementById('anno-status').textContent = 'Saved!';

    // Update local trace data
    const trace = allTraces.find(t => t.id === selectedTraceId);
    if (trace) {
      trace.annotation = { verdict: annoVerdict, failure_modes, notes, annotated_at: new Date().toISOString() };
    }
    updateTraceSummary();
    applyTraceFilters();

    // Auto-advance to next unannotated
    setTimeout(() => advanceToNext(), 300);
  } catch (err) {
    document.getElementById('anno-status').textContent = 'Save failed: ' + err.message;
  }
}

function advanceToNext() {
  const unannotated = filteredTraces.filter(t => !t.annotation);
  if (unannotated.length > 0) {
    showTraceDetail(unannotated[0]);
  } else {
    document.getElementById('anno-status').textContent = 'All traces annotated!';
  }
}

// Keyboard shortcuts for annotation
document.addEventListener('keydown', e => {
  if (!document.getElementById('trace-detail').classList.contains('open')) return;
  // Skip if user is typing in textarea
  if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;

  if (e.key === '1') { setAnnoVerdict('pass'); e.preventDefault(); }
  if (e.key === '2') { setAnnoVerdict('fail'); e.preventDefault(); }
  if (e.key === 'n' || e.key === 'N') { advanceToNext(); e.preventDefault(); }
  if (e.key === 'Escape') { closeTraceDetail(); e.preventDefault(); }
});

// Init
populateSimNeighborhoods();
loadEvents();
</script>
</body>
</html>
