<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pulse Eval Dashboard</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;
    background: #0a0a0a; color: #e0e0e0; font-size: 14px; line-height: 1.4;
  }

  /* Summary bar */
  .summary {
    display: flex; gap: 16px; align-items: center; flex-wrap: wrap;
    padding: 16px 20px; background: #1a1a1a; border-bottom: 1px solid #333;
  }
  .stat { display: flex; flex-direction: column; gap: 2px; }
  .stat-label { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-value { font-size: 18px; font-weight: 600; }
  .source-pill {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;
  }
  .source-skint { background: #2d1f4e; color: #b794f6; }
  .source-ra { background: #1f2d4e; color: #90cdf4; }
  .source-dice { background: #4e1f3d; color: #f687b3; }
  .source-eventbrite { background: #1f3d2d; color: #68d391; }
  .source-songkick { background: #3d2d1f; color: #f6ad55; }
  .health-ok { color: #68d391; }
  .health-warn { color: #f6ad55; }
  .health-bad { color: #fc8181; }

  /* Actions bar */
  .actions {
    display: flex; gap: 10px; align-items: center; padding: 12px 20px;
    background: #141414; border-bottom: 1px solid #282828;
  }
  button {
    padding: 8px 16px; border: 1px solid #444; border-radius: 6px;
    background: #222; color: #e0e0e0; cursor: pointer; font-size: 13px;
    transition: background 0.15s;
  }
  button:hover { background: #333; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  button.primary { background: #2563eb; border-color: #3b82f6; color: #fff; }
  button.primary:hover { background: #1d4ed8; }
  .status-msg { font-size: 12px; color: #888; margin-left: 8px; }

  /* Filters */
  .filters {
    display: flex; gap: 16px; align-items: center; flex-wrap: wrap;
    padding: 10px 20px; background: #111; border-bottom: 1px solid #282828;
  }
  .filter-group { display: flex; align-items: center; gap: 6px; }
  .filter-group label { font-size: 12px; color: #aaa; cursor: pointer; }
  .filter-group input[type="checkbox"] { accent-color: #3b82f6; }
  select {
    padding: 4px 8px; background: #222; border: 1px solid #444; border-radius: 4px;
    color: #e0e0e0; font-size: 12px;
  }
  .filter-group input[type="range"] { width: 80px; accent-color: #3b82f6; }
  .range-val { font-size: 12px; color: #aaa; min-width: 16px; }

  /* Table */
  .table-wrap { overflow-x: auto; padding: 0 20px 20px; }
  table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  th {
    text-align: left; padding: 8px 10px; font-size: 11px; font-weight: 600;
    color: #888; text-transform: uppercase; letter-spacing: 0.5px;
    border-bottom: 2px solid #333; cursor: pointer; user-select: none;
    white-space: nowrap;
  }
  th:hover { color: #bbb; }
  th .sort-arrow { font-size: 10px; margin-left: 4px; }
  td {
    padding: 8px 10px; border-bottom: 1px solid #1f1f1f;
    font-size: 13px; vertical-align: top; max-width: 250px;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  tr:hover { background: #1a1a2e; }
  tr.selected { background: #1a2a3e; }
  tr.flagged td { opacity: 0.85; }

  /* Badges */
  .badge {
    display: inline-block; padding: 2px 8px; border-radius: 10px;
    font-size: 11px; font-weight: 500;
  }
  .flag-badge {
    display: inline-block; padding: 1px 6px; border-radius: 8px;
    font-size: 10px; font-weight: 500; margin: 1px 2px;
    background: #3d2020; color: #fc8181;
  }
  .flag-badge.warn { background: #3d3420; color: #f6e05e; }
  .score-cell { font-weight: 700; font-size: 15px; }
  .score-high { color: #68d391; }
  .score-mid { color: #f6e05e; }
  .score-low { color: #fc8181; }
  .confidence-bar {
    display: inline-block; width: 40px; height: 6px; border-radius: 3px;
    background: #333; position: relative; vertical-align: middle;
  }
  .confidence-fill {
    height: 100%; border-radius: 3px; position: absolute; left: 0; top: 0;
  }

  /* Simulate panel */
  .simulate-section {
    padding: 12px 20px; background: #141414; border-bottom: 1px solid #282828;
  }
  .simulate-bar {
    display: flex; gap: 10px; align-items: center;
  }
  .simulate-results {
    display: none; margin-top: 16px;
  }
  .simulate-results.open { display: block; }
  .sim-funnel {
    display: flex; gap: 16px; align-items: center; flex-wrap: wrap;
    margin-bottom: 12px; font-size: 13px; color: #aaa;
  }
  .sim-funnel .funnel-step {
    display: flex; align-items: center; gap: 4px;
  }
  .sim-funnel .funnel-num {
    font-weight: 700; font-size: 16px; color: #e0e0e0;
  }
  .sim-funnel .funnel-arrow { color: #555; font-size: 14px; }
  .sms-bubble {
    background: #1a3a1a; border: 1px solid #2d5a2d; border-radius: 12px;
    padding: 14px 18px; margin-bottom: 16px; max-width: 500px;
    font-size: 14px; line-height: 1.5; color: #c6f6c6; white-space: pre-wrap;
  }
  .sms-bubble-label {
    font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px;
    margin-bottom: 6px;
  }
  .sim-table-section { margin-bottom: 16px; }
  .sim-table-section h4 {
    font-size: 13px; font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 8px;
  }
  .sim-table-section h4 .dot {
    display: inline-block; width: 8px; height: 8px; border-radius: 50%;
  }
  .dot-picked { background: #68d391; }
  .dot-notpicked { background: #555; }
  .dot-candidate { background: #3b82f6; }
  .sim-table {
    width: 100%; border-collapse: collapse;
  }
  .sim-table th {
    text-align: left; padding: 6px 10px; font-size: 11px; font-weight: 600;
    color: #888; text-transform: uppercase; border-bottom: 1px solid #333;
    cursor: default;
  }
  .sim-table td {
    padding: 6px 10px; border-bottom: 1px solid #1f1f1f;
    font-size: 13px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .sim-table tr.picked-row { background: rgba(104, 211, 145, 0.08); }
  .sim-table tr.notpicked-row { opacity: 0.6; }
  .sim-expand-toggle {
    background: none; border: 1px solid #333; color: #aaa; font-size: 12px;
    padding: 4px 12px; border-radius: 4px; cursor: pointer; margin-top: 4px;
  }
  .sim-expand-toggle:hover { background: #222; color: #e0e0e0; }

  /* Detail panel */
  .detail-panel {
    position: fixed; bottom: 0; left: 0; right: 0; max-height: 45vh;
    background: #1a1a1a; border-top: 2px solid #3b82f6; overflow-y: auto;
    padding: 16px 20px; display: none; z-index: 10;
  }
  .detail-panel.open { display: block; }
  .detail-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 12px;
  }
  .detail-header h3 { font-size: 16px; color: #fff; }
  .detail-close {
    background: none; border: none; color: #888; font-size: 20px;
    cursor: pointer; padding: 4px 8px;
  }
  .detail-close:hover { color: #fff; }
  .detail-json {
    background: #111; border: 1px solid #333; border-radius: 6px;
    padding: 12px; font-family: 'SF Mono', Monaco, monospace; font-size: 12px;
    white-space: pre-wrap; word-break: break-all; color: #a5d6ff;
    max-height: 30vh; overflow-y: auto;
  }
</style>
</head>
<body>

<!-- Summary Bar -->
<div class="summary" id="summary">
  <div class="stat">
    <span class="stat-label">Total Events</span>
    <span class="stat-value" id="total-count">--</span>
  </div>
  <div class="stat">
    <span class="stat-label">Cache Age</span>
    <span class="stat-value" id="cache-age">--</span>
  </div>
  <div id="source-pills"></div>
</div>

<!-- Actions -->
<div class="actions">
  <button onclick="refreshCache()" id="btn-refresh">Refresh Cache</button>
  <button onclick="runScoring()" id="btn-score" class="primary">Run AI Scoring</button>
  <span class="status-msg" id="status-msg"></span>
</div>

<!-- Simulate -->
<div class="simulate-section">
  <div class="simulate-bar">
    <label for="sim-neighborhood" style="font-size:13px; color:#aaa;">Simulate Request:</label>
    <select id="sim-neighborhood">
      <option value="">Select neighborhood...</option>
    </select>
    <button onclick="runSimulate()" id="btn-simulate" class="primary">Simulate</button>
    <span class="status-msg" id="sim-status"></span>
  </div>
  <div class="simulate-results" id="sim-results">
    <div class="sim-funnel" id="sim-funnel"></div>
    <div class="sms-bubble-label">Claude's SMS</div>
    <div class="sms-bubble" id="sim-sms"></div>
    <div class="sim-table-section">
      <h4><span class="dot dot-picked"></span> Picked by Claude</h4>
      <table class="sim-table">
        <thead>
          <tr>
            <th>Rank</th><th>Name</th><th>Venue</th><th>Time</th><th>Source</th><th>Why</th>
          </tr>
        </thead>
        <tbody id="sim-picked"></tbody>
      </table>
    </div>
    <div class="sim-table-section">
      <h4><span class="dot dot-notpicked"></span> Sent but Not Picked</h4>
      <div class="sim-not-picked-reason" id="sim-not-picked-reason" style="font-size:12px;color:#aaa;margin-bottom:8px;font-style:italic;"></div>
      <table class="sim-table">
        <thead>
          <tr>
            <th>Name</th><th>Venue</th><th>Time</th><th>Source</th>
          </tr>
        </thead>
        <tbody id="sim-notpicked"></tbody>
      </table>
    </div>
    <div class="sim-table-section" id="sim-candidates-section" style="display:none;">
      <h4><span class="dot dot-candidate"></span> All Candidates (proximity ranked)</h4>
      <table class="sim-table">
        <thead>
          <tr>
            <th>#</th><th>Name</th><th>Venue</th><th>Neighborhood</th><th>Time</th><th>Source</th>
          </tr>
        </thead>
        <tbody id="sim-candidates"></tbody>
      </table>
    </div>
    <button class="sim-expand-toggle" id="sim-expand-btn" onclick="toggleCandidates()">Show all candidates</button>
  </div>
</div>

<!-- Filters -->
<div class="filters">
  <div class="filter-group">
    <input type="checkbox" id="f-skint" checked onchange="applyFilters()">
    <label for="f-skint" class="source-pill source-skint">Skint</label>
  </div>
  <div class="filter-group">
    <input type="checkbox" id="f-ra" checked onchange="applyFilters()">
    <label for="f-ra" class="source-pill source-ra">RA</label>
  </div>
  <div class="filter-group">
    <input type="checkbox" id="f-dice" checked onchange="applyFilters()">
    <label for="f-dice" class="source-pill source-dice">Dice</label>
  </div>
  <div class="filter-group">
    <input type="checkbox" id="f-eventbrite" checked onchange="applyFilters()">
    <label for="f-eventbrite" class="source-pill source-eventbrite">Eventbrite</label>
  </div>
  <div class="filter-group">
    <input type="checkbox" id="f-songkick" checked onchange="applyFilters()">
    <label for="f-songkick" class="source-pill source-songkick">Songkick</label>
  </div>
  <div class="filter-group" style="margin-left: 12px;">
    <label for="f-neighborhood" style="margin-right: 4px;">Neighborhood:</label>
    <select id="f-neighborhood" onchange="applyFilters()">
      <option value="">All</option>
    </select>
  </div>
  <div class="filter-group" style="margin-left: 12px;">
    <label>Min Score:</label>
    <input type="range" id="f-score" min="0" max="10" value="0" oninput="document.getElementById('score-val').textContent=this.value; applyFilters()">
    <span class="range-val" id="score-val">0</span>
  </div>
  <div class="filter-group" style="margin-left: 12px;">
    <input type="checkbox" id="f-flagged" onchange="applyFilters()">
    <label for="f-flagged">Flagged only</label>
  </div>
</div>

<!-- Table -->
<div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th data-col="source_name" onclick="sortBy('source_name')">Source <span class="sort-arrow"></span></th>
        <th data-col="name" onclick="sortBy('name')">Name <span class="sort-arrow"></span></th>
        <th data-col="venue_name" onclick="sortBy('venue_name')">Venue <span class="sort-arrow"></span></th>
        <th data-col="neighborhood" onclick="sortBy('neighborhood')">Neighborhood <span class="sort-arrow"></span></th>
        <th data-col="start_time_local" onclick="sortBy('start_time_local')">Time <span class="sort-arrow"></span></th>
        <th data-col="category" onclick="sortBy('category')">Category <span class="sort-arrow"></span></th>
        <th data-col="price" onclick="sortBy('price')">Price <span class="sort-arrow"></span></th>
        <th data-col="confidence" onclick="sortBy('confidence')">Conf <span class="sort-arrow"></span></th>
        <th data-col="ai_score" onclick="sortBy('ai_score')">AI Score <span class="sort-arrow"></span></th>
        <th>Flags</th>
      </tr>
    </thead>
    <tbody id="event-table"></tbody>
  </table>
</div>

<!-- Detail Panel -->
<div class="detail-panel" id="detail-panel">
  <div class="detail-header">
    <h3 id="detail-title">Event Details</h3>
    <button class="detail-close" onclick="closeDetail()">&times;</button>
  </div>
  <pre class="detail-json" id="detail-json"></pre>
</div>

<script>
let allEvents = [];
let aiScores = {};  // event_id -> { score, flags, note }
let currentSort = { col: 'source_name', asc: true };
let selectedId = null;

// ========== Data Loading ==========

async function loadEvents() {
  setStatus('Loading events...');
  try {
    const res = await fetch('/api/eval/events');
    const data = await res.json();
    allEvents = data.events || [];
    updateSummary(data);
    populateNeighborhoodFilter();
    applyFilters();
    setStatus(`Loaded ${allEvents.length} events`);
  } catch (err) {
    setStatus('Failed to load events: ' + err.message);
  }
}

async function refreshCache() {
  const btn = document.getElementById('btn-refresh');
  btn.disabled = true;
  setStatus('Refreshing cache...');
  try {
    const res = await fetch('/api/eval/refresh', { method: 'POST' });
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    allEvents = data.events || [];
    aiScores = {};
    updateSummary(data);
    populateNeighborhoodFilter();
    applyFilters();
    setStatus(`Cache refreshed: ${allEvents.length} events`);
  } catch (err) {
    setStatus('Refresh failed: ' + err.message);
  }
  btn.disabled = false;
}

async function runScoring() {
  const btn = document.getElementById('btn-score');
  btn.disabled = true;
  setStatus(`Scoring ${allEvents.length} events with Claude...`);
  try {
    const res = await fetch('/api/eval/score', { method: 'POST' });
    const scores = await res.json();
    if (scores.error) throw new Error(scores.error);
    aiScores = {};
    for (const s of scores) {
      aiScores[s.event_id] = s;
    }
    applyFilters();
    setStatus(`Scored ${scores.length} events`);
  } catch (err) {
    setStatus('Scoring failed: ' + err.message);
  }
  btn.disabled = false;
}

// ========== Summary ==========

function updateSummary(data) {
  document.getElementById('total-count').textContent = (data.events || []).length;
  const ageMs = data.timestamp ? Date.now() - data.timestamp : null;
  document.getElementById('cache-age').textContent = ageMs
    ? Math.round(ageMs / 60000) + 'm ago'
    : 'never';

  const counts = { Skint: 0, RA: 0, Dice: 0, Eventbrite: 0, Songkick: 0 };
  for (const e of (data.events || [])) {
    const src = normalizeSource(e.source_name);
    if (counts[src] !== undefined) counts[src]++;
  }

  const pills = document.getElementById('source-pills');
  pills.innerHTML = '';
  for (const [src, count] of Object.entries(counts)) {
    const cls = 'source-' + src.toLowerCase();
    const pill = document.createElement('span');
    pill.className = 'source-pill ' + cls;
    pill.textContent = `${src}: ${count}`;
    pills.appendChild(pill);
  }
}

// ========== Filters & Sort ==========

function populateNeighborhoodFilter() {
  const sel = document.getElementById('f-neighborhood');
  const current = sel.value;
  const hoods = [...new Set(allEvents.map(e => e.neighborhood).filter(Boolean))].sort();
  sel.innerHTML = '<option value="">All</option>';
  for (const h of hoods) {
    const opt = document.createElement('option');
    opt.value = h; opt.textContent = h;
    sel.appendChild(opt);
  }
  sel.value = current;
}

function getClientFlags(e) {
  const flags = [];
  if (!e.venue_name || e.venue_name === 'TBA') flags.push('missing_venue');
  if (!e.neighborhood) flags.push('no_neighborhood');
  if (!e.start_time_local) {
    flags.push('no_time');
  } else if (e.start_time_local && !e.start_time_local.includes('T') && !e.start_time_local.includes(':')) {
    flags.push('no_time');
  }
  if (e.confidence != null && e.confidence < 0.5) flags.push('low_confidence');
  return flags;
}

function getAllFlags(e) {
  const client = getClientFlags(e);
  const ai = aiScores[e.id]?.flags || [];
  return [...new Set([...client, ...ai])];
}

function applyFilters() {
  const showSkint = document.getElementById('f-skint').checked;
  const showRA = document.getElementById('f-ra').checked;
  const showDice = document.getElementById('f-dice').checked;
  const showEB = document.getElementById('f-eventbrite').checked;
  const showSK = document.getElementById('f-songkick').checked;
  const hood = document.getElementById('f-neighborhood').value;
  const minScore = parseInt(document.getElementById('f-score').value);
  const flaggedOnly = document.getElementById('f-flagged').checked;

  let filtered = allEvents.filter(e => {
    const src = normalizeSource(e.source_name);
    if (src === 'Skint' && !showSkint) return false;
    if (src === 'RA' && !showRA) return false;
    if (src === 'Dice' && !showDice) return false;
    if (src === 'Eventbrite' && !showEB) return false;
    if (src === 'Songkick' && !showSK) return false;
    if (hood && e.neighborhood !== hood) return false;
    if (minScore > 0) {
      const s = aiScores[e.id]?.score;
      if (s == null || s < minScore) return false;
    }
    if (flaggedOnly && getAllFlags(e).length === 0) return false;
    return true;
  });

  // Sort
  filtered.sort((a, b) => {
    let va, vb;
    if (currentSort.col === 'ai_score') {
      va = aiScores[a.id]?.score ?? -1;
      vb = aiScores[b.id]?.score ?? -1;
    } else if (currentSort.col === 'confidence') {
      va = a.confidence ?? -1;
      vb = b.confidence ?? -1;
    } else if (currentSort.col === 'price') {
      va = a.is_free ? 'free' : (a.price_display || 'zzz');
      vb = b.is_free ? 'free' : (b.price_display || 'zzz');
    } else {
      va = (a[currentSort.col] || '').toString().toLowerCase();
      vb = (b[currentSort.col] || '').toString().toLowerCase();
    }
    if (va < vb) return currentSort.asc ? -1 : 1;
    if (va > vb) return currentSort.asc ? 1 : -1;
    return 0;
  });

  renderTable(filtered);
  updateSortArrows();
}

function sortBy(col) {
  if (currentSort.col === col) {
    currentSort.asc = !currentSort.asc;
  } else {
    currentSort = { col, asc: col === 'ai_score' || col === 'confidence' ? false : true };
  }
  applyFilters();
}

function updateSortArrows() {
  document.querySelectorAll('th').forEach(th => {
    const arrow = th.querySelector('.sort-arrow');
    if (!arrow) return;
    if (th.dataset.col === currentSort.col) {
      arrow.textContent = currentSort.asc ? ' \u25B2' : ' \u25BC';
    } else {
      arrow.textContent = '';
    }
  });
}

// ========== Rendering ==========

function renderTable(events) {
  const tbody = document.getElementById('event-table');
  tbody.innerHTML = '';

  for (const e of events) {
    const tr = document.createElement('tr');
    const flags = getAllFlags(e);
    if (flags.length > 0) tr.classList.add('flagged');
    if (e.id === selectedId) tr.classList.add('selected');
    tr.onclick = () => showDetail(e);

    const src = normalizeSource(e.source_name);
    const srcClass = 'source-' + src.toLowerCase();
    const aiScore = aiScores[e.id]?.score;

    tr.innerHTML = `
      <td><span class="badge ${srcClass}">${src}</span></td>
      <td title="${esc(e.name || '')}">${nameLink(e)}</td>
      <td>${venueCell(e)}</td>
      <td>${e.neighborhood ? esc(e.neighborhood) : '<span style="color:#fc8181">—</span>'}</td>
      <td>${timeCell(e)}</td>
      <td>${esc(e.category || '—')}</td>
      <td>${priceCell(e)}</td>
      <td>${confidenceCell(e)}</td>
      <td>${scoreCell(aiScore)}</td>
      <td>${flagCells(flags)}</td>
    `;
    tbody.appendChild(tr);
  }
}

function nameLink(e) {
  const name = esc(e.name || '—');
  const url = e.ticket_url || e.source_url;
  if (url) return `<a href="${esc(url)}" target="_blank" rel="noopener" style="color:#93c5fd;text-decoration:none;" onclick="event.stopPropagation()">${name}</a>`;
  return name;
}

function venueCell(e) {
  if (!e.venue_name || e.venue_name === 'TBA') return '<span style="color:#fc8181">TBA</span>';
  return esc(e.venue_name);
}

function timeCell(e) {
  if (!e.start_time_local) {
    if (e.date_local) return `<span style="color:#f6e05e">${esc(e.date_local)}</span>`;
    return '<span style="color:#fc8181">—</span>';
  }
  return formatTimeDisplay(e.start_time_local);
}

function formatTimeDisplay(val) {
  // Bare date (no time) — parse as local components to avoid UTC midnight shift
  if (!/T|:/.test(val)) {
    try {
      const [y, m, d] = val.split('-').map(Number);
      if (y && m && d) return new Date(y, m - 1, d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    } catch {}
    return esc(val);
  }
  try {
    const d = new Date(val);
    if (isNaN(d)) return esc(val);
    return d.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
  } catch { return esc(val); }
}

function priceCell(e) {
  if (e.is_free) return '<span style="color:#68d391">Free</span>';
  return esc(e.price_display || '—');
}

function confidenceCell(e) {
  if (e.confidence == null) return '—';
  const pct = Math.round(e.confidence * 100);
  const color = e.confidence >= 0.7 ? '#68d391' : e.confidence >= 0.5 ? '#f6e05e' : '#fc8181';
  return `<span class="confidence-bar"><span class="confidence-fill" style="width:${pct}%;background:${color}"></span></span> <span style="font-size:11px;color:${color}">${e.confidence.toFixed(2)}</span>`;
}

function scoreCell(score) {
  if (score == null) return '<span style="color:#555">—</span>';
  const cls = score >= 7 ? 'score-high' : score >= 4 ? 'score-mid' : 'score-low';
  return `<span class="score-cell ${cls}">${score}</span>`;
}

function flagCells(flags) {
  if (flags.length === 0) return '';
  return flags.map(f => {
    const warn = ['low_confidence', 'no_time'].includes(f);
    return `<span class="flag-badge${warn ? ' warn' : ''}">${f.replace(/_/g, ' ')}</span>`;
  }).join('');
}

// ========== Detail Panel ==========

function showDetail(e) {
  selectedId = e.id;
  document.getElementById('detail-title').textContent = e.name || 'Event Details';
  const combined = { ...e };
  if (aiScores[e.id]) combined._ai_eval = aiScores[e.id];
  combined._client_flags = getClientFlags(e);
  document.getElementById('detail-json').textContent = JSON.stringify(combined, null, 2);
  document.getElementById('detail-panel').classList.add('open');
  // Re-render to show selected highlight
  applyFilters();
}

function closeDetail() {
  selectedId = null;
  document.getElementById('detail-panel').classList.remove('open');
  applyFilters();
}

// ========== Helpers ==========

function normalizeSource(name) {
  if (!name) return 'Unknown';
  const n = name.toLowerCase();
  if (n.includes('skint')) return 'Skint';
  if (n === 'ra') return 'RA';
  if (n === 'dice') return 'Dice';
  if (n.includes('eventbrite')) return 'Eventbrite';
  if (n.includes('songkick')) return 'Songkick';
  return name;
}

function esc(s) {
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

function setStatus(msg) {
  document.getElementById('status-msg').textContent = msg;
}

// ========== Simulate ==========

function populateSimNeighborhoods() {
  const sel = document.getElementById('sim-neighborhood');
  const hoods = [
    'Astoria', 'Bed-Stuy', 'Bushwick', 'Chelsea', 'Crown Heights',
    'Downtown Brooklyn', 'DUMBO', 'East Village', 'Financial District',
    'Flatiron', 'Greenpoint', 'Greenwich Village', "Hell's Kitchen",
    'Harlem', 'Long Island City', 'Lower East Side', 'Midtown', 'NoHo',
    'Park Slope', 'SoHo', 'Tribeca', 'Upper East Side', 'Upper West Side',
    'West Village', 'Williamsburg'
  ];
  for (const h of hoods) {
    const opt = document.createElement('option');
    opt.value = h; opt.textContent = h;
    sel.appendChild(opt);
  }
}

async function runSimulate() {
  const hood = document.getElementById('sim-neighborhood').value;
  if (!hood) { setSimStatus('Select a neighborhood first'); return; }

  const btn = document.getElementById('btn-simulate');
  btn.disabled = true;
  setSimStatus('Simulating ' + hood + '...');

  try {
    const res = await fetch('/api/eval/simulate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ neighborhood: hood }),
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    renderSimResults(data);
    setSimStatus('');
  } catch (err) {
    setSimStatus('Simulate failed: ' + err.message);
    document.getElementById('sim-results').classList.remove('open');
  }
  btn.disabled = false;
}

function renderSimResults(data) {
  document.getElementById('sim-results').classList.add('open');

  // Funnel stats
  const funnel = document.getElementById('sim-funnel');
  funnel.innerHTML = `
    <span class="funnel-step"><span class="funnel-num">${data.candidates.length}</span> in proximity</span>
    <span class="funnel-arrow">&rarr;</span>
    <span class="funnel-step"><span class="funnel-num">${data.sent_to_claude.length}</span> sent to Claude</span>
    <span class="funnel-arrow">&rarr;</span>
    <span class="funnel-step"><span class="funnel-num">${data.picked.length}</span> picked</span>
  `;

  // SMS bubble
  document.getElementById('sim-sms').textContent = data.compose_result.sms_text;

  // Picked table
  const pickedTbody = document.getElementById('sim-picked');
  pickedTbody.innerHTML = '';
  const picks = data.compose_result.picks || [];
  for (const event of data.picked) {
    const pick = picks.find(p => p.event_id === event.id);
    const tr = document.createElement('tr');
    tr.className = 'picked-row';
    tr.innerHTML = `
      <td>${pick ? pick.rank : '—'}</td>
      <td title="${esc(event.name || '')}">${nameLink(event)}</td>
      <td>${esc(event.venue_name || '—')}</td>
      <td>${simTimeCell(event)}</td>
      <td>${esc(event.source_name || '—')}</td>
    `;
    pickedTbody.appendChild(tr);
  }

  // Not picked table
  const notPickedTbody = document.getElementById('sim-notpicked');
  notPickedTbody.innerHTML = '';
  for (const event of data.not_picked) {
    const tr = document.createElement('tr');
    tr.className = 'notpicked-row';
    tr.innerHTML = `
      <td title="${esc(event.name || '')}">${nameLink(event)}</td>
      <td>${esc(event.venue_name || '—')}</td>
      <td>${simTimeCell(event)}</td>
      <td>${esc(event.source_name || '—')}</td>
    `;
    notPickedTbody.appendChild(tr);
  }

  // Candidates table (hidden by default)
  const candTbody = document.getElementById('sim-candidates');
  candTbody.innerHTML = '';
  data.candidates.forEach((event, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td title="${esc(event.name || '')}">${nameLink(event)}</td>
      <td>${esc(event.venue_name || '—')}</td>
      <td>${esc(event.neighborhood || '—')}</td>
      <td>${simTimeCell(event)}</td>
      <td>${esc(event.source_name || '—')}</td>
    `;
    candTbody.appendChild(tr);
  });

  // Reset expand state
  document.getElementById('sim-candidates-section').style.display = 'none';
  document.getElementById('sim-expand-btn').textContent = 'Show all candidates';
}

function toggleCandidates() {
  const section = document.getElementById('sim-candidates-section');
  const btn = document.getElementById('sim-expand-btn');
  if (section.style.display === 'none') {
    section.style.display = 'block';
    btn.textContent = 'Hide candidates';
  } else {
    section.style.display = 'none';
    btn.textContent = 'Show all candidates';
  }
}

function simTimeCell(e) {
  if (!e.start_time_local) {
    if (e.date_local) return esc(e.date_local);
    return '—';
  }
  return formatTimeDisplay(e.start_time_local);
}

function setSimStatus(msg) {
  document.getElementById('sim-status').textContent = msg;
}

// Keyboard shortcut: Escape closes detail panel
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeDetail();
});

// Init
populateSimNeighborhoods();
loadEvents();
</script>
</body>
</html>
