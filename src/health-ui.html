<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pulse Health Dashboard</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
    background: #0a0a0a;
    color: #e0e0e0;
    min-height: 100vh;
    padding: 24px;
  }

  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .header h1 {
    font-size: 24px;
    font-weight: 700;
    color: #fff;
  }

  .header h1 span { color: #FF6B35; }

  .header-right {
    display: flex;
    align-items: center;
    gap: 16px;
    font-size: 13px;
    color: #888;
  }

  .status-pill {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .status-pill.ok { background: #1a3a1a; color: #4ade80; }
  .status-pill.degraded { background: #3a2a0a; color: #fbbf24; }
  .status-pill.critical { background: #3a1a1a; color: #f87171; }
  .status-pill.pending { background: #1a1a2a; color: #60a5fa; }

  .summary-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 24px;
  }

  .summary-card {
    background: #141414;
    border: 1px solid #222;
    border-radius: 10px;
    padding: 16px;
  }

  .summary-card .label {
    font-size: 11px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }

  .summary-card .value {
    font-size: 28px;
    font-weight: 700;
    color: #fff;
  }

  .summary-card .sub {
    font-size: 12px;
    color: #666;
    margin-top: 2px;
  }

  .timing-section {
    margin-bottom: 24px;
  }

  .timing-section h2 {
    font-size: 16px;
    font-weight: 600;
    color: #aaa;
    margin-bottom: 12px;
  }

  .timing-bar-container {
    background: #141414;
    border: 1px solid #222;
    border-radius: 10px;
    padding: 16px;
  }

  .timing-bar-row {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
    gap: 8px;
  }

  .timing-bar-row:last-child { margin-bottom: 0; }

  .timing-bar-label {
    width: 130px;
    font-size: 12px;
    color: #aaa;
    text-align: right;
    flex-shrink: 0;
  }

  .timing-bar-track {
    flex: 1;
    height: 18px;
    background: #1a1a1a;
    border-radius: 4px;
    overflow: hidden;
    position: relative;
  }

  .timing-bar-fill {
    height: 100%;
    border-radius: 4px;
    min-width: 2px;
    transition: width 0.3s ease;
  }

  .timing-bar-fill.ok { background: linear-gradient(90deg, #22c55e, #4ade80); }
  .timing-bar-fill.empty { background: linear-gradient(90deg, #ca8a04, #fbbf24); }
  .timing-bar-fill.error, .timing-bar-fill.timeout { background: linear-gradient(90deg, #dc2626, #f87171); }

  .timing-bar-value {
    width: 60px;
    font-size: 11px;
    color: #666;
    flex-shrink: 0;
  }

  .source-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 12px;
  }

  .source-card {
    background: #141414;
    border: 1px solid #222;
    border-radius: 10px;
    padding: 16px;
    transition: border-color 0.2s;
  }

  .source-card:hover { border-color: #444; }
  .source-card.status-ok { border-left: 3px solid #4ade80; }
  .source-card.status-empty { border-left: 3px solid #fbbf24; }
  .source-card.status-error { border-left: 3px solid #f87171; }
  .source-card.status-timeout { border-left: 3px solid #f87171; }
  .source-card.status-null { border-left: 3px solid #444; }

  .source-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .source-card-name {
    font-size: 15px;
    font-weight: 600;
    color: #fff;
  }

  .badge {
    padding: 2px 8px;
    border-radius: 8px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .badge.ok { background: #1a3a1a; color: #4ade80; }
  .badge.empty { background: #3a2a0a; color: #fbbf24; }
  .badge.error { background: #3a1a1a; color: #f87171; }
  .badge.timeout { background: #3a1a1a; color: #f87171; }
  .badge.none { background: #1a1a1a; color: #555; }

  .source-card-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 12px;
  }

  .source-card-stat {
    font-size: 12px;
  }

  .source-card-stat .stat-label {
    color: #555;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .source-card-stat .stat-value {
    color: #ccc;
    font-weight: 600;
    font-size: 14px;
  }

  .source-card-stat .stat-value.warn { color: #fbbf24; }
  .source-card-stat .stat-value.danger { color: #f87171; }

  .source-card-error {
    font-size: 11px;
    color: #f87171;
    background: #1a0a0a;
    border-radius: 6px;
    padding: 6px 8px;
    margin-bottom: 8px;
    word-break: break-all;
    max-height: 48px;
    overflow: hidden;
  }

  .sparkline-container {
    height: 32px;
    display: flex;
    align-items: flex-end;
    gap: 3px;
  }

  .sparkline-bar {
    flex: 1;
    border-radius: 2px 2px 0 0;
    min-height: 2px;
    position: relative;
  }

  .sparkline-bar.ok { background: #4ade80; }
  .sparkline-bar.empty { background: #fbbf24; }
  .sparkline-bar.error, .sparkline-bar.timeout { background: #f87171; }

  .sparkline-bar .tip {
    display: none;
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: #fff;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    white-space: nowrap;
    margin-bottom: 4px;
    z-index: 10;
  }

  .sparkline-bar:hover .tip { display: block; }

  .no-data {
    color: #444;
    font-size: 12px;
    font-style: italic;
    text-align: center;
    padding: 8px 0;
  }

  .audit-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 12px;
  }

  .audit-card {
    background: #141414;
    border: 1px solid #222;
    border-radius: 10px;
    padding: 16px;
  }

  .audit-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .audit-card-name {
    font-size: 14px;
    font-weight: 600;
    color: #fff;
  }

  .audit-card-rate {
    font-size: 20px;
    font-weight: 700;
  }

  .audit-card-rate.good { color: #4ade80; }
  .audit-card-rate.warn { color: #fbbf24; }
  .audit-card-rate.bad { color: #f87171; }

  .audit-card-detail {
    font-size: 11px;
    color: #666;
    margin-top: 4px;
  }

  .audit-failures {
    margin-top: 6px;
    font-size: 11px;
    color: #f87171;
  }

  .refresh-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #4ade80;
    margin-right: 6px;
    animation: pulse-dot 2s ease-in-out infinite;
  }

  @keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* Mobile */
  @media (max-width: 600px) {
    body { padding: 12px; }

    .header { flex-direction: column; align-items: flex-start; gap: 8px; }
    .header h1 { font-size: 20px; }

    .summary-row { grid-template-columns: 1fr; }
    .summary-card .value { font-size: 22px; }

    .timing-bar-label { width: 80px; font-size: 11px; }
    .timing-bar-value { width: 45px; font-size: 10px; }

    .source-grid { grid-template-columns: 1fr; }

    .audit-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div class="header">
  <h1><span>Pulse</span> Health Dashboard</h1>
  <div class="header-right">
    <span><span class="refresh-indicator"></span>Auto-refresh 60s</span>
    <span id="system-status" class="status-pill pending">loading</span>
  </div>
</div>

<div class="summary-row" id="summary-row"></div>

<div class="timing-section">
  <h2>Scrape Timing</h2>
  <div class="timing-bar-container" id="timing-bars">
    <div class="no-data">No scrape data yet</div>
  </div>
</div>

<div class="timing-section">
  <h2>Extraction Quality</h2>
  <div id="extraction-quality">
    <div class="no-data">Loading audit data...</div>
  </div>
</div>

<h2 style="font-size:16px;font-weight:600;color:#aaa;margin-bottom:12px;">Sources</h2>
<div class="source-grid" id="source-grid"></div>

<script>
const $ = id => document.getElementById(id);

function fmtDuration(ms) {
  if (ms == null) return '--';
  if (ms < 1000) return ms + 'ms';
  return (ms / 1000).toFixed(1) + 's';
}

function fmtAge(mins) {
  if (mins == null) return '--';
  if (mins < 60) return mins + 'm ago';
  return (mins / 60).toFixed(1) + 'h ago';
}

function fmtTime(iso) {
  if (!iso) return '--';
  const d = new Date(iso);
  return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', timeZone: 'America/New_York' });
}

function renderSummary(data) {
  const pill = $('system-status');
  pill.textContent = data.status;
  pill.className = 'status-pill ' + data.status;

  const cards = [
    { label: 'Cache Size', value: data.cache.size, sub: data.cache.fresh ? fmtAge(data.cache.age_minutes) : 'empty' },
    { label: 'Scrape Duration', value: fmtDuration(data.scrape.totalDurationMs), sub: data.scrape.completedAt ? fmtTime(data.scrape.completedAt) : 'no scrape' },
    { label: 'Sources OK', value: data.scrape.sourcesOk, sub: data.scrape.sourcesFailed ? data.scrape.sourcesFailed + ' failed' : 'all healthy' },
    { label: 'Events (raw)', value: data.scrape.totalEvents, sub: data.scrape.dedupedEvents + ' after dedup' },
  ];

  $('summary-row').innerHTML = cards.map(c => `
    <div class="summary-card">
      <div class="label">${c.label}</div>
      <div class="value">${c.value}</div>
      <div class="sub">${c.sub}</div>
    </div>
  `).join('');
}

function renderTimingBars(sources) {
  const entries = Object.entries(sources)
    .filter(([, s]) => s.duration_ms != null)
    .sort((a, b) => (b[1].duration_ms || 0) - (a[1].duration_ms || 0));

  if (entries.length === 0) {
    $('timing-bars').innerHTML = '<div class="no-data">No scrape data yet</div>';
    return;
  }

  const maxMs = Math.max(...entries.map(([, s]) => s.duration_ms || 0), 1);

  $('timing-bars').innerHTML = entries.map(([name, s]) => {
    const pct = Math.max(((s.duration_ms || 0) / maxMs) * 100, 1);
    const status = s.status || 'ok';
    return `
      <div class="timing-bar-row">
        <div class="timing-bar-label">${name}</div>
        <div class="timing-bar-track">
          <div class="timing-bar-fill ${status}" style="width:${pct}%"></div>
        </div>
        <div class="timing-bar-value">${fmtDuration(s.duration_ms)}</div>
      </div>
    `;
  }).join('');
}

function renderSourceCards(sources) {
  const grid = $('source-grid');
  const entries = Object.entries(sources);

  grid.innerHTML = entries.map(([name, s]) => {
    const status = s.status || 'null';
    const httpBadge = s.http_status
      ? (s.http_status < 400 ? s.http_status : `<span style="color:#f87171">${s.http_status}</span>`)
      : '--';
    const czClass = s.consecutive_zeros >= 3 ? 'danger' : s.consecutive_zeros >= 1 ? 'warn' : '';
    const sparkline = renderSparkline(s.history);

    return `
      <div class="source-card status-${status}">
        <div class="source-card-header">
          <div class="source-card-name">${name}</div>
          <span class="badge ${status}">${status === 'null' ? 'no data' : status}</span>
        </div>
        <div class="source-card-stats">
          <div class="source-card-stat">
            <div class="stat-label">Events</div>
            <div class="stat-value">${s.last_count ?? '--'}</div>
          </div>
          <div class="source-card-stat">
            <div class="stat-label">Duration</div>
            <div class="stat-value">${fmtDuration(s.duration_ms)}</div>
          </div>
          <div class="source-card-stat">
            <div class="stat-label">HTTP</div>
            <div class="stat-value">${httpBadge}</div>
          </div>
          <div class="source-card-stat">
            <div class="stat-label">Success Rate</div>
            <div class="stat-value">${s.success_rate || '--'}</div>
          </div>
          <div class="source-card-stat">
            <div class="stat-label">Zero Streak</div>
            <div class="stat-value ${czClass}">${s.consecutive_zeros}</div>
          </div>
          <div class="source-card-stat">
            <div class="stat-label">Last Scrape</div>
            <div class="stat-value" style="font-size:11px">${fmtTime(s.last_scrape)}</div>
          </div>
        </div>
        ${s.last_error ? `<div class="source-card-error">${escHtml(s.last_error)}</div>` : ''}
        ${sparkline}
      </div>
    `;
  }).join('');
}

function renderSparkline(history) {
  if (!history || history.length === 0) {
    return '<div class="no-data">no history</div>';
  }

  const maxCount = Math.max(...history.map(h => h.count), 1);

  const bars = history.map(h => {
    const heightPct = Math.max((h.count / maxCount) * 100, 6);
    return `<div class="sparkline-bar ${h.status}" style="height:${heightPct}%">
      <div class="tip">${h.count} events, ${fmtDuration(h.durationMs)}</div>
    </div>`;
  }).join('');

  return `<div class="sparkline-container">${bars}</div>`;
}

function escHtml(str) {
  const el = document.createElement('span');
  el.textContent = str;
  return el.innerHTML;
}

function renderExtractionQuality(audit) {
  const container = $('extraction-quality');
  if (!audit || audit.error || !audit.sourceStats) {
    container.innerHTML = '<div class="timing-bar-container"><div class="no-data">No audit data yet â€” run a scrape first</div></div>';
    return;
  }

  const entries = Object.entries(audit.sourceStats);
  if (entries.length === 0) {
    container.innerHTML = '<div class="timing-bar-container"><div class="no-data">No Claude-extracted events in cache</div></div>';
    return;
  }

  const summaryHtml = `
    <div class="summary-row" style="margin-bottom:12px">
      <div class="summary-card">
        <div class="label">Events Audited</div>
        <div class="value">${audit.summary.total}</div>
        <div class="sub">${audit.summary.passed} passed</div>
      </div>
      <div class="summary-card">
        <div class="label">Pass Rate</div>
        <div class="value">${audit.summary.passRate}</div>
        <div class="sub">${audit.summary.issues} issues</div>
      </div>
      <div class="summary-card">
        <div class="label">Audit Time</div>
        <div class="value" style="font-size:14px">${fmtTime(audit.timestamp)}</div>
        <div class="sub">${audit.tier || 'deterministic'}</div>
      </div>
    </div>
  `;

  const cardsHtml = entries.map(([source, stats]) => {
    const rate = stats.total > 0 ? (stats.passed / stats.total * 100) : 0;
    const rateClass = rate >= 90 ? 'good' : rate >= 70 ? 'warn' : 'bad';
    const failureEntries = Object.entries(stats.failures || {}).sort((a, b) => b[1] - a[1]);
    const failureHtml = failureEntries.length > 0
      ? `<div class="audit-failures">${failureEntries.map(([name, count]) => `${name}: ${count}`).join(', ')}</div>`
      : '';

    return `
      <div class="audit-card">
        <div class="audit-card-header">
          <div class="audit-card-name">${source}</div>
          <div class="audit-card-rate ${rateClass}">${rate.toFixed(0)}%</div>
        </div>
        <div class="audit-card-detail">${stats.passed}/${stats.total} events pass</div>
        ${failureHtml}
      </div>
    `;
  }).join('');

  container.innerHTML = summaryHtml + `<div class="audit-grid">${cardsHtml}</div>`;
}

async function refreshAudit() {
  try {
    const res = await fetch('/api/eval/audit');
    if (res.ok) {
      const data = await res.json();
      renderExtractionQuality(data);
    } else {
      renderExtractionQuality(null);
    }
  } catch {
    renderExtractionQuality(null);
  }
}

async function refresh() {
  try {
    const res = await fetch('/health?json=1');
    const data = await res.json();
    renderSummary(data);
    renderTimingBars(data.sources);
    renderSourceCards(data.sources);
  } catch (err) {
    console.error('Health fetch failed:', err);
  }
}

refresh();
refreshAudit();
setInterval(refresh, 60000);
setInterval(refreshAudit, 60000);
</script>
</body>
</html>
