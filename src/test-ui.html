<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pulse SMS Simulator</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
    background: #000;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .phone {
    width: 390px;
    height: 844px;
    background: #000;
    border-radius: 47px;
    border: 3px solid #333;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
    box-shadow: 0 0 0 2px #1a1a1a, 0 20px 60px rgba(0,0,0,0.5);
  }

  .notch {
    width: 126px;
    height: 34px;
    background: #000;
    border-radius: 0 0 20px 20px;
    margin: 0 auto;
    position: relative;
    z-index: 10;
  }

  .status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 24px 0;
    font-size: 15px;
    font-weight: 600;
    color: #fff;
    height: 54px;
  }

  .status-bar .time { margin-left: 4px; }
  .status-bar .icons { display: flex; gap: 5px; font-size: 13px; }

  .header {
    display: flex;
    align-items: center;
    padding: 6px 16px 10px;
    border-bottom: 0.5px solid #2a2a2a;
    gap: 10px;
  }

  .header .back { color: #007AFF; font-size: 28px; font-weight: 300; }

  .header .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #FF6B35, #F7C948);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
  }

  .header .contact {
    flex: 1;
  }

  .header .contact .name {
    color: #fff;
    font-size: 16px;
    font-weight: 600;
  }

  .header .contact .number {
    color: #8e8e93;
    font-size: 12px;
  }

  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 12px 16px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    scrollbar-width: none;
  }

  .messages::-webkit-scrollbar { display: none; }

  .msg {
    max-width: 78%;
    padding: 9px 14px;
    border-radius: 18px;
    font-size: 16px;
    line-height: 1.35;
    word-wrap: break-word;
    white-space: pre-wrap;
    animation: fadeIn 0.2s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .msg.sent {
    align-self: flex-end;
    background: #007AFF;
    color: #fff;
    border-bottom-right-radius: 4px;
  }

  .msg.received {
    align-self: flex-start;
    background: #2a2a2e;
    color: #fff;
    border-bottom-left-radius: 4px;
  }

  .msg.system {
    align-self: center;
    background: none;
    color: #8e8e93;
    font-size: 12px;
    text-align: center;
    padding: 4px 0;
  }

  .msg .meta {
    font-size: 11px;
    color: rgba(255,255,255,0.5);
    margin-top: 4px;
  }

  .msg.received .meta { color: #8e8e93; }

  .typing-indicator {
    align-self: flex-start;
    background: #2a2a2e;
    border-radius: 18px;
    border-bottom-left-radius: 4px;
    padding: 12px 18px;
    display: none;
    gap: 4px;
  }

  .typing-indicator.active { display: flex; }

  .typing-indicator span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #8e8e93;
    animation: typing 1.4s infinite;
  }

  .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
  .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes typing {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
    30% { transform: translateY(-4px); opacity: 1; }
  }

  .input-area {
    padding: 8px 12px 34px;
    display: flex;
    align-items: flex-end;
    gap: 8px;
    border-top: 0.5px solid #2a2a2a;
  }

  .input-area textarea {
    flex: 1;
    background: #1c1c1e;
    border: 0.5px solid #3a3a3c;
    border-radius: 20px;
    padding: 10px 16px;
    color: #fff;
    font-size: 16px;
    font-family: inherit;
    resize: none;
    outline: none;
    max-height: 100px;
    line-height: 1.35;
    rows: 1;
  }

  .input-area textarea::placeholder { color: #636366; }

  .send-btn {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    background: #007AFF;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: opacity 0.15s;
  }

  .send-btn:disabled { opacity: 0.3; cursor: default; }

  .send-btn svg { width: 17px; height: 17px; fill: #fff; }

  .home-indicator {
    width: 134px;
    height: 5px;
    background: #fff;
    border-radius: 3px;
    margin: 0 auto;
    position: absolute;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    opacity: 0.3;
  }

  @media (max-width: 420px) {
    .phone {
      width: 100%;
      height: 100vh;
      height: 100dvh;
      border-radius: 0;
      border: none;
      box-shadow: none;
    }
    .notch { display: none; }
    .status-bar { display: none; }
    .input-area { padding-bottom: env(safe-area-inset-bottom, 34px); }
  }
</style>
</head>
<body>

<div class="phone">
  <div class="notch"></div>
  <div class="status-bar">
    <span class="time" id="clock"></span>
    <span class="icons">
      <span>&#9679;&#9679;&#9679;&#9679;</span>
      <span>5G</span>
      <span>&#128267;</span>
    </span>
  </div>

  <div class="header">
    <span class="back">&#8249;</span>
    <div class="avatar">&#x26A1;</div>
    <div class="contact">
      <div class="name">Pulse</div>
      <div class="number">+1 (646) 722-6926</div>
    </div>
  </div>

  <div class="messages" id="messages">
    <div class="msg system">SMS Simulator &mdash; messages hit the live pipeline</div>
    <div class="msg received">Hey! I'm Pulse â€” text me a neighborhood and I'll send you tonight's best picks. Try "East Village" or "Williamsburg" to start. You can ask for free events, specific vibes like comedy or live music, or reply "more" after any rec to keep exploring.</div>
  </div>

  <div class="typing-indicator" id="typing">
    <span></span><span></span><span></span>
  </div>

  <div class="input-area">
    <textarea id="input" placeholder="Text Message" rows="1"></textarea>
    <button class="send-btn" id="sendBtn" disabled>
      <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    </button>
  </div>

  <div class="home-indicator"></div>
</div>

<script>
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const typingEl = document.getElementById('typing');
const clockEl = document.getElementById('clock');

const SESSION_PHONE = '+1555' + String(Math.floor(Math.random() * 9000000 + 1000000));

function updateClock() {
  const now = new Date();
  clockEl.textContent = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
}
updateClock();
setInterval(updateClock, 10000);

function linkify(text) {
  // Escape HTML first to prevent XSS, then linkify URLs
  const escaped = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  return escaped.replace(/https?:\/\/[^\s)]+/g, url => `<a href="${url}" target="_blank" style="color:#5ac8fa;text-decoration:underline">${url}</a>`);
}

function addMessage(text, type, meta) {
  const div = document.createElement('div');
  div.className = 'msg ' + type;
  div.innerHTML = linkify(text);
  if (meta) {
    const metaEl = document.createElement('div');
    metaEl.className = 'meta';
    metaEl.textContent = meta;
    div.appendChild(metaEl);
  }
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function autoResize() {
  inputEl.style.height = 'auto';
  inputEl.style.height = Math.min(inputEl.scrollHeight, 100) + 'px';
}

inputEl.addEventListener('input', () => {
  sendBtn.disabled = !inputEl.value.trim();
  autoResize();
});

inputEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    if (inputEl.value.trim()) send();
  }
});

sendBtn.addEventListener('click', send);

async function send() {
  const text = inputEl.value.trim();
  if (!text) return;

  inputEl.value = '';
  inputEl.style.height = 'auto';
  sendBtn.disabled = true;

  addMessage(text, 'sent');

  typingEl.classList.add('active');
  messagesEl.scrollTop = messagesEl.scrollHeight;

  const start = Date.now();

  try {
    const res = await fetch('/api/sms/test', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: 'Body=' + encodeURIComponent(text) + '&From=' + encodeURIComponent(SESSION_PHONE),
    });

    const data = await res.json();
    const elapsed = ((Date.now() - start) / 1000).toFixed(1);

    typingEl.classList.remove('active');

    if (data.ok && data.messages?.length > 0) {
      for (const msg of data.messages) {
        addMessage(msg.body, 'received', elapsed + 's');
      }
    } else if (data.error) {
      addMessage('Error: ' + data.error, 'system');
    } else {
      addMessage('(no response)', 'system');
    }
  } catch (err) {
    typingEl.classList.remove('active');
    addMessage('Connection error: ' + err.message, 'system');
  }
}

inputEl.focus();
</script>

</body>
</html>
