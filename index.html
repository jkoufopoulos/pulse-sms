<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pulse SMS — Architecture Explorer</title>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --surface2: #1c2333;
    --border: #30363d;
    --text: #c9d1d9;
    --text-muted: #8b949e;
    --accent: #58a6ff;
    --accent2: #3fb950;
    --accent3: #d2a8ff;
    --accent4: #f0883e;
    --accent5: #ff7b72;
    --accent6: #79c0ff;
    --code-bg: #0d1117;
    --prompt-bg: #1a1e2e;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
  }
  a { color: var(--accent); text-decoration: none; }
  a:hover { text-decoration: underline; }

  /* --- NAV --- */
  .nav {
    position: sticky; top: 0; z-index: 100;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 12px 24px;
    display: flex; align-items: center; gap: 24px;
    overflow-x: auto;
  }
  .nav-title {
    font-weight: 700; font-size: 16px; white-space: nowrap;
    color: var(--accent);
  }
  .nav a {
    font-size: 13px; color: var(--text-muted); white-space: nowrap;
    padding: 4px 8px; border-radius: 6px; transition: all 0.15s;
  }
  .nav a:hover { color: var(--text); background: var(--surface2); text-decoration: none; }
  .nav a.active { color: var(--accent); background: rgba(88,166,255,0.1); }

  /* --- MAIN --- */
  .main { max-width: 1200px; margin: 0 auto; padding: 32px 24px 80px; }
  h1 { font-size: 28px; margin-bottom: 8px; }
  h2 {
    font-size: 22px; margin: 48px 0 16px;
    padding-bottom: 8px; border-bottom: 1px solid var(--border);
    color: var(--accent);
  }
  h3 { font-size: 17px; margin: 24px 0 8px; color: var(--accent3); }
  h4 { font-size: 14px; margin: 16px 0 4px; color: var(--accent4); text-transform: uppercase; letter-spacing: 0.5px; }
  p { margin-bottom: 12px; }
  .subtitle { color: var(--text-muted); font-size: 15px; margin-bottom: 32px; }

  /* --- CARDS --- */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 16px;
  }
  .card-header {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 12px; cursor: pointer; user-select: none;
  }
  .card-header .arrow {
    font-size: 12px; transition: transform 0.2s; color: var(--text-muted);
  }
  .card-header.collapsed .arrow { transform: rotate(-90deg); }
  .card-header h3 { margin: 0; }
  .card-body { }
  .card-body.hidden { display: none; }

  /* --- FLOW DIAGRAMS --- */
  .flow {
    display: flex; align-items: stretch; gap: 0;
    overflow-x: auto; padding: 16px 0; margin: 16px 0;
  }
  .flow-step {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    min-width: 160px;
    max-width: 220px;
    flex-shrink: 0;
    position: relative;
  }
  .flow-step.llm {
    border-color: var(--accent3);
    background: rgba(210,168,255,0.08);
  }
  .flow-step.data {
    border-color: var(--accent2);
    background: rgba(63,185,80,0.08);
  }
  .flow-step.logic {
    border-color: var(--accent4);
    background: rgba(240,136,62,0.08);
  }
  .flow-step .step-label {
    font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;
    color: var(--text-muted); margin-bottom: 4px;
  }
  .flow-step .step-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
  .flow-step .step-file { font-size: 11px; color: var(--text-muted); font-family: monospace; }
  .flow-step .step-detail { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
  .flow-arrow {
    display: flex; align-items: center; justify-content: center;
    padding: 0 4px; color: var(--text-muted); font-size: 18px; flex-shrink: 0;
  }

  /* --- PROMPT BLOCKS --- */
  .prompt-block {
    background: var(--prompt-bg);
    border: 1px solid var(--border);
    border-left: 3px solid var(--accent3);
    border-radius: 0 8px 8px 0;
    margin: 12px 0;
    overflow: hidden;
  }
  .prompt-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 16px;
    background: rgba(210,168,255,0.06);
    cursor: pointer; user-select: none;
  }
  .prompt-header .prompt-name { font-weight: 600; font-size: 14px; color: var(--accent3); }
  .prompt-header .prompt-meta { font-size: 12px; color: var(--text-muted); }
  .prompt-content {
    padding: 16px;
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    font-size: 12px;
    line-height: 1.7;
    white-space: pre-wrap;
    word-break: break-word;
    color: var(--text);
    max-height: 600px;
    overflow-y: auto;
  }
  .prompt-content.hidden { display: none; }

  /* --- TABLES --- */
  table {
    width: 100%; border-collapse: collapse; margin: 12px 0;
    font-size: 13px;
  }
  th, td {
    padding: 8px 12px; text-align: left;
    border-bottom: 1px solid var(--border);
  }
  th {
    font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;
    color: var(--text-muted); background: var(--surface2);
    position: sticky; top: 0;
  }
  td { color: var(--text); }
  td code {
    font-size: 12px; padding: 2px 6px;
    background: var(--code-bg); border-radius: 3px;
    border: 1px solid var(--border);
  }
  tr:hover td { background: rgba(88,166,255,0.04); }

  /* --- BADGES --- */
  .badge {
    display: inline-block; padding: 2px 8px; border-radius: 12px;
    font-size: 11px; font-weight: 600;
  }
  .badge-llm { background: rgba(210,168,255,0.15); color: var(--accent3); }
  .badge-data { background: rgba(63,185,80,0.15); color: var(--accent2); }
  .badge-logic { background: rgba(240,136,62,0.15); color: var(--accent4); }
  .badge-io { background: rgba(88,166,255,0.15); color: var(--accent); }
  .badge-error { background: rgba(255,123,114,0.15); color: var(--accent5); }

  /* --- METRIC GRID --- */
  .metrics {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px; margin: 16px 0;
  }
  .metric {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
  }
  .metric-value { font-size: 28px; font-weight: 700; color: var(--accent); }
  .metric-label { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

  /* --- INTENT TABLE --- */
  .intent-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 12px; margin: 16px 0;
  }
  .intent-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
  }
  .intent-card h4 { margin: 0 0 8px; color: var(--accent6); text-transform: none; letter-spacing: 0; font-size: 15px; }
  .intent-card .route { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
  .intent-card .handler { font-size: 12px; color: var(--accent2); font-family: monospace; }
  .intent-card .llm-calls { font-size: 12px; color: var(--accent3); margin-top: 4px; }
  .intent-card p { font-size: 13px; margin-bottom: 4px; }

  /* --- DEPENDENCY GRAPH --- */
  .dep-graph {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 24px;
    margin: 16px 0;
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    font-size: 12px;
    line-height: 1.8;
    white-space: pre;
    overflow-x: auto;
  }
  .dep-graph .file { color: var(--accent); }
  .dep-graph .arrow { color: var(--text-muted); }
  .dep-graph .llm { color: var(--accent3); }
  .dep-graph .data { color: var(--accent2); }

  /* --- SOURCE GRID --- */
  .source-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 8px; margin: 16px 0;
  }
  .source-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px;
    display: flex; align-items: center; gap: 10px;
  }
  .source-weight {
    font-size: 20px; font-weight: 700; min-width: 40px; text-align: center;
  }
  .source-info { flex: 1; }
  .source-info .name { font-weight: 600; font-size: 14px; }
  .source-info .technique { font-size: 11px; color: var(--text-muted); }
  .source-info .file { font-size: 11px; color: var(--accent); font-family: monospace; }
  .w-high { color: var(--accent2); }
  .w-med { color: var(--accent6); }
  .w-low { color: var(--accent4); }

  /* scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* --- SECTION ANCHORS --- */
  section { scroll-margin-top: 60px; }

  /* --- ANNOTATIONS --- */
  .annotation {
    background: rgba(88,166,255,0.06);
    border-left: 3px solid var(--accent);
    padding: 12px 16px;
    margin: 12px 0;
    border-radius: 0 6px 6px 0;
    font-size: 13px;
  }
  .annotation strong { color: var(--accent); }

  .concern {
    background: rgba(255,123,114,0.06);
    border-left: 3px solid var(--accent5);
    padding: 12px 16px;
    margin: 12px 0;
    border-radius: 0 6px 6px 0;
    font-size: 13px;
  }
  .concern strong { color: var(--accent5); }

  .opportunity {
    background: rgba(63,185,80,0.06);
    border-left: 3px solid var(--accent2);
    padding: 12px 16px;
    margin: 12px 0;
    border-radius: 0 6px 6px 0;
    font-size: 13px;
  }
  .opportunity strong { color: var(--accent2); }
</style>
</head>
<body>

<nav class="nav">
  <span class="nav-title">Pulse Architecture</span>
  <a href="#overview">Overview</a>
  <a href="#scrape-pipeline">Scrape Pipeline</a>
  <a href="#sms-pipeline">SMS Pipeline</a>
  <a href="#intents">Intents</a>
  <a href="#llm-calls">LLM Calls</a>
  <a href="#prompts">Prompts</a>
  <a href="#sources">Sources</a>
  <a href="#data-model">Data Model</a>
  <a href="#files">Files</a>
  <a href="#skills">Claude's Value</a>
</nav>

<div class="main">

<!-- ============================================================ -->
<section id="overview">
<h1>Pulse SMS Architecture</h1>
<p class="subtitle">Pulse turns a text message into a curated night out. Users text a neighborhood — "Bushwick", "LES", "prospect park" — and get back 1-3 opinionated event picks under 480 characters. They can reply a number for details, "more" for extra picks, or refine with follow-ups like "how about comedy" or "later tonight." The entire experience happens in a single SMS thread with no app, no account, and no links until you ask.</p>

<div class="metrics">
  <div class="metric"><div class="metric-value">4</div><div class="metric-label">LLM prompts (system messages)</div></div>
  <div class="metric"><div class="metric-value">18</div><div class="metric-label">Event sources (scrapers)</div></div>
  <div class="metric"><div class="metric-value">36</div><div class="metric-label">NYC neighborhoods</div></div>
  <div class="metric"><div class="metric-value">7</div><div class="metric-label">Intent types</div></div>
  <div class="metric"><div class="metric-value">2</div><div class="metric-label">LLM calls per SMS (max)</div></div>
  <div class="metric"><div class="metric-value">4</div><div class="metric-label">LLM-powered scrapers</div></div>
  <div class="metric"><div class="metric-value">480</div><div class="metric-label">SMS char limit</div></div>
  <div class="metric"><div class="metric-value">23</div><div class="metric-label">Files in src/</div></div>
</div>

<h3>Two Pipelines</h3>
<p>Pulse has two completely separate execution paths that never overlap in real-time:</p>

<table>
  <tr><th>Pipeline</th><th>When</th><th>LLM Usage</th><th>Duration</th><th>Frequency</th></tr>
  <tr>
    <td><strong>Scrape Pipeline</strong></td>
    <td>10am ET daily + on boot</td>
    <td>4 sources use Claude for extraction (Skint, Nonsense NYC, Oh My Rockness, Yutori)</td>
    <td>30-90 seconds</td>
    <td>1-2x/day</td>
  </tr>
  <tr>
    <td><strong>SMS Pipeline</strong></td>
    <td>On each incoming text</td>
    <td>Up to 2 calls: route (Haiku) + compose (Haiku). Zero scraping.</td>
    <td>1-4 seconds</td>
    <td>Per message</td>
  </tr>
</table>
</section>

<!-- ============================================================ -->
<section id="scrape-pipeline">
<h2>Scrape Pipeline</h2>
<p>Daily at 10am ET, all 18 sources are fetched in parallel. Events are deduped, geocoded, and cached in memory.</p>

<div class="flow">
  <div class="flow-step">
    <div class="step-label">Trigger</div>
    <div class="step-title">scheduleDailyScrape()</div>
    <div class="step-file">events.js:339</div>
    <div class="step-detail">setTimeout at 10am ET, also runs on boot</div>
  </div>
  <div class="flow-arrow">&rarr;</div>
  <div class="flow-step data">
    <div class="step-label">Fetch</div>
    <div class="step-title">17 Sources (parallel)</div>
    <div class="step-file">events.js:164</div>
    <div class="step-detail">Promise.allSettled() — each wrapped in timedFetch()</div>
  </div>
  <div class="flow-arrow">&rarr;</div>
  <div class="flow-step llm">
    <div class="step-label">4 use Claude</div>
    <div class="step-title">extractEvents()</div>
    <div class="step-file">ai.js:193</div>
    <div class="step-detail">Skint, Nonsense NYC, Oh My Rockness, Yutori send raw text to Claude</div>
  </div>
  <div class="flow-arrow">&rarr;</div>
  <div class="flow-step logic">
    <div class="step-label">Normalize</div>
    <div class="step-title">normalizeExtractedEvent()</div>
    <div class="step-file">sources/shared.js:43</div>
    <div class="step-detail">Venue lookup, geo resolve, ID generation</div>
  </div>
  <div class="flow-arrow">&rarr;</div>
  <div class="flow-step logic">
    <div class="step-label">Dedup</div>
    <div class="step-title">Cross-source merge</div>
    <div class="step-file">events.js:194</div>
    <div class="step-detail">By weight order — first write wins per event ID</div>
  </div>
  <div class="flow-arrow">&rarr;</div>
  <div class="flow-step data">
    <div class="step-label">Geocode</div>
    <div class="step-title">batchGeocodeEvents()</div>
    <div class="step-file">venues.js:284</div>
    <div class="step-detail">Nominatim fallback for unresolved neighborhoods</div>
  </div>
  <div class="flow-arrow">&rarr;</div>
  <div class="flow-step data">
    <div class="step-label">Store</div>
    <div class="step-title">eventCache[]</div>
    <div class="step-file">events.js:258</div>
    <div class="step-detail">In-memory array, plus venues persisted to JSON</div>
  </div>
</div>

<h3>Source Scraping Techniques</h3>
<table>
  <tr><th>Technique</th><th>Sources</th><th>LLM?</th><th>Description</th></tr>
  <tr>
    <td><span class="badge badge-llm">HTML → Claude</span></td>
    <td>Skint, Nonsense NYC, Oh My Rockness, Yutori</td>
    <td>Yes — EXTRACTION_PROMPT</td>
    <td>Fetch raw HTML/email text, send to Claude with extraction prompt, parse JSON response</td>
  </tr>
  <tr>
    <td><span class="badge badge-data">JSON-LD / Schema.org</span></td>
    <td>Songkick, NYC Parks, Eventbrite</td>
    <td>No</td>
    <td>Parse structured data from &lt;script type="application/ld+json"&gt; tags</td>
  </tr>
  <tr>
    <td><span class="badge badge-data">__NEXT_DATA__ JSON</span></td>
    <td>Dice</td>
    <td>No</td>
    <td>Extract from Next.js page data blob</td>
  </tr>
  <tr>
    <td><span class="badge badge-data">GraphQL API</span></td>
    <td>RA (Resident Advisor)</td>
    <td>No</td>
    <td>Direct GraphQL queries to RA's event API</td>
  </tr>
  <tr>
    <td><span class="badge badge-data">JSON API</span></td>
    <td>BAM, Ticketmaster</td>
    <td>No</td>
    <td>REST API returning JSON</td>
  </tr>
  <tr>
    <td><span class="badge badge-data">HTML Scraping</span></td>
    <td>DoNYC, SmallsLIVE, BrooklynVegan, NYPL</td>
    <td>No</td>
    <td>Cheerio/regex parsing of HTML pages</td>
  </tr>
  <tr>
    <td><span class="badge badge-data">Web Search</span></td>
    <td>Tavily</td>
    <td>No</td>
    <td>Search API for free NYC events (fallback source)</td>
  </tr>
</table>

<h3>Cross-Source Dedup</h3>
<div class="annotation">
  <strong>How it works:</strong> Event IDs are MD5 hashes of <code>normalizedName|venue|date</code>. The same event from Dice and BrooklynVegan gets the same ID. Sources are merged in weight order (Skint 0.9 first, Tavily 0.6 last), so the first write wins — higher-trust sources always take precedence.
</div>
</section>

<!-- ============================================================ -->
<section id="sms-pipeline">
<h2>SMS Request Pipeline</h2>
<p>When a user texts Pulse, the message goes through this flow. At most 2 LLM calls happen.</p>

<div class="flow">
  <div class="flow-step">
    <div class="step-label">Twilio</div>
    <div class="step-title">Webhook POST</div>
    <div class="step-file">handler.js:91</div>
    <div class="step-detail">/api/sms/incoming — respond 200 immediately, process async</div>
  </div>
  <div class="flow-arrow">&rarr;</div>
  <div class="flow-step logic">
    <div class="step-label">Guard</div>
    <div class="step-title">Dedup + Rate Limit</div>
    <div class="step-file">handler.js:126</div>
    <div class="step-detail">MessageSid dedup (5m), rate limit (15/hr/phone), TCPA opt-out</div>
  </div>
  <div class="flow-arrow">&rarr;</div>
  <div class="flow-step logic">
    <div class="step-label">Step 1</div>
    <div class="step-title">Pre-Router (Deterministic)</div>
    <div class="step-file">pre-router.js:29</div>
    <div class="step-detail">17 pattern groups — greetings, neighborhoods, more/free, follow-up filters (category/time/vibe with active session)</div>
  </div>
  <div class="flow-arrow">&rarr;</div>
  <div class="flow-step llm">
    <div class="step-label">Step 2 (if needed)</div>
    <div class="step-title">routeMessage()</div>
    <div class="step-file">ai.js:21</div>
    <div class="step-detail">Claude Haiku — intent + neighborhood + filters</div>
  </div>
  <div class="flow-arrow">&rarr;</div>
  <div class="flow-step logic">
    <div class="step-label">Step 3</div>
    <div class="step-title">Intent Dispatch</div>
    <div class="step-file">handler.js:222</div>
    <div class="step-detail">Route to handler: help, conversational, details, more, free, events</div>
  </div>
  <div class="flow-arrow">&rarr;</div>
  <div class="flow-step data">
    <div class="step-label">Step 4</div>
    <div class="step-title">getEvents(hood)</div>
    <div class="step-file">events.js:295</div>
    <div class="step-detail">Filter upcoming, rank by proximity, tonight only, top 20</div>
  </div>
  <div class="flow-arrow">&rarr;</div>
  <div class="flow-step llm">
    <div class="step-label">Step 5</div>
    <div class="step-title">composeResponse()</div>
    <div class="step-file">ai.js:73</div>
    <div class="step-detail">Claude Haiku — pick 1-3 events + write the SMS</div>
  </div>
  <div class="flow-arrow">&rarr;</div>
  <div class="flow-step">
    <div class="step-label">Step 6</div>
    <div class="step-title">sendSMS()</div>
    <div class="step-file">twilio.js:23</div>
    <div class="step-detail">Main SMS + link follow-ups (one per pick)</div>
  </div>
</div>

<h3>Pre-Router Coverage</h3>
<p>The pre-router handles ~60-70% of messages without any LLM call:</p>
<table>
  <tr><th>Pattern</th><th>Intent</th><th>Example</th></tr>
  <tr><td><code>/^(help|\?)$/i</code></td><td>help</td><td>"help", "?"</td></tr>
  <tr><td><code>/^[1-5]$/</code></td><td>details (with session)</td><td>"1", "2", "3"</td></tr>
  <tr><td><code>/^(yes|yeah|sure|ok|...)$/i</code></td><td>nudge_accept (with pending)</td><td>"yeah", "sure", "let's go"</td></tr>
  <tr><td><code>/^(more|show me more|...)$/i</code></td><td>more</td><td>"more", "what else"</td></tr>
  <tr><td><code>/^(free|free stuff|...)$/i</code></td><td>free</td><td>"free", "free tonight"</td></tr>
  <tr><td>Category follow-up (with session)</td><td>events + category filter</td><td>"how about theater", "any comedy", "what about jazz"</td></tr>
  <tr><td>Time follow-up (with session)</td><td>events + time_after filter</td><td>"later tonight", "after midnight", "late night"</td></tr>
  <tr><td>Vibe follow-up (with session)</td><td>events + vibe filter</td><td>"something chill", "anything wild", "something romantic"</td></tr>
  <tr><td>Event name match</td><td>details</td><td>Session pick name substring</td></tr>
  <tr><td><code>/^(hey|hi|hello|...)$/i</code></td><td>conversational</td><td>"hey", "hello"</td></tr>
  <tr><td><code>/^(thanks|thank you|...)$/i</code></td><td>conversational</td><td>"thanks", "ty"</td></tr>
  <tr><td><code>/^(bye|later|...)$/i</code></td><td>conversational</td><td>"bye", "peace"</td></tr>
  <tr><td><code>/^(hello\?+|...)$/i</code></td><td>conversational</td><td>"hello??", "yo?"</td></tr>
  <tr><td>Sports/food/weather regex</td><td>conversational</td><td>"who won the knicks game"</td></tr>
  <tr><td>extractNeighborhood() match</td><td>events</td><td>"east village", "bedford ave"</td></tr>
  <tr><td>detectBorough()</td><td>conversational</td><td>"brooklyn" → asks to narrow</td></tr>
  <tr><td>detectUnsupported()</td><td>conversational</td><td>"bay ridge" → suggests nearby</td></tr>
</table>

<h3>Error Handling</h3>
<table>
  <tr><th>Error Path</th><th>User Impact</th><th>Code Location</th><th>Alerting</th></tr>
  <tr>
    <td><span class="badge badge-error">Double failure</span></td>
    <td>User receives NOTHING</td>
    <td><code>handler.js:144-151</code></td>
    <td>sendRuntimeAlert('double_failure')</td>
  </tr>
  <tr>
    <td><span class="badge badge-error">Handler error</span></td>
    <td>User gets "Couldn't load X" fallback</td>
    <td><code>handler.js:258-267</code></td>
    <td>sendRuntimeAlert('handler_error')</td>
  </tr>
  <tr>
    <td><span class="badge badge-error">Route parse failure</span></td>
    <td>Falls back to conversational</td>
    <td><code>ai.js:45-56</code></td>
    <td>Console only</td>
  </tr>
  <tr>
    <td><span class="badge badge-error">Compose parse failure</span></td>
    <td>User gets "Having a moment"</td>
    <td><code>ai.js:128-135</code></td>
    <td>Console only</td>
  </tr>
  <tr>
    <td><span class="badge badge-error">Details compose failure</span></td>
    <td>Falls back to formatEventDetails()</td>
    <td><code>intent-handlers.js:109</code></td>
    <td>Console only</td>
  </tr>
</table>
</section>

<!-- ============================================================ -->
<section id="intents">
<h2>Intent System</h2>
<p>Every incoming message is classified into one of 7 intents. Each has a dedicated handler.</p>

<div class="intent-grid">
  <div class="intent-card">
    <h4>events</h4>
    <div class="route">Pre-router: bare neighborhood, follow-up filters (category/time/vibe) | AI router</div>
    <div class="handler">handleEventsDefault() — intent-handlers.js:352</div>
    <div class="llm-calls">LLM calls: route (maybe) + compose (always)</div>
    <p>Core flow. Gets events from cache, applies filters, merges perennial picks, calls composeResponse(), sends SMS. Also triggered by follow-up messages ("how about comedy", "later tonight") that modify filters on the active session.</p>
  </div>
  <div class="intent-card">
    <h4>more</h4>
    <div class="route">Pre-router: "more", "what else" | AI router</div>
    <div class="handler">handleMore() — intent-handlers.js:124</div>
    <div class="llm-calls">LLM calls: compose (always)</div>
    <p>Shows next batch from session's remaining events. Tracks allOfferedIds to avoid repeats. Falls back to perennial picks when scraped events exhausted.</p>
  </div>
  <div class="intent-card">
    <h4>free</h4>
    <div class="route">Pre-router: "free", "free stuff" | AI router</div>
    <div class="handler">handleFree() — intent-handlers.js:225</div>
    <div class="llm-calls">LLM calls: compose (always)</div>
    <p>Filters events by is_free. Searches adjacent neighborhoods if none found locally. Respects category filters from pending state.</p>
  </div>
  <div class="intent-card">
    <h4>details</h4>
    <div class="route">Pre-router: "1"-"5", event name match | AI router</div>
    <div class="handler">handleDetails() — intent-handlers.js:69</div>
    <div class="llm-calls">LLM calls: composeDetails (1 call) or none (fallback)</div>
    <p>Shows expanded info about a specific pick. Uses composeDetails() for natural language, falls back to formatEventDetails() if Claude fails.</p>
  </div>
  <div class="intent-card">
    <h4>help</h4>
    <div class="route">Pre-router: "help", "?"</div>
    <div class="handler">handleHelp() — intent-handlers.js:45</div>
    <div class="llm-calls">LLM calls: 0</div>
    <p>Static help text. No Claude involvement.</p>
  </div>
  <div class="intent-card">
    <h4>conversational</h4>
    <div class="route">Pre-router: greetings, thanks, bye, off-topic | AI router</div>
    <div class="handler">handleConversational() — intent-handlers.js:54</div>
    <div class="llm-calls">LLM calls: 0 (pre-routed) or 1 (AI-routed)</div>
    <p>Social niceties + off-topic deflection. Always redirects back to events. Session-aware — mentions "more" if they have recent picks.</p>
  </div>
  <div class="intent-card">
    <h4>nudge_accept</h4>
    <div class="route">Pre-router: affirmative + pendingNearby in session</div>
    <div class="handler">handleNudgeAccept() — intent-handlers.js:300</div>
    <div class="llm-calls">LLM calls: compose (always)</div>
    <p>User said "yes" to "would you travel to X?" nudge. Serves the pre-loaded nearby events from session.</p>
  </div>
</div>

<h3>Intent Decision Flow</h3>
<div class="dep-graph"><span class="arrow">message arrives</span>
  │
  ├─ <span class="file">pre-router.js</span> — <span class="data">17 pattern groups (no LLM)</span>
  │   ├─ help, conversational, details, more, free → <span class="llm">skip Claude routing</span>
  │   ├─ follow-up filters (session active) → <span class="llm">events + filters (skip Claude)</span>
  │   │   ├─ category: "how about theater" → events + category=theater
  │   │   ├─ time: "later tonight" → events + time_after=22:00
  │   │   └─ vibe: "something chill" → events + vibe=chill
  │   ├─ bare neighborhood match → <span class="llm">events (skip Claude routing)</span>
  │   ├─ borough / unsupported → conversational (ask to narrow)
  │   └─ null (no match) → <span class="llm">fall through to Claude</span>
  │
  ├─ <span class="file">ai.js:routeMessage()</span> — <span class="llm">LLM Call #1 (Haiku, 8s timeout)</span>
  │   └─ returns { intent, neighborhood, filters, confidence }
  │
  ├─ <span class="file">handler.js</span> — intent dispatch
  │   ├─ help → static response
  │   ├─ conversational → static or AI-routed reply
  │   ├─ details → composeDetails() or formatEventDetails()
  │   ├─ events/more/free → getEvents() → <span class="llm">composeResponse() — LLM Call #2</span>
  │   └─ nudge_accept → session events → <span class="llm">composeResponse() — LLM Call #2</span></div>
</section>

<!-- ============================================================ -->
<section id="llm-calls">
<h2>LLM Calls — Complete Inventory</h2>
<p>Every Claude API call in the system, when it fires, and what it does.</p>

<table>
  <tr><th>Call</th><th>Model</th><th>System Prompt</th><th>When</th><th>Timeout</th><th>max_tokens</th><th>Pipeline</th></tr>
  <tr>
    <td><strong>routeMessage()</strong></td>
    <td>Haiku 4.5</td>
    <td>ROUTE_SYSTEM (290 lines)</td>
    <td>Every SMS not caught by pre-router</td>
    <td>8s</td>
    <td>256</td>
    <td><span class="badge badge-io">SMS</span></td>
  </tr>
  <tr>
    <td><strong>composeResponse()</strong></td>
    <td>Haiku 4.5</td>
    <td>buildComposePrompt() — composable skills</td>
    <td>Every events/more/free/nudge_accept intent</td>
    <td>12s</td>
    <td>512</td>
    <td><span class="badge badge-io">SMS</span></td>
  </tr>
  <tr>
    <td><strong>composeDetails()</strong></td>
    <td>Haiku 4.5</td>
    <td>DETAILS_SYSTEM (29 lines)</td>
    <td>User asks for details on a specific pick</td>
    <td>8s</td>
    <td>256</td>
    <td><span class="badge badge-io">SMS</span></td>
  </tr>
  <tr>
    <td><strong>extractEvents()</strong></td>
    <td>Haiku 4.5</td>
    <td>EXTRACTION_PROMPT (168 lines)</td>
    <td>Daily scrape — Skint, Nonsense NYC, Oh My Rockness, Yutori</td>
    <td>15s</td>
    <td>8192</td>
    <td><span class="badge badge-data">Scrape</span></td>
  </tr>
</table>

<h3>LLM Call Frequency Analysis</h3>
<div class="annotation">
  <strong>Hot path (per SMS):</strong> At most 2 calls — route + compose. Pre-router eliminates the route call for ~60-70% of messages (greetings, numbers, "more", bare neighborhoods). So the average is closer to 1.3 calls per SMS.
</div>
<div class="annotation">
  <strong>Cold path (daily):</strong> 4 extraction calls during scrape. Each processes large HTML/email documents (5-50KB) with 8192 max tokens.
</div>

<h3>Token Budget Estimates</h3>
<table>
  <tr><th>Call</th><th>System Prompt</th><th>User Content (typical)</th><th>Output</th><th>Total per call</th></tr>
  <tr><td>routeMessage</td><td>~2,100 tokens (slimmed)</td><td>~100-200 tokens</td><td>~80-120 tokens</td><td>~2,300-2,400</td></tr>
  <tr><td>composeResponse</td><td>~2,300 tokens (typical: core + 2-3 skills)</td><td>~800-2,000 tokens (8 events)</td><td>~200-400 tokens</td><td>~3,300-4,700</td></tr>
  <tr><td>composeDetails</td><td>~400 tokens</td><td>~200-300 tokens</td><td>~100-200 tokens</td><td>~700-900</td></tr>
  <tr><td>extractEvents</td><td>~1,600 tokens</td><td>~2,000-10,000 tokens</td><td>~2,000-6,000 tokens</td><td>~5,600-17,600</td></tr>
</table>
</section>

<!-- ============================================================ -->
<section id="prompts">
<h2>All Prompts</h2>
<p>Complete text of every system prompt in the system, with annotations.</p>

<div class="prompt-block">
  <div class="prompt-header" onclick="togglePrompt(this)">
    <span class="prompt-name">1. EXTRACTION_PROMPT — Event Extraction</span>
    <span class="prompt-meta">~1,600 tokens | Used by: Skint, Nonsense NYC, Oh My Rockness | ai.js:extractEvents()</span>
  </div>
  <div class="prompt-content" id="prompt-extraction">Role: Event Extractor for Pulse (NYC). Convert messy source text into normalized event records.

RULES:
- VENUES vs EVENTS: If a venue hosts a specific event, extract the EVENT with venue as venue_name.
  Only extract venue-only records when no specific event is mentioned.
  Bars, restaurants, game spots, arcades — extract these too with best-fit category.
  Permanent venues: set date_local/start_time_local to null, time_window to "evening", confidence to 0.6.

- SOURCE URLs: Use [Source: URL] markers before each item as that event's source_url.
  Prefer per-item [Source: URL] over top-level source_url input.

- TRUTH + SAFETY: Extract only what is explicitly present. Do not guess. If missing, set null.
  Prefer NYC interpretation (America/New_York).

- DATE RESOLUTION: Use retrieved_at_nyc to resolve relative days.
  "today"/"tonight" → retrieved_at_nyc date.
  Past day names → set confidence to 0.1.

- CONFIDENCE SCALE:
  0.9+: name + date/time + location clearly present
  0.7–0.85: name + (date OR time window) + partial location
  0.4–0.65: name clear but time/location ambiguous
  &lt; 0.4: too ambiguous → needs_review = true
  0.1: event date has already passed

- NEEDS_REVIEW TRIGGERS: confidence &lt; 0.5, ambiguous name, unresolvable date,
  both venue_name and neighborhood missing, contradictory price info.

- DEDUPE HINT: Output duplicates separately; downstream will dedupe.

OUTPUT FORMAT:
{
  "events": [{
    source_name, source_url, name, description_short, venue_name, venue_address,
    neighborhood, latitude, longitude, category, subcategory,
    start_time_local, end_time_local, date_local, time_window,
    is_free, price_display, ticket_url, map_hint, confidence, needs_review,
    evidence: { name_quote, time_quote, location_quote, price_quote }
  }]
}

EXAMPLES: Skint-style newsletter, Tavily venue (no specific event)</div>
</div>

<div class="prompt-block">
  <div class="prompt-header" onclick="togglePrompt(this)">
    <span class="prompt-name">2. ROUTE_SYSTEM — Message Routing (slimmed)</span>
    <span class="prompt-meta">~2,100 tokens | Used by: routeMessage() | ai.js:21 | Hot path</span>
  </div>
  <div class="prompt-content" id="prompt-route">Role: Pulse's message router. SMS bot that recommends NYC nightlife and events.
Given incoming SMS (&lt;user_message&gt; tags), session context, and valid neighborhoods,
determine intent and extract parameters.

VALID INTENTS:
- "events" — wants recommendations (mentions place, wants to go out)
- "details" — wants more info on shown event (references specific pick)
- "more" — wants additional options beyond what was shown
- "free" — wants free events specifically
- "help" — asks what Pulse is / how to use it
- "conversational" — social niceties + off-topic (greetings, thanks, goodbyes)

OFF-TOPIC HANDLING: Pulse is event discovery, not general assistant.
Trivia, sports, advice, jokes, opinions → "conversational" + redirect.

SESSION AWARENESS:
- Active session + vague event-seeking → "more" or "events", not "conversational"
- Filter-modification follow-ups with active session are ALWAYS "events" with filters — never "conversational"
  Examples: "how about theater", "any comedy", "something chill", "later tonight"
- Only "conversational" for true social niceties regardless of session

NEIGHBORHOOD RESOLUTION:
- Map to ONE valid neighborhood from VALID_NEIGHBORHOODS
- Handle slang, landmarks, subway stops
- (Boroughs, bare neighborhoods, unsupported hoods handled by pre-router)
- No neighborhood + session has one → use session
- Truly nothing → null

FILTERS:
- free_only: true if user asks for free
- category: comedy, art, nightlife, live_music, theater, food_drink, community, or null
- vibe: "chill", "wild", "romantic", "weird", or null

DECISION TREE (classifying messages with active session):
1. Session has prior picks? No → "events"
2. Message mentions specific neighborhood? Yes → "events"
3. Message modifies filters (category/time/vibe)? Yes → "events" + filters, same hood
4. Message asks for more/other/different? Yes → "more"
5. Vague event-seeking, no new neighborhood? Yes → "more"
6. Otherwise → "events"

CONFIDENCE: 0.9+ unambiguous, 0.7-0.85 inferred, 0.5-0.69 ambiguous, &lt;0.5 uncertain

REPLY: Only for help/conversational. 1 short sentence + redirect to events.

OUTPUT:
{
  "intent": "events|details|more|free|help|conversational",
  "neighborhood": "string or null",
  "filters": { "free_only": false, "category": null, "vibe": null },
  "event_reference": null,
  "reply": "string or null",
  "confidence": 0.0
}</div>
</div>

<div class="prompt-block">
  <div class="prompt-header" onclick="togglePrompt(this)">
    <span class="prompt-name">3. Compose Skills — Event Curation + SMS Writing (composable)</span>
    <span class="prompt-meta">~2,300 tokens typical | Built by: buildComposePrompt() | skills/build-compose-prompt.js | Hot path</span>
  </div>
  <div class="prompt-content" id="prompt-compose">COMPOSABLE SKILL SYSTEM — assembled per-call from src/skills/

CORE skill (always included, ~1,400 tokens):
  Role, pick priority order, date awareness, honesty, format rules,
  character limit, voice, output JSON format.

CONDITIONAL skills (included only when relevant):
  tonight-priority  (~40 tokens)  — when events include day=TODAY
  source-tiers      (~60 tokens)  — always (slimmed to one line)
  neighborhood-mismatch (~50 tokens) — when no events match requested hood
  perennial-framing (~120 tokens) — when batch contains perennial events
  venue-framing     (~50 tokens)  — when batch contains Tavily venues
  last-batch        (~30 tokens)  — when this is the final batch (no MORE)
  free-emphasis     (~20 tokens)  — when user asked for free events
  pending-intent    (~20 tokens)  — when restoring a pending message

WHAT MOVED TO CODE (deterministic, pre-compose):
  Kids event filtering → curation.js:filterKidsEvents()
  Perennial activity validation → curation.js:validatePerennialActivity()
  Incomplete event removal → curation.js:filterIncomplete()

Typical call: core + source-tiers + tonight-priority = ~1,500 tokens
Worst case (all skills): ~1,800 tokens
Previous monolith: ~3,600 tokens (sent every call regardless)</div>
</div>

<div class="prompt-block">
  <div class="prompt-header" onclick="togglePrompt(this)">
    <span class="prompt-name">4. DETAILS_SYSTEM — Event Details</span>
    <span class="prompt-meta">~400 tokens | Used by: composeDetails() | ai.js:320 | Lightest prompt</span>
  </div>
  <div class="prompt-content" id="prompt-details">Role: Pulse — NYC "plugged-in friend" texting about a spot you recommended.
Write like a real person — warm, opinionated, concise. Never robotic.

CONTENT PRIORITY (include in order, cut from bottom if long):
1. Vibe / what makes it worth going (LEAD with this)
2. Time (tonight at 9, doors at 10, etc.)
3. Price or "free"
4. URL (always include if provided)
5. Address (only if space remains)

CONSTRAINTS:
- 320 character limit (SMS split prevention)
- Plain text only. No JSON, no quotes, no preamble.
- No list format or bullet points. One natural paragraph like a text from a friend.
- No Yelp URLs.</div>
</div>

<div class="annotation">
  <strong>Composable skills (implemented):</strong> The old monolithic COMPOSE_SYSTEM was decomposed into conditional skill modules. Deterministic curation (kids filtering, perennial validation) moved to code. The 4 ad-hoc <code>extraContext</code> string injections in intent-handlers.js were replaced with structured <code>skills</code> option objects. Typical compose calls now send ~34% fewer prompt tokens.
</div>
</section>

<!-- ============================================================ -->
<section id="sources">
<h2>Source Registry</h2>
<p>All 18 event sources, ordered by trust weight. Higher weight wins in cross-source dedup.</p>

<div class="source-grid">
  <div class="source-item">
    <div class="source-weight w-high">0.9</div>
    <div class="source-info">
      <div class="name">Skint</div>
      <div class="technique">HTML → Claude extraction</div>
      <div class="file">sources/skint.js</div>
    </div>
  </div>
  <div class="source-item">
    <div class="source-weight w-high">0.9</div>
    <div class="source-info">
      <div class="name">Nonsense NYC</div>
      <div class="technique">HTML → Claude extraction</div>
      <div class="file">sources/nonsense.js</div>
    </div>
  </div>
  <div class="source-item">
    <div class="source-weight w-med">0.85</div>
    <div class="source-info">
      <div class="name">Resident Advisor</div>
      <div class="technique">GraphQL API</div>
      <div class="file">sources/ra.js</div>
    </div>
  </div>
  <div class="source-item">
    <div class="source-weight w-med">0.85</div>
    <div class="source-info">
      <div class="name">Oh My Rockness</div>
      <div class="technique">HTML → Claude extraction</div>
      <div class="file">sources/ohmyrockness.js</div>
    </div>
  </div>
  <div class="source-item">
    <div class="source-weight w-med">0.8</div>
    <div class="source-info">
      <div class="name">Dice</div>
      <div class="technique">__NEXT_DATA__ JSON</div>
      <div class="file">sources/dice.js</div>
    </div>
  </div>
  <div class="source-item">
    <div class="source-weight w-med">0.8</div>
    <div class="source-info">
      <div class="name">BrooklynVegan</div>
      <div class="technique">DoStuff JSON</div>
      <div class="file">sources/brooklynvegan.js</div>
    </div>
  </div>
  <div class="source-item">
    <div class="source-weight w-med">0.8</div>
    <div class="source-info">
      <div class="name">BAM</div>
      <div class="technique">JSON API</div>
      <div class="file">sources/bam.js</div>
    </div>
  </div>
  <div class="source-item">
    <div class="source-weight w-med">0.8</div>
    <div class="source-info">
      <div class="name">SmallsLIVE</div>
      <div class="technique">AJAX HTML</div>
      <div class="file">sources/smallslive.js</div>
    </div>
  </div>
  <div class="source-item">
    <div class="source-weight w-med">0.8</div>
    <div class="source-info">
      <div class="name">Yutori</div>
      <div class="technique">Gmail API + Claude extraction</div>
      <div class="file">sources/yutori.js</div>
    </div>
  </div>
  <div class="source-item">
    <div class="source-weight w-low">0.75</div>
    <div class="source-info">
      <div class="name">NYC Parks</div>
      <div class="technique">Schema.org</div>
      <div class="file">sources/nyc-parks.js</div>
    </div>
  </div>
  <div class="source-item">
    <div class="source-weight w-low">0.75</div>
    <div class="source-info">
      <div class="name">DoNYC</div>
      <div class="technique">Cheerio HTML</div>
      <div class="file">sources/donyc.js</div>
    </div>
  </div>
  <div class="source-item">
    <div class="source-weight w-low">0.75</div>
    <div class="source-info">
      <div class="name">Songkick</div>
      <div class="technique">JSON-LD</div>
      <div class="file">sources/songkick.js</div>
    </div>
  </div>
  <div class="source-item">
    <div class="source-weight w-low">0.75</div>
    <div class="source-info">
      <div class="name">Ticketmaster</div>
      <div class="technique">Discovery API</div>
      <div class="file">sources/ticketmaster.js</div>
    </div>
  </div>
  <div class="source-item">
    <div class="source-weight w-low">0.7</div>
    <div class="source-info">
      <div class="name">Eventbrite</div>
      <div class="technique">JSON-LD + __SERVER_DATA__</div>
      <div class="file">sources/eventbrite.js</div>
    </div>
  </div>
  <div class="source-item">
    <div class="source-weight w-low">0.7</div>
    <div class="source-info">
      <div class="name">NYPL</div>
      <div class="technique">Eventbrite organizer pages</div>
      <div class="file">sources/nypl.js</div>
    </div>
  </div>
  <div class="source-item">
    <div class="source-weight w-low">0.7</div>
    <div class="source-info">
      <div class="name">Eventbrite Comedy</div>
      <div class="technique">Eventbrite category page</div>
      <div class="file">sources/eventbrite.js</div>
    </div>
  </div>
  <div class="source-item">
    <div class="source-weight w-low">0.7</div>
    <div class="source-info">
      <div class="name">Eventbrite Arts</div>
      <div class="technique">Eventbrite category page</div>
      <div class="file">sources/eventbrite.js</div>
    </div>
  </div>
  <div class="source-item">
    <div class="source-weight w-low">0.6</div>
    <div class="source-info">
      <div class="name">Tavily</div>
      <div class="technique">Web search API</div>
      <div class="file">sources/tavily.js</div>
    </div>
  </div>
</div>
</section>

<!-- ============================================================ -->
<section id="data-model">
<h2>Data Model</h2>

<h3>Normalized Event Object</h3>
<p>Every event from every source gets normalized to this shape by <code>normalizeExtractedEvent()</code>:</p>
<table>
  <tr><th>Field</th><th>Type</th><th>Source</th><th>Used By</th></tr>
  <tr><td><code>id</code></td><td>string (12-char MD5)</td><td>makeEventId(name, venue, date)</td><td>Dedup, session tracking</td></tr>
  <tr><td><code>source_name</code></td><td>string</td><td>Scraper label</td><td>Trust weighting</td></tr>
  <tr><td><code>source_weight</code></td><td>number (0-1)</td><td>SOURCES registry</td><td>Compose prompt picks</td></tr>
  <tr><td><code>name</code></td><td>string</td><td>Scraped/extracted</td><td>Display, dedup</td></tr>
  <tr><td><code>venue_name</code></td><td>string</td><td>Scraped/extracted</td><td>Display, venue lookup, dedup</td></tr>
  <tr><td><code>neighborhood</code></td><td>string | null</td><td>resolveNeighborhood()</td><td>Proximity ranking, filtering</td></tr>
  <tr><td><code>date_local</code></td><td>YYYY-MM-DD | null</td><td>Scraped/extracted</td><td>Today/tomorrow filtering</td></tr>
  <tr><td><code>start_time_local</code></td><td>ISO datetime | null</td><td>Scraped/extracted</td><td>Upcoming filter, display</td></tr>
  <tr><td><code>is_free</code></td><td>boolean</td><td>Scraped/extracted</td><td>Free filter, display</td></tr>
  <tr><td><code>category</code></td><td>string enum</td><td>Scraped or inferCategory()</td><td>Category filter, display</td></tr>
  <tr><td><code>confidence</code></td><td>number (0-1)</td><td>Extraction or source default</td><td>Compose picks</td></tr>
  <tr><td><code>ticket_url</code></td><td>string | null</td><td>Scraped/extracted</td><td>Link follow-ups</td></tr>
  <tr><td><code>source_url</code></td><td>string | null</td><td>Scraped/extracted</td><td>Link follow-ups (fallback)</td></tr>
</table>

<h3>Session Object</h3>
<p>Per-phone, 2-hour TTL, stored in memory (<code>session.js</code>). Merged on each setSession() call.</p>
<table>
  <tr><th>Field</th><th>Type</th><th>Purpose</th></tr>
  <tr><td><code>lastNeighborhood</code></td><td>string</td><td>Carries neighborhood for "more", implicit context</td></tr>
  <tr><td><code>lastPicks</code></td><td>array</td><td>Current displayed picks — for details + pick recovery</td></tr>
  <tr><td><code>allPicks</code></td><td>array</td><td>All picks across more batches — for dedup</td></tr>
  <tr><td><code>lastEvents</code></td><td>object</td><td>Event map (id → event) — for details, more remaining calc</td></tr>
  <tr><td><code>allOfferedIds</code></td><td>array</td><td>All events offered to Claude — for more exclusion</td></tr>
  <tr><td><code>lastFilters</code></td><td>object | null</td><td>Last applied filters (category, vibe, time_after, free_only) — exposed to router for follow-up context</td></tr>
  <tr><td><code>conversationHistory</code></td><td>array</td><td>Last 6 turns of conversation (role + content, 300-char cap) — sent to router + compose for context</td></tr>
  <tr><td><code>pendingNearby</code></td><td>string | null</td><td>Pending travel nudge neighborhood</td></tr>
  <tr><td><code>pendingNearbyEvents</code></td><td>object | null</td><td>Pre-loaded events for nudge accept</td></tr>
  <tr><td><code>pendingFilters</code></td><td>object | null</td><td>Saved filters when asking for neighborhood</td></tr>
  <tr><td><code>visitedHoods</code></td><td>array</td><td>Tracks visited neighborhoods — for nudge dedup</td></tr>
</table>

<h3>Trace Object</h3>
<p>Every SMS request generates a trace (<code>traces.js</code>). Stored as JSONL, 200-item ring buffer, 4-day rotation.</p>
<table>
  <tr><th>Field</th><th>Type</th><th>Content</th></tr>
  <tr><td><code>routing</code></td><td>object</td><td>pre_routed flag, result (intent/neighborhood/confidence), latency, raw response</td></tr>
  <tr><td><code>events</code></td><td>object</td><td>cache_size, candidates_count, sent_to_claude count, candidate/sent IDs</td></tr>
  <tr><td><code>composition</code></td><td>object</td><td>latency, raw response, picks, not_picked_reason, neighborhood_used</td></tr>
  <tr><td><code>annotation</code></td><td>object | null</td><td>verdict (pass/fail), failure_modes, notes</td></tr>
</table>
</section>

<!-- ============================================================ -->
<section id="files">
<h2>File Dependency Map</h2>

<div class="dep-graph"><span class="file">server.js</span> (Express setup, routes, schedule)
  ├── <span class="file">handler.js</span> (Twilio webhook, async dispatch)
  │   ├── <span class="file">neighborhoods.js</span> (36 hoods, aliases, landmarks)
  │   ├── <span class="llm">ai.js</span> (routeMessage, composeResponse, composeDetails, extractEvents)
  │   │   ├── <span class="file">prompts.js</span> (EXTRACTION_PROMPT, ROUTE_SYSTEM, COMPOSE_SYSTEM, DETAILS_SYSTEM)
  │   │   ├── <span class="file">skills/build-compose-prompt.js</span> (assembles compose system prompt)
  │   │   │   ├── <span class="file">skills/compose-skills.js</span> (9 skill module definitions)
  │   │   │   └── <span class="file">geo.js</span> (getNycDateString — for today detection)
  │   │   ├── <span class="file">geo.js</span> (getEventDate, getNycDateString)
  │   │   └── <span class="file">formatters.js</span> (smartTruncate)
  │   ├── <span class="file">twilio.js</span> (sendSMS, maskPhone, test capture)
  │   ├── <span class="file">traces.js</span> (startTrace, saveTrace)
  │   ├── <span class="file">session.js</span> (getSession, setSession, clearSession)
  │   ├── <span class="file">pre-router.js</span> (deterministic intent matching + follow-up filters)
  │   │   └── <span class="file">neighborhoods.js</span>
  │   ├── <span class="file">intent-handlers.js</span> (help, conversational, details, more, free, nudge, events)
  │   │   ├── <span class="file">events.js</span> (getEvents)
  │   │   ├── <span class="llm">ai.js</span> (composeDetails, isSearchUrl)
  │   │   ├── <span class="file">twilio.js</span>
  │   │   ├── <span class="file">session.js</span>
  │   │   ├── <span class="file">formatters.js</span>
  │   │   ├── <span class="file">pre-router.js</span> (getAdjacentNeighborhoods)
  │   │   ├── <span class="file">perennial.js</span> (getPerennialPicks, toEventObjects)
  │   │   └── <span class="file">curation.js</span> (filterKidsEvents, validatePerennialActivity)
  │   └── <span class="file">alerts.js</span> (sendRuntimeAlert)
  │
  ├── <span class="data">events.js</span> (cache, scrape, health tracking)
  │   ├── <span class="file">sources/index.js</span> (barrel — 17 scrapers)
  │   │   ├── <span class="file">sources/shared.js</span> (makeEventId, normalizeExtractedEvent)
  │   │   │   ├── <span class="file">geo.js</span> (resolveNeighborhood)
  │   │   │   └── <span class="file">venues.js</span> (lookupVenue)
  │   │   ├── <span class="file">sources/skint.js</span> → <span class="llm">ai.js:extractEvents()</span>
  │   │   ├── <span class="file">sources/nonsense.js</span> → <span class="llm">ai.js:extractEvents()</span>
  │   │   ├── <span class="file">sources/ohmyrockness.js</span> → <span class="llm">ai.js:extractEvents()</span>
  │   │   ├── <span class="file">sources/yutori.js</span> → <span class="llm">ai.js:extractEvents()</span>
  │   │   ├── <span class="file">sources/ra.js</span> (GraphQL)
  │   │   ├── <span class="file">sources/dice.js</span> (__NEXT_DATA__)
  │   │   └── <span class="file">... 11 more scrapers</span>
  │   ├── <span class="file">geo.js</span> (rankEventsByProximity, filterUpcomingEvents)
  │   ├── <span class="file">venues.js</span> (batchGeocodeEvents, exportLearnedVenues)
  │   └── <span class="file">alerts.js</span> (sendHealthAlert)</div>

<h3>File Purpose Summary</h3>
<table>
  <tr><th>File</th><th>Lines</th><th>Type</th><th>LLM?</th><th>Purpose</th></tr>
  <tr><td><code>server.js</code></td><td>~210</td><td><span class="badge badge-io">IO</span></td><td>No</td><td>Express setup, routes, health check, daily schedule</td></tr>
  <tr><td><code>handler.js</code></td><td>~332</td><td><span class="badge badge-logic">Logic</span></td><td>No</td><td>Twilio webhook, dedup, rate limiter, orchestrator</td></tr>
  <tr><td><code>intent-handlers.js</code></td><td>~504</td><td><span class="badge badge-logic">Logic</span></td><td>Indirect</td><td>7 intent handlers — help, conversational, details, more, free, nudge, events</td></tr>
  <tr><td><code>pre-router.js</code></td><td>~175</td><td><span class="badge badge-logic">Logic</span></td><td>No</td><td>17 pattern groups (incl. session-aware follow-up filters), adjacent neighborhood helper</td></tr>
  <tr><td><code>ai.js</code></td><td>~407</td><td><span class="badge badge-llm">LLM</span></td><td>Yes</td><td>4 Claude calls: route, compose, details, extract</td></tr>
  <tr><td><code>prompts.js</code></td><td>~395</td><td><span class="badge badge-llm">LLM</span></td><td>Prompts</td><td>EXTRACTION_PROMPT, ROUTE_SYSTEM (slimmed), COMPOSE_SYSTEM (base), DETAILS_SYSTEM</td></tr>
  <tr><td><code>skills/compose-skills.js</code></td><td>~120</td><td><span class="badge badge-llm">LLM</span></td><td>Prompts</td><td>9 composable skill modules for compose prompt</td></tr>
  <tr><td><code>skills/build-compose-prompt.js</code></td><td>~60</td><td><span class="badge badge-logic">Logic</span></td><td>No</td><td>Assembles compose system prompt from applicable skills</td></tr>
  <tr><td><code>curation.js</code></td><td>~45</td><td><span class="badge badge-logic">Logic</span></td><td>No</td><td>Pre-compose filters: kids events, perennial validation, low confidence</td></tr>
  <tr><td><code>events.js</code></td><td>~407</td><td><span class="badge badge-data">Data</span></td><td>No</td><td>Cache, scrape orchestrator, health tracking, scheduler</td></tr>
  <tr><td><code>geo.js</code></td><td>~249</td><td><span class="badge badge-logic">Logic</span></td><td>No</td><td>Neighborhood resolution, proximity, time filtering, haversine</td></tr>
  <tr><td><code>neighborhoods.js</code></td><td>~302</td><td><span class="badge badge-data">Data</span></td><td>No</td><td>36 neighborhoods, aliases, landmarks, borough detection</td></tr>
  <tr><td><code>venues.js</code></td><td>~313</td><td><span class="badge badge-data">Data</span></td><td>No</td><td>~190 venue coords, auto-learning, Nominatim geocoding</td></tr>
  <tr><td><code>session.js</code></td><td>~36</td><td><span class="badge badge-data">Data</span></td><td>No</td><td>In-memory session store with TTL</td></tr>
  <tr><td><code>formatters.js</code></td><td>~144</td><td><span class="badge badge-logic">Logic</span></td><td>No</td><td>Time formatting, URL cleaning, event details, smart truncate</td></tr>
  <tr><td><code>twilio.js</code></td><td>~59</td><td><span class="badge badge-io">IO</span></td><td>No</td><td>SMS sending with retry, test capture mode</td></tr>
  <tr><td><code>perennial.js</code></td><td>~103</td><td><span class="badge badge-data">Data</span></td><td>No</td><td>Perennial picks loader, day filtering, event conversion</td></tr>
  <tr><td><code>alerts.js</code></td><td>~115</td><td><span class="badge badge-io">IO</span></td><td>No</td><td>Health + runtime email alerts via Resend</td></tr>
  <tr><td><code>traces.js</code></td><td>~196</td><td><span class="badge badge-data">Data</span></td><td>No</td><td>JSONL trace storage, ring buffer, annotations</td></tr>
</table>
</section>

<!-- ============================================================ -->
<section id="skills">
<h2>Where Claude Adds Value</h2>
<p>Pulse uses Claude for exactly 4 things. Each one is chosen because code can't do it well — and Claude's specific strengths (language understanding, taste, tone, messy-input parsing) are the right tool.</p>

<h3>Claude's 4 Jobs</h3>

<div class="intent-grid">
  <div class="intent-card" style="border-left: 3px solid var(--accent3);">
    <h4>1. Extraction — Messy HTML to Structured Data</h4>
    <div class="handler">ai.js:extractEvents() | EXTRACTION_PROMPT | Scrape pipeline</div>
    <p style="margin-top: 8px;">3 sources (Skint, Nonsense NYC, Oh My Rockness) publish events as newsletters or loosely-formatted HTML. No JSON-LD, no API, no consistent structure. Claude reads the raw HTML and produces normalized event records with dates, venues, times, prices, and confidence scores.</p>
    <p><strong>Why Claude:</strong> These sources have wildly varying formats that change without notice. Regex/Cheerio would require per-source maintenance and break on every redesign. Claude handles format drift gracefully — it reads like a person would.</p>
    <p><strong>Why not code:</strong> Code-based parsing is brittle for unstructured newsletters. The Skint mixes free-form prose with event listings; Nonsense NYC uses an email newsletter format with no consistent HTML structure. Rule-based extraction would be a maintenance nightmare.</p>
  </div>

  <div class="intent-card" style="border-left: 3px solid var(--accent3);">
    <h4>2. Semantic Routing — Understanding Ambiguous Messages</h4>
    <div class="handler">ai.js:routeMessage() | ROUTE_SYSTEM | SMS pipeline (30-40% of messages)</div>
    <p style="margin-top: 8px;">The pre-router handles ~60-70% of messages deterministically (bare neighborhoods, "more", "free", greetings, numbers, and simple follow-up filter changes). Claude only gets the ambiguous remainder: "anything fun in the village tonight", compound filters like "any more free comedy stuff", "i'm near prospect park looking for comedy".</p>
    <p><strong>Why Claude:</strong> These messages require understanding context + intent + geography simultaneously. "village" could be East Village, West Village, or Greenwich Village depending on context. "got jazz?" with a Bushwick session means "jazz near Bushwick" not "jazz anywhere." Code can't infer this reliably.</p>
    <p><strong>Why not code:</strong> We tried. The pre-router catches clear patterns, but NLP for open-ended SMS messages with slang, abbreviations, and implicit session context is where statistical matching fails. Claude's semantic understanding fills the gap the pre-router can't.</p>
  </div>

  <div class="intent-card" style="border-left: 3px solid var(--accent3);">
    <h4>3. Curation + SMS Writing — Taste and Voice</h4>
    <div class="handler">ai.js:composeResponse() | buildComposePrompt() | SMS pipeline</div>
    <p style="margin-top: 8px;">Given 4-8 candidate events, Claude picks the best 1-3 and writes an opinionated SMS that sounds like a plugged-in friend texting. It balances tonight-vs-tomorrow, source trust, neighborhood fit, and "curation taste" (preferring indie/interesting over corporate/generic).</p>
    <p><strong>Why Claude:</strong> Two things code can't do: (1) <em>Taste</em> — ranking "DJ night at a small Bushwick venue" above "hotel bar happy hour" requires judgment that doesn't reduce to a sort function. (2) <em>Voice</em> — "legendary basement spot, incredible players" vs "Jazz at Smalls Jazz Club, 9:30pm, $20." The personality IS the product.</p>
    <p><strong>Why not code:</strong> Code handles the pre-filtering (proximity ranking, time filtering, dedup). But the final pick + write step is where Claude's "opinion" creates the UX that makes Pulse feel like a friend, not a search engine.</p>
  </div>

  <div class="intent-card" style="border-left: 3px solid var(--accent3);">
    <h4>4. Details Writing — Natural Language About a Venue</h4>
    <div class="handler">ai.js:composeDetails() | DETAILS_SYSTEM | SMS pipeline (on demand)</div>
    <p style="margin-top: 8px;">When a user replies "1" to get details on a pick, Claude writes a natural-language description of the event: why it's worth going, the vibe, time, price, and a link. 320-char limit.</p>
    <p><strong>Why Claude:</strong> Same voice/tone benefit as compose. A structured fallback exists (<code>formatEventDetails()</code>) but it reads like a database dump. Claude makes it feel like a friend giving you the rundown.</p>
    <p><strong>Why not code:</strong> There IS a code fallback — it's used when Claude fails. The code version works but lacks personality. The Claude version is the premium experience.</p>
  </div>
</div>

<h3>What Stays as Code (and Should)</h3>
<p>Every other operation in Pulse is deterministic and runs without Claude. This is intentional — Claude adds latency and cost. It should only be used where its strengths are irreplaceable.</p>

<table>
  <tr><th>Operation</th><th>Implementation</th><th>Why Not Claude</th></tr>
  <tr>
    <td>Intent matching (60-70%)</td>
    <td><code>pre-router.js</code> — 17 pattern groups</td>
    <td>Bare "more", "1", "free", "hey", and follow-up filters ("how about comedy", "later tonight") don't need semantic understanding. Pattern matching is instant and deterministic.</td>
  </tr>
  <tr>
    <td>Neighborhood resolution</td>
    <td><code>neighborhoods.js</code> — alias map, landmarks, subway stops</td>
    <td>36 neighborhoods with known aliases. A lookup table is faster and more reliable than inference.</td>
  </tr>
  <tr>
    <td>Event filtering + ranking</td>
    <td><code>geo.js</code> — proximity, time, haversine</td>
    <td>Math. Haversine distance, date comparison, upcoming-only filtering. Claude adds nothing here.</td>
  </tr>
  <tr>
    <td>Kids event filtering</td>
    <td><code>curation.js:filterKidsEvents()</code></td>
    <td>Pattern matching on "kids", "storytime", "toddler" etc. Was in the compose prompt — moved to code because it's a simple regex check, not a judgment call.</td>
  </tr>
  <tr>
    <td>Perennial activity validation</td>
    <td><code>curation.js:validatePerennialActivity()</code></td>
    <td>Checking if a bar description mentions "trivia", "jazz", "DJ" etc. Deterministic — the prompt told Claude the same regex logic in English.</td>
  </tr>
  <tr>
    <td>Cross-source dedup</td>
    <td><code>events.js</code> — MD5 hash of name|venue|date</td>
    <td>Deterministic identity matching. Claude would hallucinate connections.</td>
  </tr>
  <tr>
    <td>Venue geocoding</td>
    <td><code>venues.js</code> — auto-learning + Nominatim</td>
    <td>Lat/lng lookup. Sources with coords teach the venue map; others consume it.</td>
  </tr>
  <tr>
    <td>14 source scrapers (code-based)</td>
    <td><code>sources/*.js</code> — JSON-LD, APIs, Cheerio</td>
    <td>Structured sources have reliable APIs or JSON-LD. Parsing is mechanical, not interpretive.</td>
  </tr>
  <tr>
    <td>Session + state management</td>
    <td><code>session.js</code>, <code>handler.js</code></td>
    <td>CRUD state. No interpretation needed.</td>
  </tr>
</table>

<h3>The Composable Skills Architecture</h3>
<p>The compose prompt was decomposed to match this philosophy: Claude should only see instructions relevant to the current request.</p>

<table>
  <tr><th>Before (monolith)</th><th>After (skills)</th></tr>
  <tr>
    <td>Every compose call sent all 13 rules (~3,600 tokens) — perennial framing, venue framing, kids filtering, neighborhood mismatch handling — even when none of those situations applied.</td>
    <td>Core prompt (~1,400 tokens) + only the conditional skills that apply. A simple "East Village tonight" request gets core + tonight-priority + source-tiers (~1,500 tokens). A last-batch-with-perennials request adds perennial-framing + last-batch.</td>
  </tr>
  <tr>
    <td>4 sites in intent-handlers.js built raw <code>extraContext</code> strings with inline prompt overrides like "OVERRIDE CLOSING LINE: Instead of 'Reply 1-N for details, MORE for extra picks'..."</td>
    <td>Structured <code>skills</code> objects: <code>{ isLastBatch: true, exhaustionSuggestion: "..." }</code>. The prompt builder selects and formats the right skill modules.</td>
  </tr>
  <tr>
    <td>Deterministic rules ("skip NYC Parks kids events", "only recommend perennials with specific activities") burned prompt tokens asking Claude to do pattern matching.</td>
    <td><code>curation.js</code> runs these filters before events reach Claude. The events Claude sees are already curated — it focuses on taste and writing.</td>
  </tr>
</table>

<div class="annotation">
  <strong>Design principle:</strong> Claude's attention budget is finite. Every token of instructions competes for influence over the output. By sending only relevant instructions and moving deterministic logic to code, we let Claude spend its capacity on what it's uniquely good at: taste, voice, and judgment under constraints.
</div>

<h3>Remaining Opportunities</h3>

<div class="opportunity">
  <strong>Curator / Writer split:</strong> composeResponse() still asks Claude to both PICK events and WRITE the SMS in one call. These are distinct skills — curation (judgment) and copywriting (voice). Splitting into two calls would let each be tuned independently, but adds latency. Current Haiku perf makes the single call acceptable.
</div>

<div class="opportunity">
  <strong>Neighborhood resolution consolidation:</strong> Done by Claude (in route prompt), extractNeighborhood() (regex), and detectBorough() (regex). Three systems that can disagree. The pre-router's code-side resolution handles most cases; Claude's version is only needed for semantic slang ("the village", "by prospect park").
</div>

<div class="opportunity">
  <strong>Extraction prompt skills:</strong> EXTRACTION_PROMPT is the one remaining monolith (~1,600 tokens). It handles venue-vs-event distinction, date resolution, confidence scoring, and output format all in one. Could be decomposed per-source-type if extraction quality diverges across sources.
</div>
</section>

</div>

<script>
function togglePrompt(header) {
  const content = header.nextElementSibling;
  content.classList.toggle('hidden');
  header.classList.toggle('collapsed');
}

// Nav highlighting
const sections = document.querySelectorAll('section[id]');
const navLinks = document.querySelectorAll('.nav a');

function updateNav() {
  let current = '';
  for (const section of sections) {
    const top = section.offsetTop - 80;
    if (scrollY >= top) current = section.id;
  }
  navLinks.forEach(link => {
    link.classList.toggle('active', link.getAttribute('href') === '#' + current);
  });
}
window.addEventListener('scroll', updateNav, { passive: true });
updateNav();
</script>
</body>
</html>
