<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pulse — Architecture</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:ital,wght@0,400;0,500;0,700;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #08070d;
      --bg-card: rgba(255,255,255,0.03);
      --bg-card-hover: rgba(255,255,255,0.05);
      --text: #ede9e3;
      --text-dim: #7a756d;
      --text-muted: #4a463f;
      --coral: #ff6b42;
      --coral-dim: rgba(255,107,66,0.12);
      --blue: #58a6ff;
      --green: #3fb950;
      --purple: #d2a8ff;
      --yellow: #f0883e;
      --font-display: 'Syne', sans-serif;
      --font-body: 'DM Sans', sans-serif;
      --font-mono: 'DM Mono', monospace;
      --radius: 20px;
      --radius-sm: 12px;
      --max-w: 900px;
    }

    html { scroll-behavior: smooth; }

    body {
      font-family: var(--font-body);
      background: var(--bg);
      color: var(--text);
      line-height: 1.7;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* NAV */
    nav {
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(24px) saturate(1.4);
      -webkit-backdrop-filter: blur(24px) saturate(1.4);
      background: rgba(8,7,13,0.8);
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .nav-inner {
      max-width: var(--max-w);
      margin: 0 auto;
      padding: 18px 28px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .nav-logo {
      font-family: var(--font-display);
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--coral);
      text-decoration: none;
      letter-spacing: -0.02em;
    }
    .nav-sep {
      color: var(--text-muted);
      font-size: 1.2rem;
      font-weight: 300;
    }
    .nav-page {
      font-family: var(--font-display);
      font-size: 0.88rem;
      font-weight: 700;
      color: var(--text-dim);
      letter-spacing: -0.01em;
    }

    /* LAYOUT */
    .container { max-width: var(--max-w); margin: 0 auto; padding: 0 28px; }

    .page-header {
      padding: 72px 0 48px;
    }
    .page-header h1 {
      font-family: var(--font-display);
      font-size: clamp(2rem, 4vw, 2.8rem);
      font-weight: 800;
      line-height: 1.1;
      letter-spacing: -0.035em;
      margin-bottom: 12px;
    }
    .page-header h1 em { font-style: normal; color: var(--coral); }
    .page-header .subtitle {
      color: var(--text-dim);
      font-size: 1.05rem;
      max-width: 600px;
      line-height: 1.65;
    }

    /* SECTIONS */
    section {
      padding: 56px 0;
      border-top: 1px solid rgba(255,255,255,0.04);
    }
    .section-label {
      font-family: var(--font-display);
      text-transform: uppercase;
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.18em;
      color: var(--coral);
      margin-bottom: 10px;
    }
    .section-title {
      font-family: var(--font-display);
      font-size: clamp(1.4rem, 3vw, 1.8rem);
      font-weight: 800;
      letter-spacing: -0.03em;
      line-height: 1.15;
      margin-bottom: 20px;
    }
    .section-body {
      color: var(--text-dim);
      font-size: 0.92rem;
      line-height: 1.75;
      max-width: 700px;
    }
    .section-body p + p { margin-top: 12px; }
    .section-body strong { color: var(--text); font-weight: 600; }

    /* CARDS */
    .card {
      background: var(--bg-card);
      border: 1px solid rgba(255,255,255,0.04);
      border-radius: var(--radius);
      padding: 24px;
      margin-top: 20px;
    }
    .card h3 {
      font-family: var(--font-display);
      font-size: 0.95rem;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -0.01em;
    }
    .card p {
      color: var(--text-dim);
      font-size: 0.88rem;
      line-height: 1.65;
    }
    .card-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 20px;
    }

    /* FLOW DIAGRAMS */
    .flow {
      margin-top: 24px;
      display: flex;
      flex-direction: column;
      gap: 0;
      align-items: center;
    }
    .flow-node {
      padding: 14px 24px;
      border-radius: var(--radius-sm);
      font-family: var(--font-mono);
      font-size: 0.82rem;
      text-align: center;
      max-width: 360px;
      width: 100%;
      position: relative;
    }
    .flow-node .label {
      font-family: var(--font-body);
      font-size: 0.75rem;
      color: var(--text-dim);
      margin-top: 4px;
      font-style: italic;
    }
    .flow-arrow {
      width: 1px;
      height: 20px;
      background: rgba(255,255,255,0.12);
      position: relative;
    }
    .flow-arrow::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: -3px;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 5px solid rgba(255,255,255,0.12);
    }
    .flow-split {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      width: 100%;
      max-width: 460px;
    }
    .flow-split .flow-node { flex: 1; }

    .node-coral { background: var(--coral-dim); border: 1px solid rgba(255,107,66,0.2); color: var(--coral); }
    .node-blue { background: rgba(88,166,255,0.08); border: 1px solid rgba(88,166,255,0.15); color: var(--blue); }
    .node-green { background: rgba(63,185,80,0.08); border: 1px solid rgba(63,185,80,0.15); color: var(--green); }
    .node-purple { background: rgba(210,168,255,0.08); border: 1px solid rgba(210,168,255,0.15); color: var(--purple); }
    .node-yellow { background: rgba(240,136,62,0.08); border: 1px solid rgba(240,136,62,0.15); color: var(--yellow); }
    .node-dim { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); color: var(--text-dim); }

    /* TABLES */
    .table-wrap {
      margin-top: 20px;
      overflow-x: auto;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.04);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.84rem;
    }
    thead th {
      text-align: left;
      font-family: var(--font-display);
      font-weight: 700;
      font-size: 0.75rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-dim);
      padding: 12px 16px;
      background: rgba(255,255,255,0.02);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    tbody td {
      padding: 10px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.03);
      color: var(--text-dim);
      vertical-align: top;
    }
    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover { background: rgba(255,255,255,0.02); }
    .source-name { color: var(--text); font-weight: 600; }
    .weight-high { color: var(--green); }
    .weight-mid { color: var(--blue); }
    .weight-low { color: var(--yellow); }

    /* CODE BLOCKS */
    .code-block {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--radius-sm);
      padding: 16px 20px;
      font-family: var(--font-mono);
      font-size: 0.8rem;
      line-height: 1.7;
      color: var(--text-dim);
      overflow-x: auto;
      margin-top: 16px;
      white-space: pre;
    }
    .code-block .hl { color: var(--coral); }
    .code-block .hl-blue { color: var(--blue); }
    .code-block .hl-green { color: var(--green); }
    .code-block .hl-dim { color: var(--text-muted); }

    /* INLINE MONO */
    code {
      font-family: var(--font-mono);
      font-size: 0.85em;
      background: rgba(255,255,255,0.05);
      padding: 2px 6px;
      border-radius: 4px;
      color: var(--coral);
    }

    /* STAT PILLS */
    .stats {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 16px;
    }
    .stat {
      padding: 8px 16px;
      border-radius: 100px;
      font-size: 0.78rem;
      font-weight: 600;
      border: 1px solid rgba(255,255,255,0.06);
      color: var(--text-dim);
    }
    .stat em { font-style: normal; color: var(--coral); }

    /* EXAMPLES */
    .example {
      background: var(--bg-card);
      border: 1px solid rgba(255,255,255,0.04);
      border-radius: var(--radius-sm);
      padding: 16px 20px;
      margin-top: 12px;
    }
    .example-turn {
      display: flex;
      gap: 12px;
      align-items: baseline;
      font-size: 0.85rem;
      padding: 4px 0;
    }
    .example-turn + .example-turn { border-top: 1px solid rgba(255,255,255,0.03); padding-top: 8px; margin-top: 4px; }
    .turn-user {
      font-weight: 700;
      color: var(--coral);
      flex-shrink: 0;
      min-width: 36px;
    }
    .turn-system {
      font-weight: 700;
      color: var(--blue);
      flex-shrink: 0;
      min-width: 36px;
    }
    .turn-msg { color: var(--text); }
    .turn-route {
      color: var(--text-muted);
      font-size: 0.78rem;
      font-style: italic;
      margin-left: auto;
      flex-shrink: 0;
    }

    /* LAYER LIST */
    .layer-list {
      list-style: none;
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .layer-list li {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      font-size: 0.88rem;
      color: var(--text-dim);
    }
    .layer-num {
      font-family: var(--font-display);
      font-weight: 800;
      font-size: 0.85rem;
      color: var(--coral);
      min-width: 20px;
      flex-shrink: 0;
    }
    .layer-list li strong { color: var(--text); font-weight: 600; }

    /* FOOTER */
    footer {
      border-top: 1px solid rgba(255,255,255,0.04);
      padding: 40px 0;
      margin-top: 40px;
    }
    .footer-inner {
      max-width: var(--max-w);
      margin: 0 auto;
      padding: 0 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .footer-brand {
      font-family: var(--font-display);
      font-size: 1rem;
      font-weight: 800;
      color: var(--coral);
    }
    .footer-note {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* COLLAPSIBLE DETAILS */
    details {
      background: var(--bg-card);
      border: 1px solid rgba(255,255,255,0.04);
      border-radius: var(--radius);
      margin-top: 12px;
      overflow: hidden;
      transition: border-color 0.2s;
    }
    details[open] {
      border-color: rgba(255,255,255,0.08);
    }
    details summary {
      padding: 18px 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      list-style: none;
      font-family: var(--font-display);
      font-size: 0.95rem;
      font-weight: 700;
      letter-spacing: -0.01em;
      user-select: none;
      transition: background 0.15s;
    }
    details summary:hover { background: var(--bg-card-hover); }
    details summary::-webkit-details-marker { display: none; }
    details summary::before {
      content: '';
      display: inline-block;
      width: 0;
      height: 0;
      border-left: 5px solid var(--text-muted);
      border-top: 4px solid transparent;
      border-bottom: 4px solid transparent;
      flex-shrink: 0;
      transition: transform 0.2s;
    }
    details[open] summary::before {
      transform: rotate(90deg);
    }
    details summary .step-label {
      color: var(--coral);
      font-size: 0.78rem;
      font-weight: 700;
      letter-spacing: 0.04em;
    }
    details summary .step-preview {
      color: var(--text-muted);
      font-size: 0.82rem;
      font-weight: 400;
      font-family: var(--font-body);
      margin-left: auto;
      flex-shrink: 0;
    }
    details .detail-body {
      padding: 0 24px 20px;
    }
    details .detail-body p {
      color: var(--text-dim);
      font-size: 0.88rem;
      line-height: 1.65;
    }
    details .detail-body p + p { margin-top: 8px; }
    details .detail-body strong { color: var(--text); font-weight: 600; }
    details .detail-body ul {
      padding-left: 20px;
      color: var(--text-dim);
      font-size: 0.88rem;
      line-height: 1.8;
      margin-top: 8px;
    }

    /* Skill-specific: condition tag */
    .skill-condition {
      color: var(--text-muted);
      font-weight: 400;
      font-size: 0.82rem;
      font-family: var(--font-body);
    }

    /* RESPONSIVE */
    @media (max-width: 680px) {
      .card-grid { grid-template-columns: 1fr; }
      .flow-split { flex-direction: column; align-items: center; }
      .page-header { padding: 56px 0 36px; }
      section { padding: 40px 0; }
      .turn-route { display: none; }
      .footer-inner { flex-direction: column; gap: 8px; text-align: center; }
    }
  </style>
</head>
<body>

<nav>
  <div class="nav-inner">
    <a href="index.html" class="nav-logo">Pulse</a>
    <span class="nav-sep">/</span>
    <span class="nav-page">Architecture</span>
  </div>
</nav>

<!-- Header -->
<header class="page-header">
  <div class="container">
    <h1>How Pulse <em>works</em></h1>
    <p class="subtitle">A text message comes in. 18 scrapers, a unified AI layer, a tagged event pool, and a 480-character limit later, a recommendation goes out.</p>
  </div>
</header>

<!-- 1. System Overview -->
<section id="overview">
  <div class="container">
    <p class="section-label">Overview</p>
    <h2 class="section-title">Text in, picks out</h2>
    <div class="section-body">
      <p>Pulse is an SMS-based AI assistant that recommends NYC nightlife and events. A user texts a neighborhood name and gets back curated picks within seconds. The entire experience happens in a single SMS thread &mdash; no app, no account, no links until asked.</p>
      <p>Behind the scenes, Pulse scrapes <strong>18 event sources</strong> every morning, deduplicates and caches them in memory, then uses a lightweight <strong>pre-router</strong> for mechanical shortcuts and a <strong>unified AI call</strong> (Claude Haiku) for everything semantic &mdash; understanding intent, picking events from a tagged pool, and writing the SMS in a single pass.</p>
    </div>

    <div class="stats">
      <span class="stat"><em>18</em> event sources</span>
      <span class="stat"><em>36</em> neighborhoods</span>
      <span class="stat"><em>480</em> char SMS cap</span>
      <span class="stat"><em>~15%</em> pre-routed (zero AI)</span>
      <span class="stat"><em>2hr</em> session TTL</span>
    </div>
  </div>
</section>

<!-- 2. End-to-End Walkthrough -->
<section id="walkthrough">
  <div class="container">
    <p class="section-label">Walkthrough</p>
    <h2 class="section-title">What happens when you text "williamsburg"</h2>
    <div class="section-body">
      <p>Let's trace a single message through the entire system. A user with no session history texts <strong>"williamsburg"</strong> at 7:14 PM on a Friday.</p>
    </div>

    <details open style="margin-top: 24px;">
      <summary><span class="step-label">Step 1</span> Guard rails <span class="step-preview">&lt;1ms, $0</span></summary>
      <div class="detail-body">
        <p><code>handler.js</code> receives the Twilio webhook. Three checks run before any processing:</p>
        <ul>
          <li><strong>TCPA check</strong> &mdash; Is this "STOP", "UNSUBSCRIBE", "CANCEL", or "QUIT"? If yes, drop silently (no reply). Twilio manages the opt-out list; we just make sure no response leaks.</li>
          <li><strong>Dedup</strong> &mdash; Has this MessageSid been seen in the last 5 minutes? Twilio retries on timeout, so this prevents double-processing.</li>
          <li><strong>Budget</strong> &mdash; Has this phone number spent over $0.10 in AI costs today? If so, send a friendly limit message and stop. Pricing is provider-aware (Haiku input: $1/M tokens, Gemini: $0.10/M).</li>
        </ul>
        <p>"williamsburg" passes all three. Cost so far: <strong style="color: var(--green);">$0.00</strong>. Latency: <strong style="color: var(--green);">&lt;1ms</strong>.</p>
      </div>
    </details>

    <details>
      <summary><span class="step-label">Step 2</span> Routing &mdash; pre-router miss, unified LLM <span class="step-preview">~400ms, ~$0.001</span></summary>
      <div class="detail-body">
        <p><code>pre-router.js</code> checks the message against mechanical shortcuts: help, numbers 1-5, "more", greetings, thanks, bye, impatient follow-ups, and event name matches from session picks. "williamsburg" doesn't match any of these &mdash; it's a semantic request that needs real understanding.</p>
        <p>The message falls through to the <strong>unified LLM</strong> path. Before calling the LLM, the handler resolves the neighborhood from the message, fetches events, builds a tagged pool, and assembles the full context. The LLM handles intent understanding, event selection, and SMS composition in a single call.</p>
        <p>The pre-router only handles ~15% of messages &mdash; purely mechanical patterns where no AI is needed. Everything semantic (neighborhoods, categories, vibes, compound queries, off-topic deflection) goes through the unified LLM for better understanding.</p>
      </div>
    </details>

    <details>
      <summary><span class="step-label">Step 3</span> Filter resolution &amp; tagged pool <span class="step-preview">deterministic, $0</span></summary>
      <div class="detail-body">
        <p>Before calling the LLM, the handler builds the event context deterministically:</p>
        <ul>
          <li><strong>Neighborhood extraction</strong> &mdash; <code>extractNeighborhood("williamsburg")</code> resolves the alias to "Williamsburg" from the 36-neighborhood map, including aliases and landmarks.</li>
          <li><strong>Filter resolution</strong> &mdash; <code>mergeFilters(session.lastFilters, incoming)</code> compounds active filters. For a first message, filters are empty. On follow-ups like "how about comedy", the category filter is merged with any existing filters.</li>
          <li><strong>Tagged pool</strong> &mdash; <code>buildTaggedPool(events, activeFilters)</code> tags each event with <code>filter_match: true/false</code>. Matched events come first (up to 10), padded to 15 with unmatched events. The LLM sees <code>[MATCH]</code> tags on matching events but gets the full pool.</li>
        </ul>
        <p style="margin-top: 12px;">This is the key architectural decision: <strong>the handler owns all filter state</strong>. The LLM never manages filters &mdash; it just sees a tagged pool and composes from it. Filters persist deterministically across neighborhood switches, nudge accepts, and conversational responses.</p>
      </div>
    </details>

    <details>
      <summary><span class="step-label">Step 4</span> Event fetching &amp; curation <span class="step-preview">14 &rarr; 15 tagged events</span></summary>
      <div class="detail-body">
        <p><code>getEvents("Williamsburg")</code> queries the in-memory cache. The cache was built at 10am from 18 scrapers. Events are already deduped and sorted by proximity to Williamsburg's center coordinates.</p>
        <p>Say it returns 14 events. Before entering the tagged pool, <code>curation.js</code> runs deterministic quality filters:</p>
        <ul>
          <li><strong>filterKidsEvents</strong> &mdash; Drops NYC Parks events that match children's patterns ("storytime", "toddler", "ages 3-5"). Without this, Claude would occasionally recommend a toddler puppet show alongside a DJ set.</li>
          <li><strong>filterIncomplete</strong> &mdash; Drops events below a completeness threshold (missing name, venue, or time). Prevents Claude from recommending "TBA at TBD".</li>
          <li><strong>validatePerennialActivity</strong> &mdash; Perennial picks (always-good bars/venues) are only included if they have a specific activity tonight (trivia, live jazz, DJ). Removes generic "nice bar" suggestions that don't answer "what's happening tonight?"</li>
        </ul>
        <p>After curation: 12 events remain. Plus 2 perennial picks with tonight activities. <code>buildTaggedPool()</code> tags each event as <code>[MATCH]</code> or unmatched based on active filters, then sends up to 15 to the unified LLM (matched first, padded with unmatched). For this filterless first message, all events are unmatched &mdash; the LLM picks freely.</p>
      </div>
    </details>

    <details>
      <summary><span class="step-label">Step 5</span> Prompt assembly <span class="step-preview">5 of 12 skills ON</span></summary>
      <div class="detail-body">
        <p><code>buildUnifiedPrompt()</code> assembles the system prompt from the <code>UNIFIED_SYSTEM</code> base plus conditional skill modules. The user prompt includes the tagged event pool (with <code>[MATCH]</code> tags), any active filter context (<code>ACTIVE_FILTER</code>, <code>MATCH_COUNT</code>, <code>SPARSE</code>), conversation history, and the user's message. For this first-message-to-Williamsburg request:</p>
        <div style="margin-top: 8px; display: flex; flex-direction: column; gap: 6px;">
          <div style="display: flex; gap: 8px; align-items: baseline;">
            <span style="color: var(--green); font-size: 0.82rem; font-weight: 700; min-width: 18px;">ON</span>
            <span style="color: var(--text); font-weight: 600; font-size: 0.88rem;">core</span>
            <span style="color: var(--text-dim); font-size: 0.82rem;">&mdash; always included. Persona, format, 480-char limit.</span>
          </div>
          <div style="display: flex; gap: 8px; align-items: baseline;">
            <span style="color: var(--green); font-size: 0.82rem; font-weight: 700; min-width: 18px;">ON</span>
            <span style="color: var(--text); font-weight: 600; font-size: 0.88rem;">sourceTiers</span>
            <span style="color: var(--text-dim); font-size: 0.82rem;">&mdash; always included. Tells Claude to prefer Skint/Nonsense picks over Eventbrite.</span>
          </div>
          <div style="display: flex; gap: 8px; align-items: baseline;">
            <span style="color: var(--green); font-size: 0.82rem; font-weight: 700; min-width: 18px;">ON</span>
            <span style="color: var(--text); font-weight: 600; font-size: 0.88rem;">tonightPriority</span>
            <span style="color: var(--text-dim); font-size: 0.82rem;">&mdash; at least one event is today. Tells Claude: a decent tonight event beats a great tomorrow event.</span>
          </div>
          <div style="display: flex; gap: 8px; align-items: baseline;">
            <span style="color: var(--green); font-size: 0.82rem; font-weight: 700; min-width: 18px;">ON</span>
            <span style="color: var(--text); font-weight: 600; font-size: 0.88rem;">perennialFraming</span>
            <span style="color: var(--text-dim); font-size: 0.82rem;">&mdash; batch includes perennial picks. Tells Claude: lead with the activity, not the venue name.</span>
          </div>
          <div style="display: flex; gap: 8px; align-items: baseline;">
            <span style="color: var(--green); font-size: 0.82rem; font-weight: 700; min-width: 18px;">ON</span>
            <span style="color: var(--text); font-weight: 600; font-size: 0.88rem;">nearbySuggestion</span>
            <span style="color: var(--text-dim); font-size: 0.82rem;">&mdash; nearby hoods provided. Claude can suggest Greenpoint/Bushwick if picks are thin.</span>
          </div>
          <div style="display: flex; gap: 8px; align-items: baseline;">
            <span style="color: var(--text-muted); font-size: 0.82rem; font-weight: 700; min-width: 18px;">off</span>
            <span style="color: var(--text-muted); font-weight: 600; font-size: 0.88rem;">neighborhoodMismatch</span>
            <span style="color: var(--text-muted); font-size: 0.82rem;">&mdash; events ARE in Williamsburg, so no mismatch disclaimer needed.</span>
          </div>
          <div style="display: flex; gap: 8px; align-items: baseline;">
            <span style="color: var(--text-muted); font-size: 0.82rem; font-weight: 700; min-width: 18px;">off</span>
            <span style="color: var(--text-muted); font-weight: 600; font-size: 0.88rem;">freeEmphasis / activityAdherence / conversationAwareness</span>
            <span style="color: var(--text-muted); font-size: 0.82rem;">&mdash; no filters, no activity keyword, no history.</span>
          </div>
        </div>
        <p style="margin-top: 12px;">The assembled prompt is ~800 tokens. Without the skills system, the prompt would always include every instruction (~1,400 tokens), wasting context on irrelevant rules and sometimes confusing Claude. For example, including "ACTIVITY ADHERENCE" when the user didn't ask for a specific activity caused Claude to over-filter and return fewer picks.</p>
      </div>
    </details>

    <details>
      <summary><span class="step-label">Step 6</span> Unified LLM call <span class="step-preview">~800ms, ~$0.001</span></summary>
      <div class="detail-body">
        <p><code>unifiedRespond()</code> sends the assembled system prompt (base + skills), the tagged event pool, filter context, conversation history, and the user's message to <strong>Claude Haiku</strong> in a single call. Claude understands the intent, picks 2-3 events from the pool, and writes the SMS text &mdash; all in one pass.</p>
        <p>Claude returns structured JSON:</p>
        <div class="code-block" style="margin-top: 8px;">{
  "sms_text": "Tonight in Williamsburg:\n\n1) DJ set at Good Room — always goes off on Fridays. 10pm, $15\n\n2) Indie at Baby's All Right — solid lineup tonight. 8pm, $18\n\n3) Free comedy at Muchmore's — underground standup, BYOB vibes. 9pm\n\nReply 1-3 for details or MORE for extra picks",
  "picks": [
    { "rank": 1, "event_id": "dice-good-room-0221", "why": "reliable Friday DJ night" },
    { "rank": 2, "event_id": "bv-babys-0221", "why": "strong indie lineup" },
    { "rank": 3, "event_id": "skint-muchmores-0221", "why": "free comedy, unique" }
  ],
  "neighborhood_used": "Williamsburg",
  "filters_used": { "category": null, "free_only": false, "vibe": null, "time_after": null },
  "clear_filters": false
}</div>
        <p>The <code>sourceTiers</code> skill told Claude to prefer the Skint pick (#3), and it was chosen despite being free &mdash; the curation taste in <code>core</code> favors "unique one-off events."</p>
        <p>Cost: ~$0.001 (Haiku, single call). Latency: ~800ms. This is cheaper than the old two-call flow (route + compose) because everything happens in one pass.</p>
      </div>
    </details>

    <details>
      <summary><span class="step-label">Step 7</span> Send, save &amp; persist filters <span class="step-preview">289 of 480 chars</span></summary>
      <div class="detail-body">
        <p>The SMS text (289 characters, under the 480-char cap) is sent via Twilio. The handler saves the session atomically via <code>saveResponseFrame()</code> &mdash; picks, event map, neighborhood, and <strong>active filters</strong>. Filters are persisted deterministically by the handler, not from the LLM's output. A JSONL trace captures the full request for evals.</p>
        <p>Now when the user texts <strong>"2"</strong>, the pre-router matches it as <code>intent: "details"</code>, looks up pick #2 (Baby's All Right) from <code>session.lastPicks</code>, and sends the full event details with a link. No AI call needed ($0).</p>
        <p>When they text <strong>"how about comedy"</strong>, it falls through to the unified LLM. The handler merges <code>{ category: "comedy" }</code> with any existing filters, builds a new tagged pool with comedy events marked <code>[MATCH]</code>, and the LLM composes picks that prefer the matches (~$0.001).</p>
      </div>
    </details>

    <div class="card">
      <h3>Total cost &amp; timing</h3>
      <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 4px;">
        <div>
          <div style="font-family: var(--font-display); font-size: 1.2rem; font-weight: 800; color: var(--coral);">~$0.001</div>
          <div style="font-size: 0.78rem; color: var(--text-muted);">AI cost (1 unified Haiku call)</div>
        </div>
        <div>
          <div style="font-family: var(--font-display); font-size: 1.2rem; font-weight: 800; color: var(--coral);">~1.2s</div>
          <div style="font-size: 0.78rem; color: var(--text-muted);">total latency</div>
        </div>
        <div>
          <div style="font-family: var(--font-display); font-size: 1.2rem; font-weight: 800; color: var(--coral);">1</div>
          <div style="font-size: 0.78rem; color: var(--text-muted);">AI call (unified)</div>
        </div>
        <div>
          <div style="font-family: var(--font-display); font-size: 1.2rem; font-weight: 800; color: var(--coral);">289</div>
          <div style="font-size: 0.78rem; color: var(--text-muted);">chars (of 480 max)</div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- 3. Data Pipeline -->
<section id="data-pipeline">
  <div class="container">
    <p class="section-label">Data Pipeline</p>
    <h2 class="section-title">Daily scrape, in-memory cache</h2>
    <div class="section-body">
      <p>Every morning at 10am ET, Pulse runs all 18 scrapers in parallel. Each scraper extracts structured event data from its source &mdash; parsing HTML, hitting APIs, or using Claude to extract from newsletters. Events are deduped across sources (hashed by name + venue + date), ranked by source trust weight, and cached in memory. No scraping happens in the hot request path.</p>
    </div>

    <div class="flow">
      <div class="flow-node node-yellow">10am ET &mdash; daily cron trigger</div>
      <div class="flow-arrow"></div>
      <div class="flow-node node-blue">
        sources/ &mdash; 18 scrapers in parallel
        <div class="label">Skint, RA, Dice, Eventbrite, Songkick, BrooklynVegan, NYC Parks, Nonsense NYC, Oh My Rockness, DoNYC, BAM, SmallsLIVE, NYPL, Ticketmaster, Yutori, Tavily</div>
      </div>
      <div class="flow-arrow"></div>
      <div class="flow-node node-green">
        venues.js &mdash; auto-learn coordinates
        <div class="label">Sources with lat/lng teach the shared venue map</div>
      </div>
      <div class="flow-arrow"></div>
      <div class="flow-node node-purple">
        events.js &mdash; dedup, rank, cache
        <div class="label">Cross-source dedup by name+venue+date. Higher-trust source wins.</div>
      </div>
    </div>
  </div>
</section>

<!-- 3. Message Flow -->
<section id="message-flow">
  <div class="container">
    <p class="section-label">Message Flow</p>
    <h2 class="section-title">Two paths, seven layers</h2>
    <div class="section-body">
      <p>Each message takes one of two paths. ~15% are <strong>mechanical shortcuts</strong> (help, numbers, "more", greetings) handled instantly by the pre-router with zero AI cost. The other ~85% go through the <strong>unified LLM path</strong> where a single Claude Haiku call handles intent, event selection, and SMS composition. Not every layer runs on every request &mdash; "details" only needs the session, "more" reuses the existing pool.</p>
    </div>

    <div class="flow">
      <div class="flow-node node-coral">
        <strong>1. Incoming SMS</strong>
        <div class="label">Twilio webhook delivers the message to handler.js</div>
      </div>
      <div class="flow-arrow"></div>
      <div class="flow-node node-dim">
        <strong>2. Guard rails</strong>
        <div class="label">TCPA opt-out &rarr; dedup (5min MessageSid cache) &rarr; $0.10/day AI budget</div>
      </div>
      <div class="flow-arrow"></div>
      <div class="flow-node node-blue">
        <strong>3. Pre-router</strong>
        <div class="label">Mechanical shortcuts (~15%): help, numbers 1-5, "more", greetings, event name match. $0.</div>
      </div>
      <div class="flow-arrow"></div>
      <div class="flow-node node-green">
        <strong>4. Filter resolution &amp; tagged pool</strong>
        <div class="label">mergeFilters() &rarr; getEvents() &rarr; curation &rarr; buildTaggedPool() with [MATCH] tags. $0.</div>
      </div>
      <div class="flow-arrow"></div>
      <div class="flow-node node-yellow">
        <strong>5. Prompt assembly</strong>
        <div class="label">UNIFIED_SYSTEM base + conditional skill modules + ACTIVE_FILTER/SPARSE context</div>
      </div>
      <div class="flow-arrow"></div>
      <div class="flow-node node-purple">
        <strong>6. Unified LLM call</strong>
        <div class="label">Claude Haiku: intent + event selection + SMS text in one pass. ~$0.001.</div>
      </div>
      <div class="flow-arrow"></div>
      <div class="flow-node node-coral">
        <strong>7. Send, save &amp; persist filters</strong>
        <div class="label">SMS via Twilio &rarr; saveResponseFrame() (picks, filters, neighborhood) &rarr; JSONL trace</div>
      </div>
    </div>
  </div>
</section>

<!-- 4. Routing & Filters -->
<section id="routing">
  <div class="container">
    <p class="section-label">Routing</p>
    <h2 class="section-title">Pre-router + unified LLM</h2>
    <div class="section-body">
      <p>The <strong>pre-router</strong> handles only mechanical shortcuts &mdash; patterns that need zero semantic understanding. Everything else goes through a <strong>single unified Claude Haiku call</strong> that handles intent, event selection, and SMS composition in one pass. Filter state is owned entirely by the handler, not the LLM.</p>
    </div>

    <div class="card-grid">
      <div class="card">
        <h3>Pre-router (~15%, $0)</h3>
        <p>Mechanical shortcuts only: help, numbers 1-5 for details, "more" for next batch, greetings/thanks/bye, event name match from session, impatient follow-ups ("hello??"), and explicit filter clearing ("forget the comedy").</p>
      </div>
      <div class="card">
        <h3>Unified LLM (~85%, ~$0.001)</h3>
        <p>Everything semantic: neighborhoods, categories, vibes, time, free events, compound queries ("free jazz in williamsburg tonight"), nudge accepts, borough handling, off-topic deflection. Single Claude Haiku call with a tagged event pool.</p>
      </div>
    </div>

    <div class="example" style="margin-top: 20px;">
      <div class="example-turn">
        <span class="turn-user">User</span>
        <span class="turn-msg">"williamsburg"</span>
        <span class="turn-route">unified LLM &rarr; ~$0.001</span>
      </div>
      <div class="example-turn">
        <span class="turn-user">User</span>
        <span class="turn-msg">"how about comedy"</span>
        <span class="turn-route">unified LLM + [MATCH] tags &rarr; ~$0.001</span>
      </div>
      <div class="example-turn">
        <span class="turn-user">User</span>
        <span class="turn-msg">"2"</span>
        <span class="turn-route">pre-router &rarr; details &rarr; $0</span>
      </div>
      <div class="example-turn">
        <span class="turn-user">User</span>
        <span class="turn-msg">"more"</span>
        <span class="turn-route">pre-router &rarr; more &rarr; ~$0.001</span>
      </div>
      <div class="example-turn">
        <span class="turn-user">User</span>
        <span class="turn-msg">"any more free comedy stuff"</span>
        <span class="turn-route">unified LLM + compound filters &rarr; ~$0.001</span>
      </div>
      <div class="example-turn">
        <span class="turn-user">User</span>
        <span class="turn-msg">"forget the comedy"</span>
        <span class="turn-route">pre-router &rarr; clear_filters &rarr; ~$0.001</span>
      </div>
    </div>

    <div class="card" style="margin-top: 20px;">
      <h3>Tagged event pool &amp; deterministic filter state</h3>
      <p>When a user applies filters (category, time, vibe, free), the handler compounds them deterministically via <code>mergeFilters()</code> and builds a tagged pool via <code>buildTaggedPool()</code>. Each event is tagged <code>[MATCH]</code> or unmatched. The LLM sees the full pool but prefers <code>[MATCH]</code> events. When matches are sparse (&lt;3), the LLM gets a <code>SPARSE</code> flag and honestly acknowledges limited options instead of silently omitting the filter.</p>
      <p style="margin-top: 8px;">Filters persist across neighborhood switches, nudge accepts, and conversational responses. The LLM never manages filter state &mdash; it only composes from what the handler provides.</p>
    </div>
  </div>
</section>

<!-- 5. Source Registry -->
<section id="sources">
  <div class="container">
    <p class="section-label">Sources</p>
    <h2 class="section-title">18 event sources, ranked by trust</h2>
    <div class="section-body">
      <p>Events are deduplicated across sources using a hash of name + venue + date. When the same event appears in multiple sources, the version from the higher-trust source wins. Sources with geo data (lat/lng) also teach venue coordinates to the shared venue map.</p>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Source</th>
            <th>Weight</th>
            <th>Method</th>
            <th>Specialty</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="source-name">Skint</td>
            <td class="weight-high">0.9</td>
            <td>HTML &rarr; Claude extraction</td>
            <td>Free &amp; cheap NYC events</td>
          </tr>
          <tr>
            <td class="source-name">Nonsense NYC</td>
            <td class="weight-high">0.9</td>
            <td>Gmail newsletter &rarr; Claude</td>
            <td>Underground, weird, one-of-a-kind</td>
          </tr>
          <tr>
            <td class="source-name">Resident Advisor</td>
            <td class="weight-high">0.85</td>
            <td>GraphQL API</td>
            <td>Electronic music &amp; club nights</td>
          </tr>
          <tr>
            <td class="source-name">Oh My Rockness</td>
            <td class="weight-high">0.85</td>
            <td>HTML &rarr; Claude extraction</td>
            <td>Indie &amp; live music</td>
          </tr>
          <tr>
            <td class="source-name">Dice</td>
            <td class="weight-mid">0.8</td>
            <td>__NEXT_DATA__ JSON</td>
            <td>Music &amp; nightlife</td>
          </tr>
          <tr>
            <td class="source-name">BrooklynVegan</td>
            <td class="weight-mid">0.8</td>
            <td>DoStuff JSON feed</td>
            <td>Indie shows, punk, rock</td>
          </tr>
          <tr>
            <td class="source-name">BAM</td>
            <td class="weight-mid">0.8</td>
            <td>JSON API</td>
            <td>Film, theater, music, dance</td>
          </tr>
          <tr>
            <td class="source-name">SmallsLIVE</td>
            <td class="weight-mid">0.8</td>
            <td>AJAX HTML</td>
            <td>Jazz at Smalls + Mezzrow</td>
          </tr>
          <tr>
            <td class="source-name">Yutori</td>
            <td class="weight-mid">0.8</td>
            <td>Gmail API &rarr; Claude</td>
            <td>Agent briefings, curated picks</td>
          </tr>
          <tr>
            <td class="source-name">NYC Parks</td>
            <td class="weight-mid">0.75</td>
            <td>Schema.org markup</td>
            <td>Outdoor events, free programming</td>
          </tr>
          <tr>
            <td class="source-name">DoNYC</td>
            <td class="weight-mid">0.75</td>
            <td>Cheerio HTML scraping</td>
            <td>Music, comedy, theater</td>
          </tr>
          <tr>
            <td class="source-name">Songkick</td>
            <td class="weight-mid">0.75</td>
            <td>JSON-LD</td>
            <td>Concerts &amp; live music</td>
          </tr>
          <tr>
            <td class="source-name">Ticketmaster</td>
            <td class="weight-mid">0.75</td>
            <td>Discovery API</td>
            <td>Indie filter: venue blocklist + $100 cap</td>
          </tr>
          <tr>
            <td class="source-name">Eventbrite</td>
            <td class="weight-low">0.7</td>
            <td>JSON-LD + __SERVER_DATA__</td>
            <td>Community events, workshops</td>
          </tr>
          <tr>
            <td class="source-name">NYPL</td>
            <td class="weight-low">0.7</td>
            <td>Eventbrite organizer pages</td>
            <td>Free library events</td>
          </tr>
          <tr>
            <td class="source-name">Tavily</td>
            <td class="weight-low">0.6</td>
            <td>Web search</td>
            <td>Fallback only (not in hot path)</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- 6. Session & Conversation -->
<section id="sessions">
  <div class="container">
    <p class="section-label">Sessions</p>
    <h2 class="section-title">Multi-turn conversation state</h2>
    <div class="section-body">
      <p>Each phone number gets a session that persists for <strong>2 hours</strong>. The session tracks what the user has been shown, what filters they've applied, and what neighborhoods they've visited. This lets follow-up messages like "how about comedy" or "later tonight" modify the active context rather than starting over.</p>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Field</th>
            <th>Type</th>
            <th>Purpose</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="source-name">lastPicks</td>
            <td>array</td>
            <td>Most recent picks returned by compose</td>
          </tr>
          <tr>
            <td class="source-name">lastEvents</td>
            <td>object</td>
            <td>Map of event objects offered in the last batch (for details lookup)</td>
          </tr>
          <tr>
            <td class="source-name">lastNeighborhood</td>
            <td>string</td>
            <td>Neighborhood from the last events response</td>
          </tr>
          <tr>
            <td class="source-name">lastFilters</td>
            <td>object</td>
            <td>Active filters: category, vibe, time_after, free_only</td>
          </tr>
          <tr>
            <td class="source-name">conversationHistory</td>
            <td>array</td>
            <td>Last 6 turns (300 chars each) &mdash; sent to router and compose</td>
          </tr>
          <tr>
            <td class="source-name">allPicks</td>
            <td>array</td>
            <td>Cumulative picks across all "more" batches</td>
          </tr>
          <tr>
            <td class="source-name">allOfferedIds</td>
            <td>array</td>
            <td>All event IDs ever shown &mdash; excluded on "more" to avoid repeats</td>
          </tr>
          <tr>
            <td class="source-name">visitedHoods</td>
            <td>array</td>
            <td>Neighborhoods visited this session (dedup travel nudges)</td>
          </tr>
          <tr>
            <td class="source-name">pendingNearby</td>
            <td>string</td>
            <td>Neighborhood stored during a travel nudge ("would you travel to X?")</td>
          </tr>
          <tr>
            <td class="source-name">pendingNearbyEvents</td>
            <td>object</td>
            <td>Pre-loaded events for the nudge neighborhood</td>
          </tr>
          <tr>
            <td class="source-name">pendingFilters</td>
            <td>object</td>
            <td>Saved filters when asking user for a neighborhood</td>
          </tr>
          <tr>
            <td class="source-name">pendingMessage</td>
            <td>string</td>
            <td>Original message stored with pending filters</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- 7. Prompt Architecture -->
<section id="prompts">
  <div class="container">
    <p class="section-label">Prompts</p>
    <h2 class="section-title">Unified prompt + composable skills</h2>
    <div class="section-body">
      <p>The unified LLM call uses a base system prompt (<code>UNIFIED_SYSTEM</code>) that handles intent understanding, event selection, and SMS composition. On top of this, <strong>12 conditional skill modules</strong> are appended based on request context. The user prompt includes the tagged event pool with <code>[MATCH]</code> tags, filter context (<code>ACTIVE_FILTER</code>, <code>MATCH_COUNT</code>, <code>SPARSE</code>), and conversation history.</p>
      <p><strong>Why conditional skills?</strong> When Claude sees "ACTIVITY ADHERENCE: if none match, say honestly you don't have that tonight" on a request where the user didn't ask for an activity, it sometimes over-filters and returns fewer picks. Including "NEIGHBORHOOD MISMATCH: acknowledge this upfront" when events ARE in the right neighborhood caused Claude to add unnecessary disclaimers. Each skill solves a specific failure mode, and only fires when that failure mode is possible.</p>
    </div>

    <details open style="margin-top: 24px;">
      <summary style="color: var(--coral);">core <span class="skill-condition">&mdash; always on. Persona, format, 480-char limit.</span></summary>
      <div class="detail-body">
        <p>Defines who Claude is and how to write. This is the only skill that's always included.</p>
        <div class="code-block" style="font-size: 0.76rem; line-height: 1.6; white-space: pre-wrap;">You are Pulse: an NYC "plugged-in friend" who curates the best upcoming events. You text like a real person — warm, opinionated, concise. Never robotic.

PICK PRIORITY ORDER:
1. Tonight first: if an event's day is "TODAY", prefer it over tomorrow events.
2. Source tier: among tonight options, prefer unstructured and primary over secondary.
3. Neighborhood match: strongly prefer events in the user's requested neighborhood.
4. Curation taste: prefer gallery openings, DJ nights at small venues, indie concerts, comedy shows, themed pop-ups, and unique one-off events. Avoid corporate events, hotel bars, tourist traps, and chain venues.

VOICE: you're a friend texting picks. Light NYC shorthand OK.
Each numbered pick should feel opinionated — "always a vibe", "goes off late", "legendary basement spot".
CHARACTER LIMIT: 480 characters total for sms_text.</div>
      </div>
    </details>

    <details>
      <summary>sourceTiers <span class="skill-condition">&mdash; always on. Editorial trust hierarchy.</span></summary>
      <div class="detail-body">
        <p><strong>Problem it solves:</strong> Without this, Claude treats all events equally. An Eventbrite "networking mixer" looks the same as a Nonsense NYC underground art party. This skill teaches Claude our editorial hierarchy.</p>
        <div class="code-block" style="font-size: 0.76rem; line-height: 1.6; white-space: pre-wrap;">SOURCE TIERS — use source_tier to break ties between similar events:
- "unstructured" (Skint, Nonsense NYC, Oh My Rockness, Yutori): curated editorial picks — trust these, they've been hand-selected.
- "primary" (RA, Dice, BrooklynVegan, BAM, SmallsLIVE): structured high-quality listings.
- "secondary" (NYC Parks, DoNYC, Songkick, Ticketmaster, Eventbrite, NYPL, Tavily): broader aggregators.</div>
      </div>
    </details>

    <details>
      <summary>tonightPriority <span class="skill-condition">&mdash; when today events exist in batch</span></summary>
      <div class="detail-body">
        <p><strong>Problem it solves:</strong> Claude naturally prefers the "best" event regardless of date. A great concert tomorrow looks better than a decent DJ set tonight. But the user texted now &mdash; they probably want something tonight.</p>
        <div class="code-block" style="font-size: 0.76rem; line-height: 1.6; white-space: pre-wrap;">TONIGHT PRIORITY: A decent tonight event beats a great tomorrow event — the user is asking what's happening now.</div>
      </div>
    </details>

    <details>
      <summary>neighborhoodMismatch <span class="skill-condition">&mdash; when NO events match the requested hood</span></summary>
      <div class="detail-body">
        <p><strong>Problem it solves:</strong> When the user asks for the Upper West Side but all events are in Hell's Kitchen, Claude would silently show the Hell's Kitchen events. The user assumes they're in UWS. This skill forces Claude to acknowledge the mismatch upfront.</p>
        <div class="code-block" style="font-size: 0.76rem; line-height: 1.6; white-space: pre-wrap;">NEIGHBORHOOD MISMATCH: NONE of the events are in the requested neighborhood. You MUST acknowledge this upfront — e.g. "Not much tonight on the UWS, but nearby in Hell's Kitchen:"</div>
      </div>
    </details>

    <details>
      <summary>perennialFraming <span class="skill-condition">&mdash; when batch includes perennial picks</span></summary>
      <div class="detail-body">
        <p><strong>Problem it solves:</strong> Perennials are always-good venues (bars with trivia, jazz clubs). Without framing, Claude writes "Black Rabbit is a solid bar" instead of "Black Rabbit has great trivia tonight at 8." It also needs to know when to lean on perennials (thin scrape nights) vs. skip them (plenty of events).</p>
        <div class="code-block" style="font-size: 0.76rem; line-height: 1.6; white-space: pre-wrap;">PERENNIAL PICKS: Items with source_name "perennial" are bars/venues always worth visiting.
- Lead with the activity: "Black Rabbit has great trivia tonight at 8" not "Black Rabbit is a solid bar."
- THIN EVENTS (1-3 scraped events): Lead with the event, then add a perennial.
- RICH EVENTS (4+ scraped events): Perennials are optional. Skip or mention one only if it has something specific and great happening.
- Frame as personal recs — "always a good time" — never "if nothing else works."</div>
      </div>
    </details>

    <details>
      <summary>activityAdherence <span class="skill-condition">&mdash; when user asks for trivia, karaoke, jazz, etc.</span></summary>
      <div class="detail-body">
        <p><strong>Problem it solves:</strong> When someone texts "trivia in fort greene" and there's no trivia, Claude would recommend random events as alternatives. This is misleading &mdash; the user specifically wants trivia. This skill tells Claude to be honest about the miss rather than silently substituting.</p>
        <div class="code-block" style="font-size: 0.76rem; line-height: 1.6; white-space: pre-wrap;">ACTIVITY ADHERENCE: The user asked for a specific type of activity. If NONE of the events match, do NOT recommend unrelated events. Instead, say honestly you don't have that tonight.
DAY-SPECIFIC CLAIMS: NEVER say an event happens on a particular day (e.g. "trivia on Thursdays") unless you can verify from the event data that today IS that day.</div>
      </div>
    </details>

    <details>
      <summary>conversationAwareness <span class="skill-condition">&mdash; when session has conversation history</span></summary>
      <div class="detail-body">
        <p><strong>Problem it solves:</strong> Two specific bugs: (1) User asks for "tomorrow" events but Claude defaults to tonight-first priority &mdash; this skill overrides that. (2) Claude recommends events it already showed in earlier turns. (Filter persistence is now handled deterministically by the handler via <code>mergeFilters()</code>, not the LLM.)</p>
        <div class="code-block" style="font-size: 0.76rem; line-height: 1.6; white-space: pre-wrap;">CONVERSATION AWARENESS:
- TEMPORAL INTENT: If user asks about "tomorrow", prefer TOMORROW events. Override the "tonight first" rule.
- REPEAT AVOIDANCE: Do not recommend events already mentioned in conversation history.</div>
      </div>
    </details>

    <details>
      <summary style="color: var(--text-dim);">5 more conditional skills <span class="skill-condition">&mdash; lastBatch, freeEmphasis, pendingIntent, venueFraming, nearbySuggestion</span></summary>
      <div class="detail-body">
        <p><strong>lastBatch</strong> &mdash; Fires on the final "more" batch. Removes the "Reply MORE for extra picks" CTA since there are no more picks. Appends a nearby neighborhood suggestion.</p>
        <p><strong>freeEmphasis</strong> &mdash; Fires when user asked for free events. Tells Claude to list free events even if they seem niche &mdash; the user specifically wants free.</p>
        <p><strong>pendingIntent</strong> &mdash; Fires when restoring a deferred request. User said "free comedy" with no neighborhood, then sent "bushwick" &mdash; this skill passes the original request so Claude knows the full intent.</p>
        <p><strong>venueFraming</strong> &mdash; Fires when Tavily search results include permanent venues. Tells Claude to frame them as "solid spots to check out" rather than events with specific times.</p>
        <p><strong>nearbySuggestion</strong> &mdash; Fires when nearby neighborhoods are provided. Tells Claude to suggest travel when picks are thin: "Slim pickings in Fort Greene &mdash; Park Slope is right nearby, want picks from there?"</p>
      </div>
    </details>
  </div>
</section>

<!-- 8. Quality & Eval -->
<section id="eval">
  <div class="container">
    <p class="section-label">Quality</p>
    <h2 class="section-title">5-layer eval system</h2>
    <div class="section-body">
      <p>Quality is measured offline against stored request traces. The eval system runs in layers, from fast deterministic checks to expensive LLM judges. Each layer catches different failure modes.</p>
    </div>

    <ul class="layer-list">
      <li>
        <span class="layer-num">1</span>
        <span><strong>Unit tests</strong> &mdash; Pure function tests (formatters, geo, neighborhoods). Fast, no API calls. Run on every push.</span>
      </li>
      <li>
        <span class="layer-num">2</span>
        <span><strong>Code evals</strong> &mdash; 9 deterministic trace checks: 480-char limit, valid intent, valid neighborhood, picked events exist, no truncated URLs. Free and instant. (<code>evals/code-evals.js</code>)</span>
      </li>
      <li>
        <span class="layer-num">3</span>
        <span><strong>Extraction audit</strong> &mdash; Tier 1: verify Claude-extracted evidence quotes appear verbatim in source text. Tier 2: optional LLM judge for semantic accuracy. (<code>evals/extraction-audit.js</code>)</span>
      </li>
      <li>
        <span class="layer-num">4</span>
        <span><strong>Pipeline evals</strong> &mdash; Multi-turn scenario tests with expected outcomes. Trace assertions check intent, neighborhood, event presence, and banned phrases. (<code>scripts/run-scenario-evals.js</code>)</span>
      </li>
      <li>
        <span class="layer-num">5</span>
        <span><strong>LLM judges + A/B</strong> &mdash; Tone judge ("sounds like a friend, not a bot?"), relevance judge, and model-vs-model preference tests. Expensive, run on demand. (<code>evals/judge-evals.js</code>, <code>scripts/run-ab-eval.js</code>)</span>
      </li>
    </ul>

    <div class="code-block"><span class="hl-dim"># Run the eval layers</span>
$ npm run eval              <span class="hl-dim"># Layer 2: code evals on stored traces</span>
$ npm run eval:judges       <span class="hl-dim"># Layers 2+5: code evals + LLM judges</span>
$ node scripts/run-scenario-evals.js   <span class="hl-dim"># Layer 4: multi-turn scenarios</span>
$ node scripts/run-ab-eval.js          <span class="hl-dim"># Layer 5: A/B comparison</span></div>
  </div>
</section>

<!-- 9. Observability -->
<section id="observability">
  <div class="container">
    <p class="section-label">Observability</p>
    <h2 class="section-title">Traces, alerts, dashboards</h2>
    <div class="section-body">
      <p>Every request writes a structured trace. Health monitoring catches scrape failures and slow responses. Three dashboards provide real-time visibility.</p>
    </div>

    <div class="card-grid">
      <div class="card">
        <h3>Request traces</h3>
        <p>Per-request JSONL records capture intent, neighborhood, picked events, AI costs, timing, and the full SMS response. Daily rotation with 4-file max. A 200-entry ring buffer powers the eval UI.</p>
      </div>
      <div class="card">
        <h3>Email alerts</h3>
        <p>Health alerts fire on scrape failures (6hr cooldown). Runtime alerts fire on slow responses or errors (30min per-type cooldown). Sent via Resend. No-op if API key is unset.</p>
      </div>
      <div class="card">
        <h3>Health dashboard</h3>
        <p>Per-source timing, success/failure status, history sparklines, extraction quality metrics. Available at <code>/health</code>.</p>
      </div>
      <div class="card">
        <h3>Cost tracking</h3>
        <p>Per-user daily budget of $0.10. Provider-aware pricing (Haiku vs Gemini). Budget resets daily on NYC timezone. Friendly message when exceeded.</p>
      </div>
    </div>
  </div>
</section>

<footer>
  <div class="footer-inner">
    <span class="footer-brand">Pulse</span>
    <span class="footer-note">Built in Brooklyn</span>
  </div>
</footer>

</body>
</html>
